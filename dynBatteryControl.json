{
  "id": "batteryusageoptimization",
  "type": "subflow",
  "name": "batteryusageoptimization",
  "info": "<h1>Optimierung der Verwendung des Hausspeichers im Zusammenspiel von ioBroker, evcc und einem dynamischen Stromtarif</h1><h2>Bezeichnungen für die Ausgabekan&auml;le</h2><ul><li>1. Minimum-SoC</li><li>2. Batteriemodus</li><li>3. Netzladungspreis</li><li>4. eff.Eigenstrompreis</li><li>5. dyn.Regelungsgrenze</li><li>6. Nachrichtentext</li><li>7. letzter Netzladungspreis</li><li>8. letzte Netzladungskosten (@5kWh)</li><li>9. letzte Netzladungsmenge (@5kWh)</li><li>10. heutige Preisdifferenz</li><li>11. heutige Preiabweichung</li><li>12. erlaube Netzladung</li><li>13. erlaube Batteriesteuerung</li><li>14. verbleibender Solarertrag</li><li>15. verbleibender Strombedarf</li></ul><h2>Funktionsweise:</h2><p>Der Batteriespeicher soll bei überschüssigem PV-Strom geladen, aber nicht in Zeiten günstigen Netzstromes entladen werden. Ist die Preisdifferenz ausreichend hoch (>15ct) wird eine Netzladung zum günstigsten Zeitpunkt des Tages erwogen und die Batterie bis zum Füllstand von 80% geladen. Um die Batterie nicht ungünstig zu entladen, wird der Netzladungspreis bei der weiteren Steuerung der Batteriesperre berücksichtigt, und die Freigabe der Batterie erfolgt nur bei einem Netzstrompreis, der ausreichend über dem Netzladungspreis liegt (~130%). Die Batterie wird außerdem nur geladen, wenn Stand des Batteriespeichers ausreichend gering (<30%) ist, auch um ein Pendeln von Laden/Entladen zu vermeiden.</p><p>Die optimierte Batteriesteuerung ist nur aktiv, wenn die PV Erzeugungsleistung des aktuellen Tages geringer als der Tagesstrombedarf ist (PVgesamt prognostiziert < 17.5kWh). Eine Standardlastverteilung des Bedarfs, für einen 4 Personen-Haushalt (24h, berufstätig mit Schulkindern) und einem Stromverbrauch von etwa 15kWh / Tag ist vordefiniert. Der Strombedarf wird dabei grundsätzlich vom aktuellen Zeitpunkt bis zum nächsten Morgen (6 Uhr) bestimmt und berücksichtigt dabei den stündlichen Strombedarf der Lastverteilung.</p><p>Im Verlauf des Tages wird der noch zu erwartende PV-Ertrag bei der Steuerung berücksichtigt. Bei Verfügbarkeit des Strompreises für den kommenden Tag, sowie der entsprechenden PV-Prognose wird dies ebenfalls berücksichtgt.<p>Die Alias-Definitionen sind eingespielt (json), mit lokalen Datenwerten verknüpft und im Node erreichbar.</p><p>Es wird vorausgesetzt:</p><ul><li>aktuelle Verbrauchswerte</li><li>aktuelle und zukünftige Preisinformationen</li><li>der durchschnittliche Strompreis der letzten Woche (zur Optimierung) ermittelbar z.B. per Abfrage (AVG, group by week) aus den Werten der InfluxDB in IOBroker (ansonsten statisch vorzugeben, z.B. 0.24 Euro)</li><li>tagesaktuelle PV Prognosedaten des Gesamtertrages inkl. der Verteilung des Ertrags über den Tag</li><li>Leistungsdaten der Batterie, zur Regelung:</li><ul><li>Batteriestand (soc)</li><li>minimaler Batteriestand (minsoc)</li><li>Batterieleistungswerte (Laderegelung, intern zur Prüfung!)</li></ul></ul><p>In der Node-Konfiguration ist ebenfalls eine Grundeinstellung enthalten:</p><ul><li>Tagesverbrauch ~15kWh, Standardlastkurve</li><li>weitere Konfigurationseinstellungen, wie z.B. maximaler Ladepreis, etc.</li></ul><p>Der Knoten sollte instantiiert werden, um dann die Werte der Ausgabekanäle weiter zu verarbeiten. So wird der aktuell empfohlene Zustand für die Batteriekontrolle (normal, hold, charge) dynamisch berechnet und im ersten Ausgang ein empfohlener Wert für den minimalen Ladestand ausgegeben. Dieser ist entweder minimal, oder maximal; d.h. er legt die Grundlage für eine Batteriesperre mit anderen Mitteln, z.B. per modbus-Kontrolle.</p><p>Die evcc-Zustände haben dabei Vorrang, d.h. es wird nur im evcc-Batteriemodus unknown/normal/charge gesteuert. Gibt evcc den Modus für die Batteriesperre (hold) vor, überschreibt dieser den berechneten Mechanismus. Es wird davon ausgegangen, dass die Netzladung per evcc-Instanz unter Konfiguration des aktuellen Strompreises gestartet werden kann.</p><p>An einem anderen Ausgang wird der Strompreis (in Euro) als Grenzwert für die Netzladung zur Weitergabe als 'GridChargeLimit' an evcc ausgegeben, dies kann z.B. per HTTP- oder MQTT-API erfolgen.</p><p>Die anderen Ausgänge sind für eine mögliche Visualisierung oder Statistik sowie für weitergehende Integrationen gedacht und enthalten ergänzende Informationen.</p><p>Ohne aktivierte Batteriesteuerung und dynamischem Stromtarif ist eine Steuerung nicht möglich.</p><h2>detaillierte Beschreibung der Alias-Definitionen:</h2><table><thead><tr><th>Alias</th><th>Beschreibung</th><th>Zugriff</th><th>Typ</th></tr></thead><tbody><tr><td>energy.control.effectiveGridChargeCostLimit</td><td>aktuelle Regelgrenze für die Batteriesperre</td><td>schreibend</td><td>float</td></tr><tr><td>energy.control.enableGridcharging</td><td>erlaube die Netzladung der Batterie</td><td>schreibend</td><td>bool</td></tr><tr><td>energy.control.enableOptimization</td><td>erlaube die Steuerung der Hausbatterie</td><td>schreibend</td><td>bool</td></tr><tr><td>energy.control.lastGridChargePrice</td><td>letzter Preis für die Netzladung der Hausbatterie</td><td>schreibend</td><td>float</td></tr><tr><td></td><td></td></tr><tr><td>energy.battery.targetMode</td><td>bestimmter Batteriemodus (unknown/normal/hold/charge)</td><td>schreibend</td><td>string</td></tr><tr><td></td><td></td></tr><tr><td>energy.control.batterylock</td><td>erzwungene Batteriesperre z.B. per UI</td><td>lesend</td><td>bool</td></tr><tr><td>energy.control.gridChargeCostLimit</td><td>regelbare Preisgrenze für die Netzladung (bis 0.35€)</td><td>lesend</td><td>float</td></tr><tr><td></td><td></td></tr><tr><td>energy.battery.chargePower</td><td>aktuelle Batterieleistung</td><td>lesend</td><td>int</td></tr><tr><td>energy.battery.minsoc</td><td>aktueller minSoC der Batterie</td><td>lesend</td><td>int</td></tr><tr><td>energy.battery.soc</td><td>aktueller SoC der Batterie</td><td>lesend</td><td>int</td></tr><tr><td></td><td></td></tr><tr><td>energy.grid.consumption</td><td>aktueller Strombedarf (Zählerwert in Watt)</td><td>lesend</td><td>int</td></tr><tr><td>energy.grid.price</td><td>Strompreis (jetzt)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.prive_avg_weekly</td><td>durchschnittlicher Strompreis (historisch, 1 Woche)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_max</td><td>maximaler Strompreis (bekannt)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_min</td><td>minimaler Strompreis (bekannt)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_today</td><td>durchschnittlicher Strompreis (heute)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_tomorrow</td><td>durchschnittlicher Strompreis (morgen)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.pricelevel</td><td>aktuelles Preislevel (heute) (VERY CHEAP / CHEAP / NORMAL / EXPENSIVE / VERY EXPENSIVE)</td><td>lesend</td><td>string</td></tr><tr><td>energy.grid.pricelevel_min</td><td>günstigstes Preislevel (heute) (VERY CHEAP / CHEAP / NORMAL / EXPENSIVE / VERY EXPENSIVE)</td><td>lesend</td><td>string</td></tr><tr><td></td><td></td></tr><tr><td>energy.evcc.batteryDischargeControl</td><td>Konfigurationseinstellung (evcc) der Batteriesteuerung</td><td>lesend</td><td>bool</td></tr><tr><td>energy.evcc.tariffPriceHome</td><td>aktuell kalkulierter Preis (evcc) für den Hausverbrauch</td><td>lesend</td><td>float</td></tr><tr><td></td><td></td></tr><tr><td>energy.pv.forecast_today</td><td>prog. Solarstromertrag (heute)</td><td>lesend</td><td>float</td></tr><tr><td>energy.pv.price_feedin</td><td>Einspeisevergütung (fix)</td><td>lesend</td><td>float</td></tr><tr><td>energy.pv.production</td><td>aktuelle Stromerzeugung (in Watt)</td><td>lesend</td><td>int</td></tr><tr><td>energy.pv.pvforecast_summary_JSONData</td><td>gelieferter Datensatz der Solarprognose (solcast-Format?)</td><td>lesend</td><td>json</td></tr></tbody></table></p><h2>Vorschlag zur Preisermittlung:</h2><p>Mit Hilfe eines InfluxDB Node und folgender Abfrage an die InfluxDB kann ein Veränderungen erfassender Datenwert als Grundlage herangezogen werden:</p><p><strong>SQL:</strong> <code>select mean(*) from \"tibberlink.x.xxx-yyy-zzz.CurrentPrice.total\" where time>(now() - 7d) group by time(7d) fill(none)</code></p><p>Der eigentliche Wert erhält man dann z.B. mit folgender Bearbeitung und speichert ihn z.B. in einem eigenen Datenwert dauerhaft ab:</p><h2>Beispielintegration:</h2><p>Der aufwändige Aufbau für die Steuerung der Batteriesperr(schreiben 1042 ff.) ist in diesem Beispiel nötig, um nicht konkurrierend zur evcc-Instanz mit dem modbus-Proxy zu steuern und ermöglicht eine Verallgemeinerung der Logik. Außerdem wird sichergestellt, dass die Steuerung im richtigen Kontext erfolgt und Rücksicht auf eventuelle vorherige Zustände von evcc nimmt.</p><p>Dieses Beispiel nutzt abweichend zu evcc das Register für den minimalen Ladestand der Batterie (1042), um eine PV-Ladung von überschüssigem Strom bei Batteriesperre zu ermöglichen. Da nicht zwingend ein Ladepunkt aktiv ist, der die PV Leistung abnimmt, ist dies hier von Vorteil für die optimale Verwendung des erzeugten Solarstromes.</p><p>Alternativ könnte mit den Ausgaben z.B. eine Steuerung über einen Ladepunkt (<a href=\"https://github.com/evcc-io/evcc/wiki/aaa-Lifehacks#entladung-eines-steuerbaren-hausspeicher-preisgesteuert-oder-manuell-sperren\" target=\"_blank\">Workaround</a>) oder eventuell zukünftig(!) mit Hilfe eines Parameters für eine externe Steuerung in evcc realisiert werden.</p>",
  "category": "",
  "outputLabels": [
            "Minimum-SoC",
            "Batteriemodus",
            "Netzladungspreis",
            "eff.Eigenstrompreis",
            "dyn.Regelungsgrenze",
            "Nachrichtentext",
            "letzter Netzladungspreis",
            "letzte Netzladungskosten (@5kWh)",
            "letzte Netzladungsmenge (@5kWh)",
            "heutige Preisdifferenz",
            "heutige Preiabweichung",
            "erlaube Netzladung",
            "erlaube Batteriesteuerung",
            "verbleibender Solarertrag",
            "verbleibender Strombedarf"
  ],
  "in": [],
  
        "out": [
            {
                "x": 3000,
                "y": 200,
                "wires": [
                    {
                        "id": "17dcde62c5b26356",
                        "port": 0
                    }
                ]
            },
            {
                "x": 2500,
                "y": 820,
                "wires": [
                    {
                        "id": "684559ba59abec7d",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3860,
                "y": 350,
                "wires": [
                    {
                        "id": "ed1942f7fbabdbff",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3860,
                "y": 450,
                "wires": [
                    {
                        "id": "984f0db091e7927a",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3090,
                "y": 730,
                "wires": [
                    {
                        "id": "39f389aa935f4f94",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3850,
                "y": 630,
                "wires": [
                    {
                        "id": "76d7c529a1e90486",
                        "port": 0
                    }
                ]
            },
            {
                "x": 4360,
                "y": 1410,
                "wires": [
                    {
                        "id": "5dcf896cd4f97574",
                        "port": 0
                    },
                    {
                        "id": "53efad8ea2cf4469",
                        "port": 0
                    }
                ]
            },
            {
                "x": 4170,
                "y": 1490,
                "wires": [
                    {
                        "id": "f40cecb354f57064",
                        "port": 0
                    }
                ]
            },
            {
                "x": 4170,
                "y": 1550,
                "wires": [
                    {
                        "id": "a8e8556473eb2c17",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1810,
                "y": 1530,
                "wires": [
                    {
                        "id": "107f28267edba49c",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1820,
                "y": 1630,
                "wires": [
                    {
                        "id": "6b63025041307fc1",
                        "port": 0
                    }
                ]
            },
            {
                "x": 2950,
                "y": 1470,
                "wires": [
                    {
                        "id": "c97002647b5966d0",
                        "port": 0
                    }
                ]
            },
            {
                "x": 2850,
                "y": 1720,
                "wires": [
                    {
                        "id": "d1d8dcc7f2480dcb",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1850,
                "y": 1820,
                "wires": [
                    {
                        "id": "7d86b66b5df8dda7",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1570,
                "y": 2010,
                "wires": [
                    {
                        "id": "f6ba7bd41972dd4a",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "module": "node-red-contrib-batteryusageoptimization",
            "type": "batteryusageoptimization",
            "version": "1.0.4",
            "author": "Ingo Seeberg-Hinrichs",
            "desc": "optimizing home battery storage usage",
            "keywords": "home battery, battery storage optimization",
            "license": "MIT"
        },
        "color": "#DDAA99",
        "outputLabels": [
            "Minimum-SoC",
            "Batteriemodus",
            "Netzladungspreis",
            "eff.Eigenstrompreis",
            "dyn.Regelungsgrenze",
            "Nachrichtentext",
            "letzter Netzladungspreis",
            "letzte Netzladungskosten (@5kWh)",
            "letzte Netzladungsmenge (@5kWh)",
            "heutige Preisdifferenz",
            "heutige Preiabweichung",
            "erlaube Netzladung",
            "erlaube Batteriesteuerung",
            "verbleibender Solarertrag",
            "verbleibender Strombedarf"
        ],
        "status": {
            "x": 2480,
            "y": 750,
            "wires": [
                {
                    "id": "684559ba59abec7d",
                    "port": 0
                }
            ]
        },

  "flow": [
    {
        "id": "5a8c9511ed56cd1a",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis (Änderung)",
        "attrname": "price",
        "topic": "alias.0.energy.grid.price",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 270,
        "y": 1150,
        "wires": [
            [
                "b2dba7f59fc00347"
            ]
        ]
    },
    {
        "id": "58ea42236428d159",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Netzladungspreis",
        "topic": "0_userdata.0.Custom.Netzladungspreis",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 4370,
        "y": 1240,
        "wires": []
    },
    {
        "id": "942aed01c01bfd01",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "lastGridChargePrice",
        "topic": "alias.0.energy.control.lastGridChargePrice",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 4350,
        "y": 1340,
        "wires": []
    },
    {
        "id": "8e7b7a10edb760ea",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Statistics [optional]",
        "info": "",
        "x": 4370,
        "y": 1210,
        "wires": []
    },
    {
        "id": "8d57d13a7c85ce47",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "automatische Netzladung // Laderegelung",
        "info": "",
        "x": 370,
        "y": 70,
        "wires": []
    },
    {
        "id": "b0a535f7c1e8e1de",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 840,
        "y": 320,
        "wires": [
            [
                "cbbd8575f3d69c8f"
            ]
        ]
    },
    {
        "id": "cc9541e476fe1a11",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "Konfiguration",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "30 13 * * *",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 270,
        "y": 560,
        "wires": [
            [
                "e8f62258c9ea12bf",
                "b4a130b2a1178d1a",
                "01872efd838041e0",
                "0fbeb0872ef9a4e7"
            ]
        ]
    },
    {
        "id": "e8f62258c9ea12bf",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "erlaube Netzladung",
        "topic": "alias.0.energy.control.enableGridcharging",
        "attrname": "payload",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 640,
        "y": 280,
        "wires": [
            [
                "b0a535f7c1e8e1de"
            ]
        ]
    },
    {
        "id": "e2f98046b18f06ab",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "erlaube Netzladung",
        "attrname": "payload",
        "topic": "alias.0.energy.control.enableGridcharging",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 640,
        "y": 330,
        "wires": [
            [
                "b0a535f7c1e8e1de"
            ]
        ]
    },
    {
        "id": "cbbd8575f3d69c8f",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "enableGridcharge",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1000,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "1af8718e9bd90c29",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryGridChargeLimit",
                "pt": "flow",
                "to": "$round((msg.feedin/100*80),3)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "batteryGridChargeLimitLow",
                "pt": "msg",
                "to": "batteryGridChargeLimit",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "lastBatteryGridChargeLimit",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "_batteryGridChargeLimit",
                "pt": "flow",
                "to": "batteryGridChargeLimitLow",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "batteryControlLimit",
                "pt": "flow",
                "to": "(feedin*1.2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "batteryDischargeControl",
                "pt": "flow",
                "to": "batteryDischargeControl",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "today",
                "pt": "flow",
                "to": "today",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 720,
        "wires": [
            [
                "1c2402d626f61b4c"
            ]
        ]
    },
    {
        "id": "edc0368fa681ebcc",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "morgiger Strompreis bekannt",
        "property": "tomorrow",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1510,
        "y": 800,
        "wires": [
            [
                "94def2808b532d4b"
            ],
            [
                "9cedfb163289c148"
            ]
        ]
    },
    {
        "id": "1c2402d626f61b4c",
        "type": "special-date",
        "z": "batteryoptimization",
        "dates": [
            {
                "type": "range",
                "startDate": 1,
                "startDay": 0,
                "startMonth": 9,
                "startMonthOrdinal": 0,
                "startOrdinal": 0,
                "endDate": 15,
                "endMonth": 2,
                "offsetOrdinalBefore": 0,
                "offsetOrdinalAfter": 0,
                "response": "true"
            }
        ],
        "defaultResponse": "false",
        "messageProperty": "within",
        "name": "Wintermonate (Okt-Mar)",
        "x": 1680,
        "y": 720,
        "wires": [
            [
                "81d17703242e186d"
            ]
        ]
    },
    {
        "id": "81d17703242e186d",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "within",
        "action": "obj",
        "pretty": false,
        "x": 1860,
        "y": 720,
        "wires": [
            [
                "7f0335c79bd188e9"
            ]
        ]
    },
    {
        "id": "49cb9d73315bc9fe",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "tomorrow",
                "pt": "flow",
                "to": "tomorrow",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2000,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "7f0335c79bd188e9",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Winter?",
        "property": "within",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2000,
        "y": 720,
        "wires": [
            [
                "adb1c077ebbae790"
            ],
            [
                "39f389aa935f4f94"
            ]
        ]
    },
    {
        "id": "adb1c077ebbae790",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzpreisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "attrname": "preisgrenze",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2170,
        "y": 660,
        "wires": [
            [
                "055fcceeaa53a968"
            ]
        ]
    },
    {
        "id": "055fcceeaa53a968",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "preisgrenze",
        "action": "",
        "pretty": false,
        "x": 2320,
        "y": 660,
        "wires": [
            [
                "650c34eee9564cf9"
            ]
        ]
    },
    {
        "id": "650c34eee9564cf9",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Mindeststrompreis für die Regelung (Winter) auswerten",
        "rules": [
            {
                "t": "set",
                "p": "gridchargecosts",
                "pt": "msg",
                "to": "lastGridChargeCost",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "tomorrow",
                "pt": "msg",
                "to": "tomorrow",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "batteryControlLimit",
                "pt": "flow",
                "to": "$max([$min([preisgrenze,today]),$min([preisgrenze,tomorrow]),gridchargecosts])",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2590,
        "y": 660,
        "wires": [
            [
                "39f389aa935f4f94"
            ]
        ]
    },
    {
        "id": "3aca59fb44ff3927",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Preislevel",
        "topic": "alias.0.energy.grid.pricelevel",
        "attrname": "pricelevel",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 940,
        "y": 1150,
        "wires": [
            [
                "59bf35ccca403115"
            ]
        ]
    },
    {
        "id": "b4a130b2a1178d1a",
        "type": "trigger",
        "z": "batteryoptimization",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "2",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 610,
        "y": 570,
        "wires": [
            [
                "a6a158b059c319d3"
            ]
        ]
    },
    {
        "id": "94def2808b532d4b",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "morgiger Strompreis gültig",
        "property": "tomorrow",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1790,
        "y": 780,
        "wires": [
            [
                "49cb9d73315bc9fe",
                "5ead875f06748af7"
            ]
        ]
    },
    {
        "id": "01872efd838041e0",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 600,
        "y": 220,
        "wires": [
            [
                "55e8d0bab2cd364d"
            ]
        ]
    },
    {
        "id": "55e8d0bab2cd364d",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzpreisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "attrname": "preisgrenze",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 770,
        "y": 220,
        "wires": [
            [
                "180af5876d93688b"
            ]
        ]
    },
    {
        "id": "180af5876d93688b",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "preisgrenze",
        "action": "",
        "pretty": false,
        "x": 930,
        "y": 220,
        "wires": [
            [
                "6ffa1b5a71bcb398"
            ]
        ]
    },
    {
        "id": "6ffa1b5a71bcb398",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "tomorrow",
                "pt": "flow",
                "to": "preisgrenze",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1090,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "0fbeb0872ef9a4e7",
        "type": "trigger",
        "z": "batteryoptimization",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "1",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 810,
        "y": 570,
        "wires": [
            [
                "bed11df2f7a7830e"
            ]
        ]
    },
    {
        "id": "4d65f7e9a1ef4e22",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "Initialisieren",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "f0f3fd02fe0bb794",
                "1198f5691bf5f5ed"
            ]
        ]
    },
    {
        "id": "ea9c208afd93bded",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "batteryMode",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "lastGridChargeCost",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastmessage",
                "pt": "flow",
                "to": "none",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "avgGridPriceWeekly",
                "pt": "flow",
                "to": "0.240",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1080,
        "y": 120,
        "wires": [
            [
                "d20645e44a50d52a"
            ]
        ]
    },
    {
        "id": "f0f3fd02fe0bb794",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "topic": "alias.0.energy.battery.targetMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "2d9d47668870c4db"
            ]
        ]
    },
    {
        "id": "046aa8f3f26ebfb7",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Ladereglung aktiv?",
        "property": "regelung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1370,
        "y": 330,
        "wires": [
            [
                "15a773d7d7db2bec"
            ],
            [
                "d6bef6a818dfb8c1"
            ]
        ]
    },
    {
        "id": "a32c239a1281ccd4",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "Watchdog",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "20",
        "crontab": "",
        "once": true,
        "onceDelay": "20",
        "topic": "Watchdog",
        "x": 260,
        "y": 390,
        "wires": [
            [
                "34f2d82fc5706f00"
            ]
        ]
    },
    {
        "id": "15a773d7d7db2bec",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "hold",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "normal",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1590,
        "y": 300,
        "wires": [
            [
                "d77efb49bd4306e3"
            ],
            [
                "8fb8d87c5c0466af"
            ],
            [
                "d6bef6a818dfb8c1"
            ],
            [
                "d6bef6a818dfb8c1"
            ]
        ]
    },
    {
        "id": "d6bef6a818dfb8c1",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Minimum SOC",
        "topic": "alias.0.energy.battery.minsoc",
        "attrname": "minsoc",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1630,
        "y": 380,
        "wires": [
            [
                "7c808aec982f7a77"
            ]
        ]
    },
    {
        "id": "d77efb49bd4306e3",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzladungsleistung (Batterie)",
        "topic": "alias.0.energy.battery.chargePower",
        "attrname": "chargePower",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1870,
        "y": 270,
        "wires": [
            [
                "3f5c2b5ceaabaa66"
            ]
        ]
    },
    {
        "id": "3f5c2b5ceaabaa66",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "chargePower",
        "action": "",
        "pretty": false,
        "x": 2070,
        "y": 270,
        "wires": [
            [
                "653f8a1e7dc07802"
            ]
        ]
    },
    {
        "id": "653f8a1e7dc07802",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung inaktiv",
        "property": "chargePower",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2280,
        "y": 270,
        "wires": [
            [
                "c13b3579bc1c6984"
            ],
            [
                "1a7d3a72899dddf9",
                "8bbaa52fcc6bbd48"
            ]
        ]
    },
    {
        "id": "1a7d3a72899dddf9",
        "type": "change",
        "z": "batteryoptimization",
        "name": "stoppen",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2510,
        "y": 230,
        "wires": [
            [
                "94e4b69dc3e75cbe",
                "8c5c919c5aeb182a",
                "60c271b7c9fdc3eb"
            ]
        ]
    },
    {
        "id": "c13b3579bc1c6984",
        "type": "change",
        "z": "batteryoptimization",
        "name": "sperren",
        "rules": [
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "hold",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2510,
        "y": 180,
        "wires": [
            [
                "8c5c919c5aeb182a",
                "17dcde62c5b26356"
            ]
        ]
    },
    {
        "id": "b6213f1789a2dadf",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "klein oder verschieden?",
        "property": "minsoc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "20",
                "vt": "num"
            },
            {
                "t": "neq",
                "v": "batteryMinSoC",
                "vt": "flow"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 2310,
        "y": 380,
        "wires": [
            [],
            [
                "85035fda3bc7a613"
            ]
        ]
    },
    {
        "id": "85035fda3bc7a613",
        "type": "change",
        "z": "batteryoptimization",
        "name": "reset",
        "rules": [
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "batteryMinSoC",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2520,
        "y": 380,
        "wires": [
            [
                "17dcde62c5b26356"
            ]
        ]
    },
    {
        "id": "8fb8d87c5c0466af",
        "type": "change",
        "z": "batteryoptimization",
        "name": "starten",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "-100",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2520,
        "y": 310,
        "wires": [
            [
                "8c5c919c5aeb182a",
                "f7e0bdd61b87ef8d"
            ]
        ]
    },
    {
        "id": "94e4b69dc3e75cbe",
        "type": "change",
        "z": "batteryoptimization",
        "name": "stoppen, speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "_batteryGridChargeLimit",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "lastBatteryGridChargeLimit",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "parts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2750,
        "y": 350,
        "wires": [
            [
                "7c38709e7f7d0bab",
                "ed1942f7fbabdbff"
            ]
        ]
    },
    {
        "id": "4f8fe3bee569a9c3",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "EVCC Steuerung aktiv?",
        "property": "batteryMode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "unknown",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "normal",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "hold",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 5,
        "x": 1140,
        "y": 390,
        "wires": [
            [
                "fb78d213d8a3f876"
            ],
            [
                "046aa8f3f26ebfb7"
            ],
            [
                "046aa8f3f26ebfb7"
            ],
            [
                "43d32d70e352c362"
            ],
            [
                "a3c05460a20ed8f4"
            ]
        ]
    },
    {
        "id": "a3c05460a20ed8f4",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "batteryMode",
        "statusType": "msg",
        "x": 1360,
        "y": 500,
        "wires": []
    },
    {
        "id": "8bbaa52fcc6bbd48",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Netzladung aktiv",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2740,
        "y": 280,
        "wires": []
    },
    {
        "id": "71d0c1bd5d24acaa",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 620,
        "y": 1100,
        "wires": [
            [
                "b2dba7f59fc00347"
            ]
        ]
    },
    {
        "id": "5b3545b00618092c",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung erlaubt?",
        "property": "enableGridcharge",
        "propertyType": "flow",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3360,
        "y": 390,
        "wires": [
            [
                "94e4b69dc3e75cbe"
            ],
            [
                "ed1942f7fbabdbff"
            ]
        ]
    },
    {
        "id": "fb78d213d8a3f876",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Ladereglung aktiv?",
        "property": "regelung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1370,
        "y": 200,
        "wires": [
            [
                "9407577bb0bab5da",
                "43d32d70e352c362"
            ],
            [
                "489b1dc5ef3034a7"
            ]
        ]
    },
    {
        "id": "489b1dc5ef3034a7",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "charge",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1600,
        "y": 230,
        "wires": [
            [
                "7b1f8ad23fe41e68"
            ],
            [
                "1a7d3a72899dddf9"
            ]
        ]
    },
    {
        "id": "8c5c919c5aeb182a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "targetMode",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2700,
        "y": 450,
        "wires": [
            [
                "1bb6ed4e2d5521ee",
                "19a8fe2be60538fc",
                "f1d7a7bb4e66f4ad"
            ]
        ]
    },
    {
        "id": "43d32d70e352c362",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ändern",
        "rules": [
            {
                "t": "move",
                "p": "batteryMode",
                "pt": "msg",
                "to": "targetMode",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1580,
        "y": 460,
        "wires": [
            [
                "8c5c919c5aeb182a"
            ]
        ]
    },
    {
        "id": "fa87a1fea7f433f7",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ändern",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2360,
        "y": 420,
        "wires": [
            [
                "8c5c919c5aeb182a"
            ]
        ]
    },
    {
        "id": "2ff392f940eb9220",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryLock",
                "pt": "flow",
                "to": "batteryLock",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 650,
        "y": 960,
        "wires": [
            [
                "3ee9135467715378"
            ]
        ]
    },
    {
        "id": "3ee9135467715378",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre?",
        "property": "batteryLock",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 840,
        "y": 960,
        "wires": [
            [
                "ce052e8de707ea72"
            ],
            [
                "d37ff2a816d2ee42"
            ]
        ]
    },
    {
        "id": "c8f26c11cc2b3a64",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Sperre setzen",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "hold",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 960,
        "wires": [
            [
                "cae7c9d47d0c73ea",
                "15a773d7d7db2bec"
            ]
        ]
    },
    {
        "id": "ce052e8de707ea72",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung?",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1050,
        "y": 930,
        "wires": [
            [],
            [
                "c8f26c11cc2b3a64"
            ]
        ]
    },
    {
        "id": "d37ff2a816d2ee42",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung?",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1050,
        "y": 1010,
        "wires": [
            [],
            [
                "9494a89701816a1e"
            ]
        ]
    },
    {
        "id": "9494a89701816a1e",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Sperre aufheben",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "normal",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "batteryMinSoC",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1250,
        "y": 1030,
        "wires": [
            [
                "15a773d7d7db2bec"
            ]
        ]
    },
    {
        "id": "74850b815da81b6d",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 520,
        "y": 960,
        "wires": [
            [
                "2ff392f940eb9220"
            ]
        ]
    },
    {
        "id": "76d7c529a1e90486",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Batteriemodus Info speichern",
        "rules": [
            {
                "t": "set",
                "p": "lastmessage",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3510,
        "y": 630,
        "wires": [
            []
        ]
    },
    {
        "id": "1bb6ed4e2d5521ee",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Batterienetzladung Info",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Batteriemodus",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2950,
        "y": 630,
        "wires": [
            [
                "2ecfa5f8a5119c16"
            ]
        ]
    },
    {
        "id": "5e4c6b4a811f4424",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "lastmessage",
                "vt": "flow"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3290,
        "y": 630,
        "wires": [
            [
                "76d7c529a1e90486"
            ]
        ]
    },
    {
        "id": "2ecfa5f8a5119c16",
        "type": "function",
        "z": "batteryoptimization",
        "name": "Nachricht",
        "func": "var message = msg.payload\n\nmsg.payload = msg.topic + ': ' + message\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 3140,
        "y": 630,
        "wires": [
            [
                "5e4c6b4a811f4424"
            ]
        ]
    },
    {
        "id": "59bf35ccca403115",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "soc",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1090,
        "y": 1150,
        "wires": [
            [
                "da9a643128d2896c"
            ]
        ]
    },
    {
        "id": "da9a643128d2896c",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "soc",
        "action": "",
        "pretty": false,
        "x": 1230,
        "y": 1150,
        "wires": [
            [
                "7d7a677f277ba7b9",
                "5e5befcdd31aa2f3",
                "527587bed23eb806"
            ]
        ]
    },
    {
        "id": "386a469dedb9b005",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minTotal",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "minTotal",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2720,
        "y": 830,
        "wires": [
            [
                "80e23acb1546d688"
            ]
        ]
    },
    {
        "id": "36bd4c3c0d3ef7fe",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "günstigster Preis heute",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "minTotal",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3040,
        "y": 870,
        "wires": [
            [
                "2655c96f3ee7ba1a"
            ],
            [
                "d4cd3d488c8225a1"
            ]
        ]
    },
    {
        "id": "8609b336a7dae183",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Preislevel",
        "property": "pricelevel",
        "propertyType": "msg",
        "rules": [
            {
                "t": "cont",
                "v": "CHEAP",
                "vt": "str"
            },
            {
                "t": "cont",
                "v": "NORMAL",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1880,
        "y": 1060,
        "wires": [
            [
                "32ba90adc53b1a21"
            ],
            [
                "fb55e25136a9f2ee"
            ],
            [
                "2829bf4d60449170"
            ]
        ]
    },
    {
        "id": "86b8ef8de0b7c839",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand hoch (>80)",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "80",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1620,
        "y": 1150,
        "wires": [
            [
                "2829bf4d60449170"
            ],
            [
                "0f80a34f198c5caf"
            ]
        ]
    },
    {
        "id": "0f80a34f198c5caf",
        "type": "special-date",
        "z": "batteryoptimization",
        "dates": [
            {
                "type": "range",
                "startDate": 15,
                "startDay": 0,
                "startMonth": 9,
                "startMonthOrdinal": 0,
                "startOrdinal": 0,
                "endDate": 15,
                "endMonth": 2,
                "offsetOrdinalBefore": 0,
                "offsetOrdinalAfter": 0,
                "response": "true"
            }
        ],
        "defaultResponse": "false",
        "messageProperty": "within",
        "name": "Wintermonate (Okt-Mar)",
        "x": 1700,
        "y": 1200,
        "wires": [
            [
                "f3684f27692599ae"
            ]
        ]
    },
    {
        "id": "f3684f27692599ae",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "within",
        "action": "obj",
        "pretty": false,
        "x": 1870,
        "y": 1200,
        "wires": [
            [
                "ca6c98bde93515ab"
            ]
        ]
    },
    {
        "id": "ca6c98bde93515ab",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Winter?",
        "property": "within",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2020,
        "y": 1200,
        "wires": [
            [
                "64ff7273e10fd36c"
            ],
            [
                "2829bf4d60449170"
            ]
        ]
    },
    {
        "id": "64ff7273e10fd36c",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "pvforecast today",
        "topic": "alias.0.energy.pv.forecast_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2170,
        "y": 1150,
        "wires": [
            [
                "edf85c522f88d891"
            ]
        ]
    },
    {
        "id": "edf85c522f88d891",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 2320,
        "y": 1150,
        "wires": [
            [
                "26a6bf85ea3516e7"
            ]
        ]
    },
    {
        "id": "8b34069ca8a9daca",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_today",
                "pt": "flow",
                "to": "today",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "reqSolar",
                "pt": "msg",
                "to": "10000 - (msg.soc / 100 * 10000)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "reqSolar",
                "pt": "flow",
                "to": "reqSolar",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2800,
        "y": 1110,
        "wires": [
            [
                "c7fd7b021755fef3"
            ]
        ]
    },
    {
        "id": "26a6bf85ea3516e7",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "b12652c19b5a403a",
        "startTime": "civilDawn",
        "startTimeType": "pdsTime",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "civilDusk",
        "endTimeType": "pdsTime",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 2530,
        "y": 1160,
        "wires": [
            [
                "8b34069ca8a9daca"
            ],
            [
                "f13d22f16b27d3bf"
            ]
        ]
    },
    {
        "id": "c7fd7b021755fef3",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "zu wenig Restertrag (PV)",
        "property": "pvforecast_now",
        "propertyType": "flow",
        "rules": [
            {
                "t": "lt",
                "v": "reqSolar",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3000,
        "y": 1110,
        "wires": [
            [
                "8609b336a7dae183"
            ],
            [
                "2829bf4d60449170"
            ]
        ]
    },
    {
        "id": "2829bf4d60449170",
        "type": "change",
        "z": "batteryoptimization",
        "name": "normal",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2930,
        "y": 1280,
        "wires": [
            [
                "9cbce5866ed41866"
            ]
        ]
    },
    {
        "id": "ee4bff002ffba634",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand niedrig",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "enableGridChargeThreshold",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2090,
        "y": 940,
        "wires": [
            [
                "79f6a0b75dc479ee"
            ],
            [
                "bebca51ee6c8492a"
            ]
        ]
    },
    {
        "id": "fb55e25136a9f2ee",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "innerhalb Preisgrenze",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "batteryControlLimit",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2090,
        "y": 1050,
        "wires": [
            [
                "7167c85bc1434b79"
            ],
            [
                "2829bf4d60449170"
            ]
        ]
    },
    {
        "id": "79f6a0b75dc479ee",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minLevel",
        "topic": "alias.0.energy.grid.privelevel_min",
        "attrname": "minLevel",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2480,
        "y": 910,
        "wires": [
            [
                "53e558eeb7382405"
            ]
        ]
    },
    {
        "id": "53e558eeb7382405",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Preislevel",
        "property": "minLevel",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "pricelevel",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2630,
        "y": 910,
        "wires": [
            [
                "386a469dedb9b005"
            ],
            [
                "d4cd3d488c8225a1"
            ]
        ]
    },
    {
        "id": "d981060db94bd4f3",
        "type": "change",
        "z": "batteryoptimization",
        "name": "hold",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "hold",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3640,
        "y": 1080,
        "wires": [
            [
                "a5fd70e616ce8788"
            ]
        ]
    },
    {
        "id": "b031fbbaca9c5dd7",
        "type": "change",
        "z": "batteryoptimization",
        "name": "charge",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "charge",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3750,
        "y": 960,
        "wires": [
            [
                "a5fd70e616ce8788",
                "9f4ea3b90cd38adf"
            ]
        ]
    },
    {
        "id": "bebca51ee6c8492a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladen aktiv?",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2330,
        "y": 980,
        "wires": [
            [
                "5419341709852504"
            ],
            [
                "d981060db94bd4f3"
            ]
        ]
    },
    {
        "id": "5419341709852504",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand ausreichend",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "disableGridChargeThreshold",
                "vt": "flow"
            },
            {
                "t": "lt",
                "v": "90",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 3,
        "x": 2570,
        "y": 970,
        "wires": [
            [
                "79f6a0b75dc479ee"
            ],
            [
                "122b2adf77ddff6a"
            ],
            [
                "d981060db94bd4f3",
                "ac64cd71740c0d1f"
            ]
        ]
    },
    {
        "id": "2655c96f3ee7ba1a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladen erlaubt?",
        "property": "enableGridcharge",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3300,
        "y": 880,
        "wires": [
            [
                "b031fbbaca9c5dd7",
                "7234a32a8d0dc42a"
            ],
            [
                "d981060db94bd4f3"
            ]
        ]
    },
    {
        "id": "f13d22f16b27d3bf",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "PV ungenügend (Bedarf)",
        "property": "pvforecast_now",
        "propertyType": "flow",
        "rules": [
            {
                "t": "lt",
                "v": "energy_req",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2810,
        "y": 1190,
        "wires": [
            [
                "8609b336a7dae183"
            ],
            [
                "2829bf4d60449170"
            ]
        ]
    },
    {
        "id": "a5fd70e616ce8788",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "price",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3800,
        "y": 1080,
        "wires": [
            [
                "8832d02e954a9420",
                "49f6eca32a529e7f",
                "58ea42236428d159"
            ]
        ]
    },
    {
        "id": "9fac21a89b87831d",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "tariffPriceHome",
        "topic": "alias.0.energy.evcc.tariffPriceHome",
        "attrname": "payload",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 3810,
        "y": 1310,
        "wires": [
            [
                "8832d02e954a9420",
                "49f6eca32a529e7f",
                "58ea42236428d159"
            ]
        ]
    },
    {
        "id": "8832d02e954a9420",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "neq",
                "v": "targetMode",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 4110,
        "y": 1150,
        "wires": [
            [
                "14d6676324d4a06e",
                "c8d05f17d301ce56"
            ]
        ]
    },
    {
        "id": "14d6676324d4a06e",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Zeitstempel",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "ts",
        "targetType": "msg",
        "statusVal": "ts",
        "statusType": "msg",
        "x": 4230,
        "y": 1100,
        "wires": []
    },
    {
        "id": "32ba90adc53b1a21",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "innerhalb Preisgrenze",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "batteryControlLimit",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2090,
        "y": 1010,
        "wires": [
            [
                "ee4bff002ffba634"
            ],
            [
                "2829bf4d60449170"
            ]
        ]
    },
    {
        "id": "9407577bb0bab5da",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "EVCC darf eigenständig laden (GUI)",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1650,
        "y": 100,
        "wires": []
    },
    {
        "id": "60c271b7c9fdc3eb",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Zeitstempel",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "ts",
        "statusType": "msg",
        "x": 2720,
        "y": 100,
        "wires": []
    },
    {
        "id": "7c38709e7f7d0bab",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Zeitstempel",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "ts",
        "statusType": "msg",
        "x": 2950,
        "y": 310,
        "wires": []
    },
    {
        "id": "f14d3630371b8f63",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Entladung vermeiden",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2470,
        "y": 140,
        "wires": [
            [
                "17dcde62c5b26356"
            ]
        ]
    },
    {
        "id": "7b1f8ad23fe41e68",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Netzladung aktiv",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1820,
        "y": 140,
        "wires": [
            [
                "f14d3630371b8f63"
            ]
        ]
    },
    {
        "id": "52250d22445967a6",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre (UI) aktiv?",
        "property": "batteryLock",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1990,
        "y": 380,
        "wires": [
            [
                "9c2d0bc7be220fdf"
            ],
            [
                "b6213f1789a2dadf",
                "fa87a1fea7f433f7"
            ]
        ]
    },
    {
        "id": "b49dd3c3c93f677a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre (UI) aktiv?",
        "property": "batteryLock",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3410,
        "y": 1390,
        "wires": [
            [
                "d981060db94bd4f3"
            ],
            [
                "9fac21a89b87831d",
                "e6e9d1012e577843"
            ]
        ]
    },
    {
        "id": "9c2d0bc7be220fdf",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ändern",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "hold",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2360,
        "y": 340,
        "wires": [
            [
                "f14d3630371b8f63",
                "8c5c919c5aeb182a"
            ]
        ]
    },
    {
        "id": "7c808aec982f7a77",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "minsoc",
        "action": "",
        "pretty": false,
        "x": 1780,
        "y": 380,
        "wires": [
            [
                "52250d22445967a6"
            ]
        ]
    },
    {
        "id": "ac3d2163184668bb",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "günstiger als Preisgrenze?",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "gridlimit",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3270,
        "y": 930,
        "wires": [
            [
                "2655c96f3ee7ba1a"
            ],
            [
                "d981060db94bd4f3"
            ]
        ]
    },
    {
        "id": "d4cd3d488c8225a1",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzladungspreisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "attrname": "gridlimit",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2870,
        "y": 920,
        "wires": [
            [
                "e5d962c628e908ce"
            ]
        ]
    },
    {
        "id": "e5d962c628e908ce",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "gridlimit",
        "action": "",
        "pretty": false,
        "x": 3050,
        "y": 920,
        "wires": [
            [
                "ac3d2163184668bb"
            ]
        ]
    },
    {
        "id": "31085cdfd6b2f082",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Dauer",
        "rules": [
            {
                "t": "set",
                "p": "now",
                "pt": "msg",
                "to": "",
                "tot": "date"
            },
            {
                "t": "set",
                "p": "last",
                "pt": "msg",
                "to": "batteryModeTS",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "diff",
                "pt": "msg",
                "to": "now - last",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "batteryModeTS",
                "pt": "flow",
                "to": "",
                "tot": "date"
            },
            {
                "t": "set",
                "p": "lastBatteryMode",
                "pt": "msg",
                "to": "batteryMode",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3500,
        "y": 1480,
        "wires": [
            [
                "b835cef8cc8ac73c",
                "4dcfd0f794563c5a"
            ]
        ]
    },
    {
        "id": "b835cef8cc8ac73c",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Dauer",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "diff",
        "statusType": "msg",
        "x": 3670,
        "y": 1440,
        "wires": []
    },
    {
        "id": "4dcfd0f794563c5a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung",
        "property": "batteryMode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3690,
        "y": 1480,
        "wires": [
            [
                "f40cecb354f57064",
                "a8e8556473eb2c17"
            ]
        ]
    },
    {
        "id": "f40cecb354f57064",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "costs",
                "pt": "msg",
                "to": "chargePrice",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round($number(msg.diff)/3600/1000*$number(msg.costs)*5)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "chargeCosts",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "costs",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "(costs*1.2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3910,
        "y": 1480,
        "wires": [
            [
                "5dcf896cd4f97574",
                "bfb4a196553da003",
                "bed11df2f7a7830e"
            ]
        ]
    },
    {
        "id": "49f6eca32a529e7f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "topic": "alias.0.energy.battery.targetMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 4060,
        "y": 1270,
        "wires": [
            [
                "6ef1f5e947b00879"
            ]
        ]
    },
    {
        "id": "6ef1f5e947b00879",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden",
        "property": "batteryMode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "targetMode",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3350,
        "y": 1480,
        "wires": [
            [
                "31085cdfd6b2f082"
            ]
        ]
    },
    {
        "id": "c8d05f17d301ce56",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "targetMode",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 4400,
        "y": 1150,
        "wires": [
            []
        ]
    },
    {
        "id": "a8e8556473eb2c17",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round(($number(msg.diff)/3600/1000*5),3)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "gridEnergy",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3910,
        "y": 1540,
        "wires": [
            [
                "c58fe93265ace1ff"
            ]
        ]
    },
    {
        "id": "2311aa2a09deea1e",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "",
        "props": [
            {
                "p": "costs",
                "v": "0.30",
                "vt": "str"
            },
            {
                "p": "diff",
                "v": "3960000",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 3280,
        "y": 1520,
        "wires": [
            [
                "8ef10440387514a8"
            ]
        ]
    },
    {
        "id": "e6e9d1012e577843",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Kosten ausgeglichen",
        "property": "(msg.price*1.2)",
        "propertyType": "jsonata",
        "rules": [
            {
                "t": "lte",
                "v": "lastCosts",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3700,
        "y": 1270,
        "wires": [
            [
                "23405317973b5435"
            ],
            [
                "bdf4bd47777eb3eb"
            ]
        ]
    },
    {
        "id": "5e5befcdd31aa2f3",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batterieladung erschöpft (<10)",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "10",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1370,
        "y": 1250,
        "wires": [
            [
                "5ace0cc285a44401"
            ]
        ]
    },
    {
        "id": "9cfce4b4f692965b",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "(msg.feedin*1.2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1950,
        "y": 1250,
        "wires": [
            [
                "53efad8ea2cf4469"
            ]
        ]
    },
    {
        "id": "5ace0cc285a44401",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "topic": "alias.0.energy.pv.price_feedin",
        "attrname": "_feedin",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1620,
        "y": 1250,
        "wires": [
            [
                "6d6f0db2ee160755"
            ]
        ]
    },
    {
        "id": "6d6f0db2ee160755",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "_feedin",
        "action": "",
        "pretty": false,
        "x": 1780,
        "y": 1250,
        "wires": [
            [
                "9cfce4b4f692965b"
            ]
        ]
    },
    {
        "id": "23405317973b5435",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Kostenausgleich",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "(msg.price*1.2)",
        "statusType": "jsonata",
        "x": 4240,
        "y": 980,
        "wires": []
    },
    {
        "id": "bdf4bd47777eb3eb",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Kostendifferenz",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "(msg.price*1.2)",
        "statusType": "jsonata",
        "x": 4240,
        "y": 1040,
        "wires": []
    },
    {
        "id": "7167c85bc1434b79",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "günstiger als Preisgrenze?",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "gridlimit",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2480,
        "y": 1040,
        "wires": [
            [
                "ee4bff002ffba634"
            ],
            [
                "d981060db94bd4f3"
            ]
        ]
    },
    {
        "id": "b2dba7f59fc00347",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 780,
        "y": 1150,
        "wires": [
            [
                "3aca59fb44ff3927"
            ]
        ]
    },
    {
        "id": "80e23acb1546d688",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "minTotal",
        "action": "",
        "pretty": false,
        "x": 2850,
        "y": 830,
        "wires": [
            [
                "e9c1943219e9b6df"
            ]
        ]
    },
    {
        "id": "5b018cdb29303135",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "(0.079*1.2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "(0.32*1.2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 620,
        "y": 900,
        "wires": [
            []
        ]
    },
    {
        "id": "9f4ea3b90cd38adf",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "chargePrice",
                "pt": "flow",
                "to": "price",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3930,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "8ef10440387514a8",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "chargePrice",
                "pt": "flow",
                "to": "$number(costs)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3470,
        "y": 1520,
        "wires": [
            [
                "4dcfd0f794563c5a"
            ]
        ]
    },
    {
        "id": "7d7a677f277ba7b9",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batterie ausreichend (>90)",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "90",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1360,
        "y": 1300,
        "wires": [
            [
                "5ace0cc285a44401"
            ]
        ]
    },
    {
        "id": "39f389aa935f4f94",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "batteryControlLimit",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2890,
        "y": 720,
        "wires": [
            [
                "b8b61ef5486db436"
            ]
        ]
    },
    {
        "id": "7365a89a3f640e29",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "täglich",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "10 00 * * *",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 1410,
        "wires": [
            [
                "17646457dc6f5d55"
            ]
        ]
    },
    {
        "id": "9bbb4dca6e54aaac",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Differenz",
        "rules": [
            {
                "t": "set",
                "p": "diff",
                "pt": "msg",
                "to": "max-min",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "spreizung",
                "pt": "msg",
                "to": "$round($max([(avg-min),(max-avg)]),3)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1410,
        "wires": [
            [
                "188b2f2870c7c147",
                "8ea392ace4b3443a"
            ]
        ]
    },
    {
        "id": "8ea392ace4b3443a",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "pvforecast today",
        "topic": "alias.0.energy.pv.forecast_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 950,
        "y": 1410,
        "wires": [
            [
                "d4d185df241f65b9"
            ]
        ]
    },
    {
        "id": "d4d185df241f65b9",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 1330,
        "y": 1410,
        "wires": [
            [
                "547399bd31238a06",
                "1e86d4fd1c50fec0",
                "107f28267edba49c",
                "e8be562a3a8703ea",
                "6b63025041307fc1"
            ]
        ]
    },
    {
        "id": "547399bd31238a06",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "PV < 16kW",
        "property": "today",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "pvMinimumRequired",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1540,
        "y": 1410,
        "wires": [
            [
                "f3e5d896a69f39c5"
            ],
            [
                "40b9f4a1465bd111"
            ]
        ]
    },
    {
        "id": "f3e5d896a69f39c5",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Preisspanne",
        "property": "diff",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "minPriceDifference",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 1730,
        "y": 1370,
        "wires": [
            [
                "c7628883125e2718",
                "2f40a08263c8f470"
            ],
            [
                "85e123f21d812cc1"
            ]
        ]
    },
    {
        "id": "40b9f4a1465bd111",
        "type": "change",
        "z": "batteryoptimization",
        "name": "nicht optimieren",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2190,
        "y": 1570,
        "wires": [
            [
                "1f5bf20819cc56fb",
                "343d90235910594e",
                "d1d8dcc7f2480dcb"
            ]
        ]
    },
    {
        "id": "2f40a08263c8f470",
        "type": "change",
        "z": "batteryoptimization",
        "name": "optimieren",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2180,
        "y": 1440,
        "wires": [
            [
                "8b4c30822e7f5461",
                "d1d8dcc7f2480dcb"
            ]
        ]
    },
    {
        "id": "343d90235910594e",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ohne Netzladung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2400,
        "y": 1400,
        "wires": [
            [
                "8b4c30822e7f5461",
                "c97002647b5966d0"
            ]
        ]
    },
    {
        "id": "a93ef65495237389",
        "type": "change",
        "z": "batteryoptimization",
        "name": "mit Netzladung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2410,
        "y": 1350,
        "wires": [
            [
                "100e2023ef7e736a",
                "c97002647b5966d0"
            ]
        ]
    },
    {
        "id": "c7628883125e2718",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "PV < 10kW",
        "property": "today",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "10000",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2180,
        "y": 1360,
        "wires": [
            [
                "a93ef65495237389"
            ],
            [
                "343d90235910594e"
            ]
        ]
    },
    {
        "id": "1e86d4fd1c50fec0",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Differenz",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "$round((diff*100),1)",
        "statusType": "jsonata",
        "x": 1530,
        "y": 1470,
        "wires": []
    },
    {
        "id": "107f28267edba49c",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Differenz in ct",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round((diff*100),1)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1550,
        "y": 1530,
        "wires": [
            []
        ]
    },
    {
        "id": "8b4c30822e7f5461",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Modus \"Kappung\"",
        "rules": [
            {
                "t": "set",
                "p": "mode",
                "pt": "flow",
                "to": "LIMIT",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2680,
        "y": 1570,
        "wires": [
            []
        ]
    },
    {
        "id": "100e2023ef7e736a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Modus \"Netzladung\"",
        "rules": [
            {
                "t": "set",
                "p": "mode",
                "pt": "flow",
                "to": "GRID",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2690,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "1f5bf20819cc56fb",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Modus \"normal\"",
        "rules": [
            {
                "t": "set",
                "p": "mode",
                "pt": "flow",
                "to": "NORMAL",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2670,
        "y": 1620,
        "wires": [
            []
        ]
    },
    {
        "id": "e8be562a3a8703ea",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Abweichung",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "$round((spreizung*100),1)",
        "statusType": "jsonata",
        "x": 1540,
        "y": 1580,
        "wires": []
    },
    {
        "id": "85e123f21d812cc1",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Spreizung",
        "property": "spreizung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "minPriceDeviation",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 1920,
        "y": 1440,
        "wires": [
            [
                "2f40a08263c8f470",
                "343d90235910594e"
            ],
            [
                "b0615d63be7ec00f"
            ]
        ]
    },
    {
        "id": "6b63025041307fc1",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Abweichung in ct",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round((spreizung*100),1)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1560,
        "y": 1630,
        "wires": [
            []
        ]
    },
    {
        "id": "f7e0bdd61b87ef8d",
        "type": "change",
        "z": "batteryoptimization",
        "name": "starten, speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "price",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastBatteryGridChargeLimit",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2750,
        "y": 400,
        "wires": [
            [
                "87cb16c5fb385e99"
            ]
        ]
    },
    {
        "id": "f99e2f73be56fe6f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "verbleibender Strompreis (avg)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 3930,
        "y": 870,
        "wires": [
            [
                "62a7bc54e5f15137"
            ]
        ]
    },
    {
        "id": "62a7bc54e5f15137",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 4160,
        "y": 870,
        "wires": [
            [
                "bf4e4fc8eefa9a26"
            ]
        ]
    },
    {
        "id": "40ca197bf58c4485",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "morgiger Strompreis (avg)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 3910,
        "y": 820,
        "wires": [
            [
                "ba3c172c3281c788"
            ]
        ]
    },
    {
        "id": "ba3c172c3281c788",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 4160,
        "y": 820,
        "wires": [
            [
                "bf4e4fc8eefa9a26"
            ]
        ]
    },
    {
        "id": "3c6a1bd6aae55740",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten",
        "rules": [
            {
                "t": "set",
                "p": "costs",
                "pt": "msg",
                "to": "(price*1.25)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3720,
        "y": 870,
        "wires": [
            [
                "f99e2f73be56fe6f"
            ]
        ]
    },
    {
        "id": "7c5c14ed8fb8ed9f",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten",
        "rules": [
            {
                "t": "set",
                "p": "costs",
                "pt": "msg",
                "to": "(price*1.25)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3720,
        "y": 820,
        "wires": [
            [
                "40ca197bf58c4485"
            ]
        ]
    },
    {
        "id": "7234a32a8d0dc42a",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "b12652c19b5a403a",
        "startTime": "civilDusk",
        "startTimeType": "pdsTime",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "23:59",
        "endTimeType": "entered",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 3530,
        "y": 850,
        "wires": [
            [
                "7c5c14ed8fb8ed9f"
            ],
            [
                "3c6a1bd6aae55740"
            ]
        ]
    },
    {
        "id": "bf4e4fc8eefa9a26",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "geringer",
        "property": "costs",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "avg",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3590,
        "y": 980,
        "wires": [
            [
                "b031fbbaca9c5dd7"
            ],
            [
                "d981060db94bd4f3"
            ]
        ]
    },
    {
        "id": "87cb16c5fb385e99",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "zu teuer",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "maximumGridPrice",
                "vt": "flow"
            },
            {
                "t": "gte",
                "v": "maximumGridPrice",
                "vt": "flow"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2920,
        "y": 400,
        "wires": [
            [
                "5b3545b00618092c"
            ],
            [
                "94e4b69dc3e75cbe"
            ]
        ]
    },
    {
        "id": "2d9d47668870c4db",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "lastGridChargeCost",
        "topic": "alias.0.energy.control.lastGridChargePrice",
        "attrname": "lastGridChargeCost",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 750,
        "y": 120,
        "wires": [
            [
                "7e7b71fcfb8248e6"
            ]
        ]
    },
    {
        "id": "7e7b71fcfb8248e6",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "lastGridChargeCost",
        "action": "",
        "pretty": false,
        "x": 910,
        "y": 120,
        "wires": [
            [
                "ea9c208afd93bded"
            ]
        ]
    },
    {
        "id": "5dcf896cd4f97574",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "lastGridChargeCost",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round(msg.payload*1.1,3)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 4080,
        "y": 1440,
        "wires": [
            [
                "942aed01c01bfd01"
            ]
        ]
    },
    {
        "id": "b0615d63be7ec00f",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "vorherige Ladungskosten",
        "property": "avg",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "batteryControlLimit",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2120,
        "y": 1500,
        "wires": [
            [
                "2f40a08263c8f470",
                "343d90235910594e"
            ],
            [
                "40b9f4a1465bd111"
            ]
        ]
    },
    {
        "id": "f177dde0d83f9305",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 350,
        "y": 1060,
        "wires": [
            [
                "71d0c1bd5d24acaa"
            ]
        ]
    },
    {
        "id": "95a76ad12152489f",
        "type": "function",
        "z": "batteryoptimization",
        "name": "map",
        "func": "const millis = msg.millis = new Date().getTime();\nmsg.diff = millis - msg.lastchange;\n\nconst current = msg.current = new Date().getHours();\nconst offset = msg.offset = (new Date().getTimezoneOffset())/60;\n//const hour = msg.hour = new Date(msg.lastchange).getHours();\nconst hour = msg.hour = (new Date(msg.payload.estimations[0].t).getHours()+offset);\nconst n = 24-hour;\nconst h = current - hour;\n\nconst today = msg.today = msg.payload.estimations.map(estimation => estimation.y).slice(0,(n*2));\nconst remain = msg.remain =  today.slice((h*2)); \nmsg.payload = remain;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1210,
        "y": 1760,
        "wires": [
            [
                "7b70b2814740283d"
            ]
        ]
    },
    {
        "id": "6b5d4f87cdacbfe8",
        "type": "change",
        "z": "batteryoptimization",
        "name": "move",
        "rules": [
            {
                "t": "set",
                "p": "pvForecastJSON",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "payload.estimations",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1050,
        "y": 1760,
        "wires": [
            [
                "95a76ad12152489f"
            ]
        ]
    },
    {
        "id": "ad570c5a4269fd66",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 920,
        "y": 1760,
        "wires": [
            [
                "6b5d4f87cdacbfe8"
            ]
        ]
    },
    {
        "id": "7b70b2814740283d",
        "type": "calculator",
        "z": "batteryoptimization",
        "name": "",
        "inputMsgField": "payload",
        "outputMsgField": "sum",
        "operation": "sum",
        "constant": "",
        "round": false,
        "decimals": 0,
        "x": 1340,
        "y": 1760,
        "wires": [
            [
                "51dfd63ded64ac1d"
            ]
        ]
    },
    {
        "id": "51dfd63ded64ac1d",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_now",
                "pt": "flow",
                "to": "(sum/2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1490,
        "y": 1760,
        "wires": [
            [
                "7d86b66b5df8dda7"
            ]
        ]
    },
    {
        "id": "5e3903103cfd621f",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "b12652c19b5a403a",
        "startTime": "0:00",
        "startTimeType": "entered",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "civilDusk",
        "endTimeType": "pdsTime",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 510,
        "y": 1780,
        "wires": [
            [
                "274c70ef0e6a9c18"
            ],
            [
                "6481ae109528c0a8"
            ]
        ]
    },
    {
        "id": "274c70ef0e6a9c18",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "JSONData",
        "topic": "alias.0.energy.pv.pvforecast_summary_JSONData",
        "attrname": "payload",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 750,
        "y": 1770,
        "wires": [
            [
                "ad570c5a4269fd66"
            ]
        ]
    },
    {
        "id": "6481ae109528c0a8",
        "type": "change",
        "z": "batteryoptimization",
        "name": "kein Ertrag",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_now",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 1820,
        "wires": [
            [
                "7d86b66b5df8dda7"
            ]
        ]
    },
    {
        "id": "7d86b66b5df8dda7",
        "type": "change",
        "z": "batteryoptimization",
        "name": "laden",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_now",
                "pt": "msg",
                "to": "pvforecast_now",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "(pvforecast_now/1000)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1640,
        "y": 1820,
        "wires": [
            []
        ]
    },
    {
        "id": "c17d6a1ace328248",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "stündlich",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "3600",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 310,
        "y": 1780,
        "wires": [
            [
                "5e3903103cfd621f"
            ]
        ]
    },
    {
        "id": "953232befbe66b0d",
        "type": "function",
        "z": "batteryoptimization",
        "name": "remain",
        "func": "const current = msg.current = new Date().getHours();\nconst n = 24-current;\nconst h = current;\nconst t = 8;\nmsg.n=n;\n\nmsg.tomorrow = msg.lastprofil;\n\nconst remain = msg.remain =  msg.lastprofil.slice(h);\nconst tomorrow = msg.remain2 = msg.tomorrow.slice(0,t);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 1990,
        "wires": [
            [
                "ea54f6eefedd6eed"
            ]
        ]
    },
    {
        "id": "0b2e1a3a92a1b6fa",
        "type": "calculator",
        "z": "batteryoptimization",
        "name": "verbleibend (heute)",
        "inputMsgField": "remain",
        "outputMsgField": "sum",
        "operation": "sum",
        "constant": "",
        "round": false,
        "decimals": 0,
        "x": 920,
        "y": 1970,
        "wires": [
            [
                "a4aa2497ee060437"
            ]
        ]
    },
    {
        "id": "f6ba7bd41972dd4a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round((sum + sum2)*1000,2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "energy_req",
                "pt": "flow",
                "to": "$round((payload),2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "energy_req_today",
                "pt": "flow",
                "to": "$round((sum*1000),2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1330,
        "y": 2010,
        "wires": [
            []
        ]
    },
    {
        "id": "0d559e8b2889fe57",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "initialisieren (~500W/h)",
        "props": [
            {
                "p": "lastprofil",
                "v": "[0.4,0.4,0.4,0.4,0.4,0.4,1,1,0.4,0.4,0.4,0.4,1,1,0.4,0.4,0.4,1,1,1,1,1,0.4,0.4]",
                "vt": "jsonata"
            }
        ],
        "repeat": "600",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "x": 350,
        "y": 1990,
        "wires": [
            [
                "953232befbe66b0d"
            ]
        ]
    },
    {
        "id": "a4aa2497ee060437",
        "type": "calculator",
        "z": "batteryoptimization",
        "name": "verbleibend (morgen)",
        "inputMsgField": "remain2",
        "outputMsgField": "sum2",
        "operation": "sum",
        "constant": "",
        "round": false,
        "decimals": 0,
        "x": 1150,
        "y": 2010,
        "wires": [
            [
                "f6ba7bd41972dd4a"
            ]
        ]
    },
    {
        "id": "122b2adf77ddff6a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Bedarf gedeckt",
        "property": "energy_req",
        "propertyType": "flow",
        "rules": [
            {
                "t": "gte",
                "v": "(soc*100)",
                "vt": "jsonata"
            },
            {
                "t": "lt",
                "v": "(soc*100)",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2900,
        "y": 980,
        "wires": [
            [
                "79f6a0b75dc479ee"
            ],
            [
                "d981060db94bd4f3",
                "ac64cd71740c0d1f"
            ]
        ]
    },
    {
        "id": "19a8fe2be60538fc",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Modus",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "normal",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "normal",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2870,
        "y": 500,
        "wires": [
            [
                "52f6e366f07a3009"
            ],
            [
                "3aaac877bf22ac47"
            ]
        ]
    },
    {
        "id": "52f6e366f07a3009",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "price",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3040,
        "y": 490,
        "wires": [
            [
                "b3dd1b0a3c849f7c"
            ]
        ]
    },
    {
        "id": "1c190c5640831970",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "manuell",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 350,
        "y": 890,
        "wires": [
            [
                "64e37229c6d36611",
                "5b018cdb29303135"
            ]
        ]
    },
    {
        "id": "64e37229c6d36611",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "flow",
                "to": "0.079",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 610,
        "y": 870,
        "wires": [
            []
        ]
    },
    {
        "id": "b3dd1b0a3c849f7c",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzbezug",
        "property": "wirkleistung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "50",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3200,
        "y": 480,
        "wires": [
            [
                "940dc63622c8b4d8",
                "984f0db091e7927a"
            ],
            [
                "3aaac877bf22ac47"
            ]
        ]
    },
    {
        "id": "3aaac877bf22ac47",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batterieleistung",
        "property": "battery",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "20",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3060,
        "y": 550,
        "wires": [
            [
                "ad7dfadf4043fa2b"
            ],
            [
                "3c315fa63330d598"
            ]
        ]
    },
    {
        "id": "3c315fa63330d598",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3300,
        "y": 570,
        "wires": [
            [
                "940dc63622c8b4d8",
                "984f0db091e7927a"
            ]
        ]
    },
    {
        "id": "ad7dfadf4043fa2b",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "lastGridChargeCost",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3300,
        "y": 540,
        "wires": [
            [
                "940dc63622c8b4d8",
                "984f0db091e7927a"
            ]
        ]
    },
    {
        "id": "940dc63622c8b4d8",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "aktuelle Kosten",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 3720,
        "y": 590,
        "wires": []
    },
    {
        "id": "7474b731beae0dc8",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "hold",
        "payloadType": "str",
        "x": 2660,
        "y": 500,
        "wires": [
            [
                "19a8fe2be60538fc"
            ]
        ]
    },
    {
        "id": "e0956a8b56ac0086",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "war msg.today",
        "info": "",
        "x": 2840,
        "y": 1210,
        "wires": []
    },
    {
        "id": "d4be7618f0dd9191",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "hatte auch msg.now",
        "info": "",
        "x": 2950,
        "y": 1130,
        "wires": []
    },
    {
        "id": "42f7cbcccfc97fd3",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "war 12kW - besser 15kW",
        "info": "bzw. vorher zu kleine 12kW",
        "x": 1590,
        "y": 1430,
        "wires": []
    },
    {
        "id": "23d3af62205a3296",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "15ct Preisdifferenz nötig ",
        "info": "vielleicht geringer auch ok, 25?!",
        "x": 1780,
        "y": 1340,
        "wires": []
    },
    {
        "id": "54f92fa43cc41181",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "energy_req_today? 9 kW ",
        "info": "vielleicht an den heutigen Bedarf anpassen?\n9kW sind 75% des Tagesbedarfs",
        "x": 2080,
        "y": 1340,
        "wires": []
    },
    {
        "id": "1f6e51f519329828",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1420,
        "y": 1210,
        "wires": [
            [
                "5ace0cc285a44401"
            ]
        ]
    },
    {
        "id": "7c91b176a5346b94",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Entladungskosten",
        "info": "",
        "x": 3320,
        "y": 520,
        "wires": []
    },
    {
        "id": "96b0be48561643c0",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "info": "",
        "x": 3320,
        "y": 590,
        "wires": []
    },
    {
        "id": "91f90113abfb0e2e",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "info": "",
        "x": 3320,
        "y": 450,
        "wires": []
    },
    {
        "id": "53efad8ea2cf4469",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden?",
        "property": "_feedin",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "feedin",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2030,
        "y": 1290,
        "wires": [
            [
                "942aed01c01bfd01",
                "bed11df2f7a7830e"
            ]
        ]
    },
    {
        "id": "5fdd98749d8e2057",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "10ct, vielleicht besser 5ct",
        "info": "Idee: Abweichung vom Durchschnitt",
        "x": 1960,
        "y": 1410,
        "wires": []
    },
    {
        "id": "6ea6acfdd4ecd852",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "30ct Preisdifferenz nötig (vorher)",
        "info": "vielleicht geringer auch ok, 25?!",
        "x": 1750,
        "y": 1310,
        "wires": []
    },
    {
        "id": "188b2f2870c7c147",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Spreizung",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "spreizung",
        "statusType": "msg",
        "x": 930,
        "y": 1360,
        "wires": []
    },
    {
        "id": "cae7c9d47d0c73ea",
        "type": "change",
        "z": "batteryoptimization",
        "name": "inaktiv",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1510,
        "y": 960,
        "wires": [
            [
                "d1d8dcc7f2480dcb"
            ]
        ]
    },
    {
        "id": "a6a158b059c319d3",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 520,
        "y": 1020,
        "wires": [
            [
                "2e0759e94f45af99"
            ]
        ]
    },
    {
        "id": "2e0759e94f45af99",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 670,
        "y": 1020,
        "wires": [
            [
                "827066d676734a53"
            ]
        ]
    },
    {
        "id": "827066d676734a53",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre?",
        "property": "batteryLock",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 830,
        "y": 1020,
        "wires": [
            [
                "71d0c1bd5d24acaa"
            ]
        ]
    },
    {
        "id": "ad3c3fdcb7534fa3",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 520,
        "y": 610,
        "wires": [
            [
                "802ef28cc974369c"
            ]
        ]
    },
    {
        "id": "bc1fe72855ad0621",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "payload / 1.2",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 610,
        "wires": [
            [
                "bed11df2f7a7830e"
            ]
        ]
    },
    {
        "id": "802ef28cc974369c",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "lastGridChargeCost",
                "vt": "flow"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 660,
        "y": 610,
        "wires": [
            [
                "bc1fe72855ad0621"
            ]
        ]
    },
    {
        "id": "527587bed23eb806",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Anpassungen",
        "rules": [
            {
                "t": "set",
                "p": "_price",
                "pt": "msg",
                "to": "0.282",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1400,
        "y": 1150,
        "wires": [
            [
                "86b8ef8de0b7c839"
            ]
        ]
    },
    {
        "id": "ea54f6eefedd6eed",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "valide",
        "property": "n",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 700,
        "y": 1990,
        "wires": [
            [
                "0b2e1a3a92a1b6fa"
            ],
            [
                "891ea0edef053f99"
            ]
        ]
    },
    {
        "id": "891ea0edef053f99",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "sum",
                "pt": "msg",
                "to": "remain[0]",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 910,
        "y": 2010,
        "wires": [
            [
                "a4aa2497ee060437"
            ]
        ]
    },
    {
        "id": "348886da86b26fba",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "minTotal+",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "minTotal",
        "statusType": "msg",
        "x": 3260,
        "y": 830,
        "wires": []
    },
    {
        "id": "e9c1943219e9b6df",
        "type": "change",
        "z": "batteryoptimization",
        "name": "2% Abweichung",
        "rules": [
            {
                "t": "set",
                "p": "minTotal",
                "pt": "msg",
                "to": "$round(msg.minTotal*1.02,3)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3000,
        "y": 830,
        "wires": [
            [
                "348886da86b26fba",
                "36bd4c3c0d3ef7fe"
            ]
        ]
    },
    {
        "id": "ac64cd71740c0d1f",
        "type": "change",
        "z": "batteryoptimization",
        "name": "false",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2650,
        "y": 1370,
        "wires": [
            []
        ]
    },
    {
        "id": "df065e5bbe84e7e5",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Kostenoptimierung",
        "property": "avgGridPriceWeekly",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "price",
                "vt": "msg"
            },
            {
                "t": "lt",
                "v": "price",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3150,
        "y": 1380,
        "wires": [
            [
                "b2f6ccbd37acbd40"
            ],
            [
                "b49dd3c3c93f677a"
            ]
        ]
    },
    {
        "id": "b2f6ccbd37acbd40",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "80",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3340,
        "y": 1340,
        "wires": [
            [
                "d981060db94bd4f3"
            ],
            [
                "b49dd3c3c93f677a"
            ]
        ]
    },
    {
        "id": "6912641b25ffca4d",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Netzladungskompatibel!",
        "info": "",
        "x": 3420,
        "y": 1310,
        "wires": []
    },
    {
        "id": "5148adcb08333787",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "war verbunden, Quatsch?!",
        "info": "verbunden mit Laderegelung aktiv = false ",
        "x": 1650,
        "y": 130,
        "wires": []
    },
    {
        "id": "9cbce5866ed41866",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "avgGridPriceWeekly",
        "topic": "alias.0.energy.grid.price_avg_weekly",
        "attrname": "avgGridPriceWeekly",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2850,
        "y": 1340,
        "wires": [
            [
                "4311fd73e46fa54e"
            ]
        ]
    },
    {
        "id": "1478f0e4245997fa",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avgGridPriceWeekly",
        "action": "",
        "pretty": false,
        "x": 3170,
        "y": 1340,
        "wires": [
            [
                "df065e5bbe84e7e5"
            ]
        ]
    },
    {
        "id": "c58fe93265ace1ff",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Netzladungsmenge",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 4420,
        "y": 1540,
        "wires": []
    },
    {
        "id": "bfb4a196553da003",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Netzladungskosten",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 4420,
        "y": 1480,
        "wires": []
    },
    {
        "id": "1198f5691bf5f5ed",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 550,
        "y": 170,
        "wires": [
            [
                "0df79a72c2a5060e"
            ]
        ]
    },
    {
        "id": "0df79a72c2a5060e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 700,
        "y": 170,
        "wires": [
            [
                "e1d6ae8a0896a2df"
            ]
        ]
    },
    {
        "id": "e1d6ae8a0896a2df",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "batteryLock",
                "pt": "flow",
                "to": "batteryLock",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 170,
        "wires": [
            [
                "3ee9135467715378"
            ]
        ]
    },
    {
        "id": "47e0a73014f7c892",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Bedingung: PVForecast-Adapter",
        "info": "aus Tibber und InfluxDB den wöchentlichen Preisdurchschnitt ermitteln\nVoraussetzung:\n- in InfluxDB gespeicherte Tibber-Stundenpreisinformationen\n- Laufzeit: 1 Woche\n- alternativ: auf festen Wert, z.B. 0.24ct setzen!",
        "x": 350,
        "y": 1710,
        "wires": []
    },
    {
        "id": "4c8a75a782af5315",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "main configuration here",
        "info": "",
        "x": 1300,
        "y": 80,
        "wires": []
    },
    {
        "id": "54c0a40dc97cca0d",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Glättung der Kosten",
        "info": "",
        "x": 2840,
        "y": 1310,
        "wires": []
    },
    {
        "id": "dc2ff105f2ef41a1",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre?",
        "property": "batteryLock",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 890,
        "y": 390,
        "wires": [
            [
                "4f8fe3bee569a9c3"
            ]
        ]
    },
    {
        "id": "17dcde62c5b26356",
        "type": "change",
        "z": "batteryoptimization",
        "name": "sammeln für Ausgabe",
        "rules": [
            {
                "t": "set",
                "p": "batteryModeTS",
                "pt": "msg",
                "to": "batteryModeTS",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2760,
        "y": 200,
        "wires": [
            [
                "fd567863b35929b6"
            ]
        ]
    },
    {
        "id": "f1d7a7bb4e66f4ad",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Output",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2910,
        "y": 440,
        "wires": [
            [
                "684559ba59abec7d"
            ]
        ]
    },
    {
        "id": "0699808bff5b30f0",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "Batteriesperre (UI)",
        "attrname": "batteryLock",
        "topic": "alias.0.energy.control.batterylock",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 230,
        "y": 960,
        "wires": [
            [
                "74850b815da81b6d"
            ]
        ]
    },
    {
        "id": "09f082d1dcfbd129",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "attrname": "payload",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 250,
        "y": 750,
        "wires": [
            [
                "bed11df2f7a7830e"
            ]
        ]
    },
    {
        "id": "eb442d39995bb2bf",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "Netzpreisgrenze",
        "attrname": "preisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 220,
        "y": 690,
        "wires": [
            [
                "bed11df2f7a7830e"
            ]
        ]
    },
    {
        "id": "7f9fca2013456f1d",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "lastGridChargePrice",
        "attrname": "payload",
        "topic": "alias.0.energy.control.lastGridChargePrice",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 330,
        "y": 610,
        "wires": [
            [
                "ad3c3fdcb7534fa3"
            ]
        ]
    },
    {
        "id": "ce07a31e2ce4aba3",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "SoC-Batterie ",
        "attrname": "payload",
        "topic": "alias.0.energy.battery.soc",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 210,
        "y": 1100,
        "wires": [
            [
                "71d0c1bd5d24acaa"
            ]
        ]
    },
    {
        "id": "c97002647b5966d0",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Output",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2770,
        "y": 1460,
        "wires": [
            [
                "63d8cf81766d6c14"
            ]
        ]
    },
    {
        "id": "984f0db091e7927a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "feedIn_effective",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3610,
        "y": 450,
        "wires": [
            []
        ]
    },
    {
        "id": "ed1942f7fbabdbff",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "gridChargeCostLimit_effective",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3610,
        "y": 350,
        "wires": [
            []
        ]
    },
    {
        "id": "684559ba59abec7d",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode_effective",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "batteryModeTS",
                "pt": "msg",
                "to": "batteryModeTS",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2330,
        "y": 780,
        "wires": [
            [
                "02bfc7a2db0c0a6e"
            ]
        ]
    },
    {
        "id": "d1d8dcc7f2480dcb",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Output",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2640,
        "y": 1710,
        "wires": [
            [
                "59061e271880d606"
            ]
        ]
    },
    {
        "id": "4311fd73e46fa54e",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "gültig",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3020,
        "y": 1340,
        "wires": [
            [
                "d981060db94bd4f3"
            ],
            [
                "1478f0e4245997fa"
            ]
        ]
    },
    {
        "id": "02bfc7a2db0c0a6e",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "topic": "alias.0.energy.battery.targetMode",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 2740,
        "y": 780,
        "wires": []
    },
    {
        "id": "b8b61ef5486db436",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "effectiveGridChargeCostLimit",
        "topic": "alias.0.energy.control.effectiveGridChargeCostLimit",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 3340,
        "y": 720,
        "wires": []
    },
    {
        "id": "63d8cf81766d6c14",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Netzladung",
        "topic": "alias.0.energy.control.enableGridcharging",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 3140,
        "y": 1460,
        "wires": []
    },
    {
        "id": "59061e271880d606",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 3110,
        "y": 1710,
        "wires": []
    },
    {
        "id": "d20645e44a50d52a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Konfiguration",
        "rules": [
            {
                "t": "set",
                "p": "batteryMinSoC",
                "pt": "flow",
                "to": "5",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "maximumGridPrice",
                "pt": "flow",
                "to": "0.32",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "feedin",
                "pt": "flow",
                "to": "0.079",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "pvMinimumRequired",
                "pt": "flow",
                "to": "17500",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "minPriceDifference",
                "pt": "flow",
                "to": "0.15",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "minPriceDeviation",
                "pt": "flow",
                "to": "0.10",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "enableGridChargeThreshold",
                "pt": "flow",
                "to": "50",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "disableGridChargeThreshold",
                "pt": "flow",
                "to": "80",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "holdOnSmartCostLimit",
                "pt": "flow",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1330,
        "y": 110,
        "wires": [
            [
                "08ba3932ae497b01"
            ]
        ]
    },
    {
        "id": "a6faa4f0035eb1db",
        "type": "change",
        "z": "batteryoptimization",
        "name": "initialisieren",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "batteryMode",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "batteryMinSoC",
                "pt": "flow",
                "to": "5",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "lastGridChargeCost",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "maximumGridPrice",
                "pt": "flow",
                "to": "0.32",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "feedin",
                "pt": "flow",
                "to": "0.079",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastmessage",
                "pt": "flow",
                "to": "none",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "avgGridPriceWeekly",
                "pt": "flow",
                "to": "0.240",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "avgGridPriceWeekly",
                "pt": "flow",
                "to": "avgGridPriceWeekly",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "pvMinimumRequired",
                "pt": "flow",
                "to": "17500",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "minPriceDifference",
                "pt": "flow",
                "to": "0.15",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "8170219b178f8959",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Thresholds for battery charging redefined here",
        "info": "",
        "x": 2110,
        "y": 20,
        "wires": []
    },
    {
        "id": "08ba3932ae497b01",
        "type": "special-date",
        "z": "batteryoptimization",
        "dates": [
            {
                "type": "range",
                "startDate": 15,
                "startDay": 0,
                "startMonth": 10,
                "startMonthOrdinal": 0,
                "startOrdinal": 0,
                "endDate": 15,
                "endMonth": 1,
                "offsetOrdinalBefore": 0,
                "offsetOrdinalAfter": 0,
                "response": "true"
            }
        ],
        "defaultResponse": "false",
        "messageProperty": "within",
        "name": "kalte Monate (Nov-Feb)",
        "x": 1540,
        "y": 50,
        "wires": [
            [
                "1066566a4cde2dfb"
            ]
        ]
    },
    {
        "id": "1066566a4cde2dfb",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "within",
        "action": "obj",
        "pretty": false,
        "x": 1720,
        "y": 50,
        "wires": [
            [
                "76bfd6db41e46116"
            ]
        ]
    },
    {
        "id": "76bfd6db41e46116",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Winter?",
        "property": "within",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1860,
        "y": 50,
        "wires": [
            [
                "d5a941ec5b3044d3"
            ]
        ]
    },
    {
        "id": "d5a941ec5b3044d3",
        "type": "change",
        "z": "batteryoptimization",
        "name": "minSoC (im Winter)",
        "rules": [
            {
                "t": "set",
                "p": "batteryMinSoC",
                "pt": "flow",
                "to": "15",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2040,
        "y": 50,
        "wires": [
            []
        ]
    },
    {
        "id": "ef6853a364e38e43",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Definition \"Standardlastverteilung\" (24h)",
        "info": "24 Werte für den durchschnittlichen Stundenverbrauch des Haushaltes",
        "x": 370,
        "y": 1940,
        "wires": []
    },
    {
        "id": "fd567863b35929b6",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Ausgabe minSoC",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 3050,
        "y": 120,
        "wires": []
    },
    {
        "id": "9cedfb163289c148",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "b12652c19b5a403a",
        "startTime": "13:00",
        "startTimeType": "entered",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "23:59",
        "endTimeType": "entered",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 1740,
        "y": 850,
        "wires": [
            [
                "af33b1fcb1370f36"
            ],
            []
        ]
    },
    {
        "id": "af33b1fcb1370f36",
        "type": "trigger",
        "z": "batteryoptimization",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "1",
        "extend": false,
        "overrideDelay": false,
        "units": "hr",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 660,
        "y": 800,
        "wires": [
            [
                "bed11df2f7a7830e"
            ]
        ]
    },
    {
        "id": "5ead875f06748af7",
        "type": "change",
        "z": "batteryoptimization",
        "name": "reset",
        "rules": [
            {
                "t": "set",
                "p": "reset",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1990,
        "y": 850,
        "wires": [
            [
                "af33b1fcb1370f36"
            ]
        ]
    },
    {
        "id": "bed11df2f7a7830e",
        "type": "change",
        "z": "batteryoptimization",
        "name": "sammeln",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 720,
        "wires": [
            [
                "b59fa631dda2ad45"
            ]
        ]
    },
    {
        "id": "d509ced37156f884",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "maximaler Strompreis",
        "topic": "alias.0.energy.grid.price_max",
        "attrname": "max",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1430,
        "wires": [
            [
                "82ddc3ec65f9f812"
            ]
        ]
    },
    {
        "id": "2df19d7c6044cddd",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minimaler Strompreis",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "min",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1440,
        "wires": [
            [
                "73ef99e7a716ab6a"
            ]
        ]
    },
    {
        "id": "82ddc3ec65f9f812",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "max",
        "action": "",
        "pretty": false,
        "x": 560,
        "y": 1430,
        "wires": [
            [
                "2df19d7c6044cddd"
            ]
        ]
    },
    {
        "id": "73ef99e7a716ab6a",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "min",
        "action": "",
        "pretty": false,
        "x": 560,
        "y": 1440,
        "wires": [
            [
                "1ae1da7ee3deae6b"
            ]
        ]
    },
    {
        "id": "1ae1da7ee3deae6b",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "durchschnittlicher Strompreis",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 400,
        "y": 1430,
        "wires": [
            [
                "ca22c7df376af88e"
            ]
        ]
    },
    {
        "id": "ca22c7df376af88e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 590,
        "y": 1430,
        "wires": [
            [
                "06bdd505a440ea28"
            ]
        ]
    },
    {
        "id": "847838f2010c124f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (morgen)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "tomorrow",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1440,
        "wires": [
            [
                "f57c3d349ffeadca"
            ]
        ]
    },
    {
        "id": "f57c3d349ffeadca",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "action": "",
        "pretty": false,
        "x": 560,
        "y": 1440,
        "wires": [
            [
                "5274221cd3da610f"
            ]
        ]
    },
    {
        "id": "7512f911b1a59d67",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "regelung",
        "action": "",
        "pretty": false,
        "x": 510,
        "y": 1440,
        "wires": [
            [
                "2d151d61af41ee37"
            ]
        ]
    },
    {
        "id": "d3f655fdb7dc0a3b",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "attrname": "regelung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 360,
        "y": 1440,
        "wires": [
            [
                "7512f911b1a59d67"
            ]
        ]
    },
    {
        "id": "395523122f22d522",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus (EVCC)",
        "topic": "mqtt.0.evcc.site.batteryMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 580,
        "y": 1410,
        "wires": [
            [
                "9bbb4dca6e54aaac"
            ]
        ]
    },
    {
        "id": "8a0d9f7bf365daed",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "PV Leistung",
        "topic": "alias.0.energy.pv.production",
        "attrname": "pv",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 340,
        "y": 1440,
        "wires": [
            [
                "3e198260da52e7e5"
            ]
        ]
    },
    {
        "id": "3e198260da52e7e5",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "pv",
        "action": "",
        "pretty": false,
        "x": 480,
        "y": 1440,
        "wires": [
            [
                "395523122f22d522"
            ]
        ]
    },
    {
        "id": "4968da8fb4422cfe",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "batterySoC",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 340,
        "y": 1430,
        "wires": [
            [
                "551bce45691f71d4"
            ]
        ]
    },
    {
        "id": "551bce45691f71d4",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batterySoC",
        "action": "",
        "pretty": false,
        "x": 510,
        "y": 1430,
        "wires": [
            [
                "8a0d9f7bf365daed"
            ]
        ]
    },
    {
        "id": "4fbf3a9d9ba8623e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "wirkleistung",
        "action": "",
        "pretty": false,
        "x": 490,
        "y": 1430,
        "wires": [
            [
                "4968da8fb4422cfe"
            ]
        ]
    },
    {
        "id": "2d151d61af41ee37",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Wirkleistung",
        "topic": "alias.0.energy.grid.consumption",
        "attrname": "wirkleistung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 350,
        "y": 1430,
        "wires": [
            [
                "4fbf3a9d9ba8623e"
            ]
        ]
    },
    {
        "id": "f5c87883bdb89bbc",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "attrname": "batteryDischargeControl",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 390,
        "y": 1440,
        "wires": [
            [
                "61df41087c3161cb"
            ]
        ]
    },
    {
        "id": "61df41087c3161cb",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryDischargeControl",
        "action": "",
        "pretty": false,
        "x": 580,
        "y": 1440,
        "wires": [
            [
                "d3f655fdb7dc0a3b"
            ]
        ]
    },
    {
        "id": "5274221cd3da610f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (heute)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 370,
        "y": 1430,
        "wires": [
            [
                "bdc44d878bd6377e"
            ]
        ]
    },
    {
        "id": "bdc44d878bd6377e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 540,
        "y": 1430,
        "wires": [
            [
                "f5c87883bdb89bbc"
            ]
        ]
    },
    {
        "id": "fbc1fbcb6f852427",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1420,
        "wires": [
            [
                "cc5258d4358272f8"
            ]
        ]
    },
    {
        "id": "cc5258d4358272f8",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 550,
        "y": 1420,
        "wires": [
            [
                "d509ced37156f884"
            ]
        ]
    },
    {
        "id": "17646457dc6f5d55",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 360,
        "y": 1410,
        "wires": [
            [
                "883847127b91f53a"
            ]
        ]
    },
    {
        "id": "883847127b91f53a",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 520,
        "y": 1410,
        "wires": [
            [
                "fbc1fbcb6f852427"
            ]
        ]
    },
    {
        "id": "06bdd505a440ea28",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeiseverfügung",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 540,
        "y": 1430,
        "wires": [
            [
                "847838f2010c124f"
            ]
        ]
    },
    {
        "id": "3608d35d36f975c3",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "maximaler Strompreis",
        "topic": "alias.0.energy.grid.price_max",
        "attrname": "max",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 410,
        "wires": [
            [
                "dce01e447a37fced"
            ]
        ]
    },
    {
        "id": "44dc8b7673fb2ce9",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minimaler Strompreis",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "min",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 420,
        "wires": [
            [
                "05bd997115720744"
            ]
        ]
    },
    {
        "id": "dce01e447a37fced",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "max",
        "action": "",
        "pretty": false,
        "x": 660,
        "y": 410,
        "wires": [
            [
                "44dc8b7673fb2ce9"
            ]
        ]
    },
    {
        "id": "05bd997115720744",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "min",
        "action": "",
        "pretty": false,
        "x": 660,
        "y": 420,
        "wires": [
            [
                "b0c592c09f4bafb5"
            ]
        ]
    },
    {
        "id": "b0c592c09f4bafb5",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "durchschnittlicher Strompreis",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 500,
        "y": 410,
        "wires": [
            [
                "53db34841cdba2fe"
            ]
        ]
    },
    {
        "id": "53db34841cdba2fe",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 690,
        "y": 410,
        "wires": [
            [
                "05edb89dd7d7472e"
            ]
        ]
    },
    {
        "id": "912ca24855a3f674",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (morgen)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "tomorrow",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 420,
        "wires": [
            [
                "6bb3a4c44cc7abba"
            ]
        ]
    },
    {
        "id": "6bb3a4c44cc7abba",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "action": "",
        "pretty": false,
        "x": 660,
        "y": 420,
        "wires": [
            [
                "f8c9422f54e835b0"
            ]
        ]
    },
    {
        "id": "2c5c8dbfe9ce6002",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "regelung",
        "action": "",
        "pretty": false,
        "x": 610,
        "y": 420,
        "wires": [
            [
                "53e2d07ab02949b6"
            ]
        ]
    },
    {
        "id": "6c6b2182997aa6b8",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "attrname": "regelung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 460,
        "y": 420,
        "wires": [
            [
                "2c5c8dbfe9ce6002"
            ]
        ]
    },
    {
        "id": "5dfbc19ce631c02a",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus (EVCC)",
        "topic": "mqtt.0.evcc.site.batteryMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 680,
        "y": 390,
        "wires": [
            [
                "dc2ff105f2ef41a1"
            ]
        ]
    },
    {
        "id": "d788716629c7720f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "PV Leistung",
        "topic": "alias.0.energy.pv.production",
        "attrname": "pv",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 440,
        "y": 420,
        "wires": [
            [
                "159faf93969ec050"
            ]
        ]
    },
    {
        "id": "159faf93969ec050",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "pv",
        "action": "",
        "pretty": false,
        "x": 580,
        "y": 420,
        "wires": [
            [
                "5dfbc19ce631c02a"
            ]
        ]
    },
    {
        "id": "5806d21058f968cd",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "batterySoC",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 440,
        "y": 410,
        "wires": [
            [
                "764746c9502fee95"
            ]
        ]
    },
    {
        "id": "764746c9502fee95",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batterySoC",
        "action": "",
        "pretty": false,
        "x": 610,
        "y": 410,
        "wires": [
            [
                "d788716629c7720f"
            ]
        ]
    },
    {
        "id": "f191936364ed153d",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "wirkleistung",
        "action": "",
        "pretty": false,
        "x": 590,
        "y": 410,
        "wires": [
            [
                "5806d21058f968cd"
            ]
        ]
    },
    {
        "id": "53e2d07ab02949b6",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Wirkleistung",
        "topic": "alias.0.energy.grid.consumption",
        "attrname": "wirkleistung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 450,
        "y": 410,
        "wires": [
            [
                "f191936364ed153d"
            ]
        ]
    },
    {
        "id": "aa6fd6426bbe0ba6",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "attrname": "batteryDischargeControl",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 490,
        "y": 420,
        "wires": [
            [
                "94e8607226375751"
            ]
        ]
    },
    {
        "id": "94e8607226375751",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryDischargeControl",
        "action": "",
        "pretty": false,
        "x": 680,
        "y": 420,
        "wires": [
            [
                "6c6b2182997aa6b8"
            ]
        ]
    },
    {
        "id": "f8c9422f54e835b0",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (heute)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 470,
        "y": 410,
        "wires": [
            [
                "b5e71198dc5ae830"
            ]
        ]
    },
    {
        "id": "b5e71198dc5ae830",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 640,
        "y": 410,
        "wires": [
            [
                "aa6fd6426bbe0ba6"
            ]
        ]
    },
    {
        "id": "28c07db7bcde5606",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 400,
        "wires": [
            [
                "17927d0984e777e0"
            ]
        ]
    },
    {
        "id": "17927d0984e777e0",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 650,
        "y": 400,
        "wires": [
            [
                "3608d35d36f975c3"
            ]
        ]
    },
    {
        "id": "34f2d82fc5706f00",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 460,
        "y": 390,
        "wires": [
            [
                "563e1d969c16d654"
            ]
        ]
    },
    {
        "id": "563e1d969c16d654",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 620,
        "y": 390,
        "wires": [
            [
                "28c07db7bcde5606"
            ]
        ]
    },
    {
        "id": "05edb89dd7d7472e",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeiseverfügung",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 640,
        "y": 410,
        "wires": [
            [
                "912ca24855a3f674"
            ]
        ]
    },
    {
        "id": "8b8b1251bb87ab16",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "maximaler Strompreis",
        "topic": "alias.0.energy.grid.price_max",
        "attrname": "max",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 740,
        "wires": [
            [
                "39e66cda0dae2225"
            ]
        ]
    },
    {
        "id": "dfa889a66e135fa8",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minimaler Strompreis",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "min",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 750,
        "wires": [
            [
                "78496a2fbb5f7640"
            ]
        ]
    },
    {
        "id": "39e66cda0dae2225",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "max",
        "action": "",
        "pretty": false,
        "x": 1260,
        "y": 740,
        "wires": [
            [
                "dfa889a66e135fa8"
            ]
        ]
    },
    {
        "id": "78496a2fbb5f7640",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "min",
        "action": "",
        "pretty": false,
        "x": 1260,
        "y": 750,
        "wires": [
            [
                "03b49fe377c69bbe"
            ]
        ]
    },
    {
        "id": "03b49fe377c69bbe",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "durchschnittlicher Strompreis",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1100,
        "y": 740,
        "wires": [
            [
                "0305093981230882"
            ]
        ]
    },
    {
        "id": "0305093981230882",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 1290,
        "y": 740,
        "wires": [
            [
                "61bd0c4e46d524ec"
            ]
        ]
    },
    {
        "id": "a6bc93b14557a0da",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (morgen)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "tomorrow",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 750,
        "wires": [
            [
                "6145a36701e7d2ba"
            ]
        ]
    },
    {
        "id": "6145a36701e7d2ba",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "action": "",
        "pretty": false,
        "x": 1260,
        "y": 750,
        "wires": [
            [
                "9064939ebe3c5f85"
            ]
        ]
    },
    {
        "id": "72ca4db31558f729",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "regelung",
        "action": "",
        "pretty": false,
        "x": 1210,
        "y": 750,
        "wires": [
            [
                "bd4d689a6ee2f1c9"
            ]
        ]
    },
    {
        "id": "ff7cb183f95d0506",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "attrname": "regelung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1060,
        "y": 750,
        "wires": [
            [
                "72ca4db31558f729"
            ]
        ]
    },
    {
        "id": "cc0f1c6b602b7562",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus (EVCC)",
        "topic": "mqtt.0.evcc.site.batteryMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1280,
        "y": 720,
        "wires": [
            [
                "1af8718e9bd90c29",
                "edc0368fa681ebcc"
            ]
        ]
    },
    {
        "id": "a45fc603474f123e",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "PV Leistung",
        "topic": "alias.0.energy.pv.production",
        "attrname": "pv",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1040,
        "y": 750,
        "wires": [
            [
                "5717f7ecf5b8f52f"
            ]
        ]
    },
    {
        "id": "5717f7ecf5b8f52f",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "pv",
        "action": "",
        "pretty": false,
        "x": 1180,
        "y": 750,
        "wires": [
            [
                "cc0f1c6b602b7562"
            ]
        ]
    },
    {
        "id": "81977c90c0d114e9",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "batterySoC",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1040,
        "y": 740,
        "wires": [
            [
                "2e0d5423f17f1b9f"
            ]
        ]
    },
    {
        "id": "2e0d5423f17f1b9f",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batterySoC",
        "action": "",
        "pretty": false,
        "x": 1210,
        "y": 740,
        "wires": [
            [
                "a45fc603474f123e"
            ]
        ]
    },
    {
        "id": "2805890c9723f914",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "wirkleistung",
        "action": "",
        "pretty": false,
        "x": 1190,
        "y": 740,
        "wires": [
            [
                "81977c90c0d114e9"
            ]
        ]
    },
    {
        "id": "bd4d689a6ee2f1c9",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Wirkleistung",
        "topic": "alias.0.energy.grid.consumption",
        "attrname": "wirkleistung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1050,
        "y": 740,
        "wires": [
            [
                "2805890c9723f914"
            ]
        ]
    },
    {
        "id": "69442f0a753e8da6",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "attrname": "batteryDischargeControl",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1090,
        "y": 750,
        "wires": [
            [
                "0fd2b10eb8d4e2be"
            ]
        ]
    },
    {
        "id": "0fd2b10eb8d4e2be",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryDischargeControl",
        "action": "",
        "pretty": false,
        "x": 1280,
        "y": 750,
        "wires": [
            [
                "ff7cb183f95d0506"
            ]
        ]
    },
    {
        "id": "9064939ebe3c5f85",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (heute)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1070,
        "y": 740,
        "wires": [
            [
                "2c6e29c501b93e2b"
            ]
        ]
    },
    {
        "id": "2c6e29c501b93e2b",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 1240,
        "y": 740,
        "wires": [
            [
                "69442f0a753e8da6"
            ]
        ]
    },
    {
        "id": "312daeb00936db23",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 730,
        "wires": [
            [
                "1c077a8e0c472597"
            ]
        ]
    },
    {
        "id": "1c077a8e0c472597",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 1250,
        "y": 730,
        "wires": [
            [
                "8b8b1251bb87ab16"
            ]
        ]
    },
    {
        "id": "b59fa631dda2ad45",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1060,
        "y": 720,
        "wires": [
            [
                "6b3eeb668b4f84c2"
            ]
        ]
    },
    {
        "id": "6b3eeb668b4f84c2",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 1220,
        "y": 720,
        "wires": [
            [
                "312daeb00936db23"
            ]
        ]
    },
    {
        "id": "61bd0c4e46d524ec",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeiseverfügung",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 740,
        "wires": [
            [
                "a6bc93b14557a0da"
            ]
        ]
    },
    {
        "id": "b12652c19b5a403a",
        "type": "position-config",
        "z": "batteryoptimization",
        "name": "Deutschland",
        "isValide": "true",
        "longitude": "0",
        "latitude": "0",
        "angleType": "deg",
        "timeZoneOffset": "99",
        "timeZoneDST": "0",
        "stateTimeFormat": "3",
        "stateDateFormat": "12",
        "contextStore": ""
    }    
  ]
}
