[
    {
        "id": "batteryoptimization",
        "type": "subflow",
        "name": "batteryoptimization",
        "info": "<h1>Optimierung der Verwendung des Hausspeichers im Zusammenspiel von ioBroker, evcc und einem dynamischen Stromtarif</h1><h2>Bezeichnungen für die Ausgabekanäle</h2><ul><li>1. Minimum-SoC</li><li>2. Batteriemodus</li><li>3. Netzladungspreis</li><li>4. eff.Eigenstrompreis</li><li>5. dyn.Regelungsgrenze</li><li>6. Nachrichtentext</li><li>7. letzter Netzladungspreis</li><li>8. letzte Netzladungskosten (@5kWh)</li><li>9. letzte Netzladungsmenge (@5kWh)</li><li>10. heutige Preisdifferenz</li><li>11. heutige Preiabweichung</li><li>12. erlaube Netzladung</li><li>13. erlaube Batteriesteuerung</li><li>14. verbleibender Solarertrag</li><li>15. verbleibender Strombedarf</li></ul><h2>Funktionsweise:</h2><p>Der Batteriespeicher soll bei überschüssigem PV-Strom geladen, aber nicht in Zeiten günstigen Netzstromes entladen werden. Ist die Preisdifferenz ausreichend hoch (>15ct) wird eine Netzladung zum günstigsten Zeitpunkt des Tages erwogen und die Batterie bis zum Füllstand von 80% geladen. Um die Batterie nicht ungünstig zu entladen, wird der Netzladungspreis bei der weiteren Steuerung der Batteriesperre berücksichtigt, und die Freigabe der Batterie erfolgt nur bei einem Netzstrompreis, der ausreichend über dem Netzladungspreis liegt (~130%). Die Batterie wird außerdem nur geladen, wenn Stand des Batteriespeichers ausreichend gering (<30%) ist, auch um ein Pendeln von Laden/Entladen zu vermeiden.</p><p>Die optimierte Batteriesteuerung ist nur aktiv, wenn die PV Erzeugungsleistung des aktuellen Tages geringer als der Tagesstrombedarf ist (PVgesamt prognostiziert < 17.5kWh). Eine Standardlastverteilung des Bedarfs, für einen 4 Personen-Haushalt (24h, berufstätig mit Schulkindern) und einem Stromverbrauch von etwa 15kWh / Tag ist vordefiniert. Der Strombedarf wird dabei grundsätzlich vom aktuellen Zeitpunkt bis zum nächsten Morgen (6 Uhr) bestimmt und berücksichtigt dabei den stündlichen Strombedarf der Lastverteilung.</p><p>Im Verlauf des Tages wird der noch zu erwartende PV-Ertrag bei der Steuerung berücksichtigt. Bei Verfügbarkeit des Strompreises für den kommenden Tag, sowie der entsprechenden PV-Prognose wird dies ebenfalls berücksichtgt.<p>Die Alias-Definitionen sind eingespielt (json), mit lokalen Datenwerten verknüpft und im Node erreichbar.</p><p>Es wird vorausgesetzt:</p><ul><li>aktuelle Verbrauchswerte</li><li>aktuelle und zukünftige Preisinformationen</li><li>der durchschnittliche Strompreis der letzten Woche (zur Optimierung) ermittelbar z.B. per Abfrage (AVG, group by week) aus den Werten der InfluxDB in IOBroker (ansonsten statisch vorzugeben, z.B. 0.24 Euro)</li><li>tagesaktuelle PV Prognosedaten des Gesamtertrages inkl. der Verteilung des Ertrags über den Tag</li><li>Leistungsdaten der Batterie, zur Regelung:</li><ul><li>Batteriestand (soc)</li><li>minimaler Batteriestand (minsoc)</li><li>Batterieleistungswerte (Laderegelung, intern zur Prüfung!)</li></ul></ul><p>In der Node-Konfiguration ist ebenfalls eine Grundeinstellung enthalten:</p><ul><li>Tagesverbrauch ~15kWh, Standardlastkurve</li><li>weitere Konfigurationseinstellungen, wie z.B. maximaler Ladepreis, etc.</li></ul><p>Der Knoten sollte instantiiert werden, um dann die Werte der Ausgabekanäle weiter zu verarbeiten. So wird der aktuell empfohlene Zustand für die Batteriekontrolle (normal, hold, charge) dynamisch berechnet und im ersten Ausgang ein empfohlener Wert für den minimalen Ladestand ausgegeben. Dieser ist entweder minimal, oder maximal; d.h. er legt die Grundlage für eine Batteriesperre mit anderen Mitteln, z.B. per modbus-Kontrolle.</p><p>Die evcc-Zustände haben dabei Vorrang, d.h. es wird nur im evcc-Batteriemodus unknown/normal/charge gesteuert. Gibt evcc den Modus für die Batteriesperre (hold) vor, überschreibt dieser den berechneten Mechanismus. Es wird davon ausgegangen, dass die Netzladung per evcc-Instanz unter Konfiguration des aktuellen Strompreises gestartet werden kann.</p><p>An einem anderen Ausgang wird der Strompreis (in Euro) als Grenzwert für die Netzladung zur Weitergabe als 'GridChargeLimit' an evcc ausgegeben, dies kann z.B. per HTTP- oder MQTT-API erfolgen.</p><p>Die anderen Ausgänge sind für eine mögliche Visualisierung oder Statistik sowie für weitergehende Integrationen gedacht und enthalten ergänzende Informationen.</p><p>Ohne aktivierte Batteriesteuerung und dynamischem Stromtarif ist eine Steuerung nicht möglich.</p><h2>detaillierte Beschreibung der Alias-Definitionen:</h2><table><thead><tr><th>Alias</th><th>Beschreibung</th><th>Zugriff</th><th>Typ</th></tr></thead><tbody><tr><td>energy.control.effectiveGridChargeCostLimit</td><td>aktuelle Regelgrenze für die Batteriesperre</td><td>schreibend</td><td>float</td></tr><tr><td>energy.control.enableGridcharging</td><td>erlaube die Netzladung der Batterie</td><td>schreibend</td><td>bool</td></tr><tr><td>energy.control.enableOptimization</td><td>erlaube die Steuerung der Hausbatterie</td><td>schreibend</td><td>bool</td></tr><tr><td>energy.control.lastGridChargePrice</td><td>letzter Preis für die Netzladung der Hausbatterie</td><td>schreibend</td><td>float</td></tr><tr><td></td><td></td></tr><tr><td>energy.battery.targetMode</td><td>bestimmter Batteriemodus (unknown/normal/hold/charge)</td><td>schreibend</td><td>string</td></tr><tr><td></td><td></td></tr><tr><td>energy.control.batterylock</td><td>erzwungene Batteriesperre z.B. per UI</td><td>lesend</td><td>bool</td></tr><tr><td>energy.control.gridChargeCostLimit</td><td>regelbare Preisgrenze für die Netzladung (bis 0.35€)</td><td>lesend</td><td>float</td></tr><tr><td></td><td></td></tr><tr><td>energy.battery.chargePower</td><td>aktuelle Batterieleistung</td><td>lesend</td><td>int</td></tr><tr><td>energy.battery.minsoc</td><td>aktueller minSoC der Batterie</td><td>lesend</td><td>int</td></tr><tr><td>energy.battery.soc</td><td>aktueller SoC der Batterie</td><td>lesend</td><td>int</td></tr><tr><td></td><td></td></tr><tr><td>energy.grid.consumption</td><td>aktueller Strombedarf (Zählerwert in Watt)</td><td>lesend</td><td>int</td></tr><tr><td>energy.grid.price</td><td>Strompreis (jetzt)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.prive_avg_weekly</td><td>durchschnittlicher Strompreis (historisch, 1 Woche)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_max</td><td>maximaler Strompreis (bekannt)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_min</td><td>minimaler Strompreis (bekannt)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_today</td><td>durchschnittlicher Strompreis (heute)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.price_tomorrow</td><td>durchschnittlicher Strompreis (morgen)</td><td>lesend</td><td>float</td></tr><tr><td>energy.grid.pricelevel</td><td>aktuelles Preislevel (heute) (VERY CHEAP / CHEAP / NORMAL / EXPENSIVE / VERY EXPENSIVE)</td><td>lesend</td><td>string</td></tr><tr><td>energy.grid.pricelevel_min</td><td>günstigstes Preislevel (heute) (VERY CHEAP / CHEAP / NORMAL / EXPENSIVE / VERY EXPENSIVE)</td><td>lesend</td><td>string</td></tr><tr><td></td><td></td></tr><tr><td>energy.evcc.batteryDischargeControl</td><td>Konfigurationseinstellung (evcc) der Batteriesteuerung</td><td>lesend</td><td>bool</td></tr><tr><td>energy.evcc.tariffPriceHome</td><td>aktuell kalkulierter Preis (evcc) für den Hausverbrauch</td><td>lesend</td><td>float</td></tr><tr><td></td><td></td></tr><tr><td>energy.pv.forecast_today</td><td>prog. Solarstromertrag (heute)</td><td>lesend</td><td>float</td></tr><tr><td>energy.pv.price_feedin</td><td>Einspeisevergütung (fix)</td><td>lesend</td><td>float</td></tr><tr><td>energy.pv.production</td><td>aktuelle Stromerzeugung (in Watt)</td><td>lesend</td><td>int</td></tr><tr><td>energy.pv.pvforecast_summary_JSONData</td><td>gelieferter Datensatz der Solarprognose (solcast-Format?)</td><td>lesend</td><td>json</td></tr></tbody></table></p><h2>Vorschlag zur Preisermittlung:</h2><p>Mit Hilfe eines InfluxDB Node und folgender Abfrage an die InfluxDB kann ein Veränderungen erfassender Datenwert als Grundlage herangezogen werden:</p><p><strong>SQL:</strong> <code>select mean(*) from \"tibberlink.x.xxx-yyy-zzz.CurrentPrice.total\" where time>(now() - 7d) group by time(7d) fill(none)</code></p><p>Der eigentliche Wert erhält man dann z.B. mit folgender Bearbeitung und speichert ihn z.B. in einem eigenen Datenwert dauerhaft ab:</p><h2>Beispielintegration:</h2><p>Der aufwändige Aufbau für die Steuerung der Batteriesperr(schreiben 1042 ff.) ist in diesem Beispiel nötig, um nicht konkurrierend zur evcc-Instanz mit dem modbus-Proxy zu steuern und ermöglicht eine Verallgemeinerung der Logik. Außerdem wird sichergestellt, dass die Steuerung im richtigen Kontext erfolgt und Rücksicht auf eventuelle vorherige Zustände von evcc nimmt.</p><p>Dieses Beispiel nutzt abweichend zu evcc das Register für den minimalen Ladestand der Batterie (1042), um eine PV-Ladung von überschüssigem Strom bei Batteriesperre zu ermöglichen. Da nicht zwingend ein Ladepunkt aktiv ist, der die PV Leistung abnimmt, ist dies hier von Vorteil für die optimale Verwendung des erzeugten Solarstromes.</p><p>Alternativ könnte mit den Ausgaben z.B. eine Steuerung über einen Ladepunkt (<a href=\"https://github.com/evcc-io/evcc/wiki/aaa-Lifehacks#entladung-eines-steuerbaren-hausspeicher-preisgesteuert-oder-manuell-sperren\" target=\"_blank\">Workaround</a>) oder eventuell zukünftig(!) mit Hilfe eines Parameters für eine externe Steuerung in evcc realisiert werden.</p>",
        "category": "",
        "in": [],
        "out": [
            {
                "x": 3000,
                "y": 200,
                "wires": [
                    {
                        "id": "8e9d5c079b9a05c1",
                        "port": 0
                    }
                ]
            },
            {
                "x": 2500,
                "y": 820,
                "wires": [
                    {
                        "id": "b0bb7f1a559cfbb0",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3860,
                "y": 350,
                "wires": [
                    {
                        "id": "fc114434d5bb43e8",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3860,
                "y": 450,
                "wires": [
                    {
                        "id": "19e21abe91c07f98",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3090,
                "y": 730,
                "wires": [
                    {
                        "id": "459c6ff030518f55",
                        "port": 0
                    }
                ]
            },
            {
                "x": 3850,
                "y": 630,
                "wires": [
                    {
                        "id": "2e7be69080d420a8",
                        "port": 0
                    }
                ]
            },
            {
                "x": 4360,
                "y": 1410,
                "wires": [
                    {
                        "id": "8c792e4667f487cb",
                        "port": 0
                    },
                    {
                        "id": "9dff097f0e31cacc",
                        "port": 0
                    }
                ]
            },
            {
                "x": 4170,
                "y": 1490,
                "wires": [
                    {
                        "id": "f8c28609de340239",
                        "port": 0
                    }
                ]
            },
            {
                "x": 4170,
                "y": 1550,
                "wires": [
                    {
                        "id": "7b68d1fc50e11d26",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1810,
                "y": 1530,
                "wires": [
                    {
                        "id": "2a4c42550c012995",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1820,
                "y": 1630,
                "wires": [
                    {
                        "id": "9c8f664f7922bcb1",
                        "port": 0
                    }
                ]
            },
            {
                "x": 2950,
                "y": 1470,
                "wires": [
                    {
                        "id": "0455814873ee5258",
                        "port": 0
                    }
                ]
            },
            {
                "x": 2850,
                "y": 1720,
                "wires": [
                    {
                        "id": "428cdb3e9e671729",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1850,
                "y": 1820,
                "wires": [
                    {
                        "id": "0a68fb142eff8fb6",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1570,
                "y": 2010,
                "wires": [
                    {
                        "id": "1f0a9df4c7942861",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "module": "node-red-contrib-batteryusageoptimization",
            "version": "1.0.0",
            "author": "Ingo Seeberg-Hinrichs",
            "desc": "optimizing home battery storage usage",
            "keywords": "home battery, battery storage optimization",
            "license": "MIT"
        },
        "color": "#DDAA99",
        "outputLabels": [
            "Minimum-SoC",
            "Batteriemodus",
            "Netzladungspreis",
            "eff.Eigenstrompreis",
            "dyn.Regelungsgrenze",
            "Nachrichtentext",
            "letzter Netzladungspreis",
            "letzte Netzladungskosten (@5kWh)",
            "letzte Netzladungsmenge (@5kWh)",
            "heutige Preisdifferenz",
            "heutige Preiabweichung",
            "erlaube Netzladung",
            "erlaube Batteriesteuerung",
            "verbleibender Solarertrag",
            "verbleibender Strombedarf"
        ],
        "status": {
            "x": 2480,
            "y": 750,
            "wires": [
                {
                    "id": "b0bb7f1a559cfbb0",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "0ca7f2267faf4d9f",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis (Änderung)",
        "attrname": "price",
        "topic": "alias.0.energy.grid.price",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 270,
        "y": 1150,
        "wires": [
            [
                "cc2e783c368da7c2"
            ]
        ]
    },
    {
        "id": "e340fd1f2a277a95",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Netzladungspreis",
        "topic": "0_userdata.0.Custom.Netzladungspreis",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 4370,
        "y": 1240,
        "wires": []
    },
    {
        "id": "d1d2a02f4ee2abaa",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "lastGridChargePrice",
        "topic": "alias.0.energy.control.lastGridChargePrice",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 4350,
        "y": 1340,
        "wires": []
    },
    {
        "id": "14591499bfc5f2e6",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Statistics [optional]",
        "info": "",
        "x": 4370,
        "y": 1210,
        "wires": []
    },
    {
        "id": "cac7c78ccb17baf0",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "automatische Netzladung // Laderegelung",
        "info": "",
        "x": 370,
        "y": 70,
        "wires": []
    },
    {
        "id": "81bd1c99ace1037d",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 840,
        "y": 320,
        "wires": [
            [
                "ee38e7a59b102018"
            ]
        ]
    },
    {
        "id": "408802fbf79c8ca2",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "Konfiguration",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "30 13 * * *",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 270,
        "y": 560,
        "wires": [
            [
                "d9b82b646472a4a8",
                "192e70102fef8d79",
                "ba0051fa0feeb296",
                "cca2fbfaef4db5bf"
            ]
        ]
    },
    {
        "id": "d9b82b646472a4a8",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "erlaube Netzladung",
        "topic": "alias.0.energy.control.enableGridcharging",
        "attrname": "payload",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 640,
        "y": 280,
        "wires": [
            [
                "81bd1c99ace1037d"
            ]
        ]
    },
    {
        "id": "a6dbf183ab342a7a",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "erlaube Netzladung",
        "attrname": "payload",
        "topic": "alias.0.energy.control.enableGridcharging",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 640,
        "y": 330,
        "wires": [
            [
                "81bd1c99ace1037d"
            ]
        ]
    },
    {
        "id": "ee38e7a59b102018",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "enableGridcharge",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1000,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "95de73a1f0b71cd6",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryGridChargeLimit",
                "pt": "flow",
                "to": "$round((msg.feedin/100*80),3)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "batteryGridChargeLimitLow",
                "pt": "msg",
                "to": "batteryGridChargeLimit",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "lastBatteryGridChargeLimit",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "_batteryGridChargeLimit",
                "pt": "flow",
                "to": "batteryGridChargeLimitLow",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "batteryControlLimit",
                "pt": "flow",
                "to": "(feedin*1.2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "batteryDischargeControl",
                "pt": "flow",
                "to": "batteryDischargeControl",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "today",
                "pt": "flow",
                "to": "today",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 720,
        "wires": [
            [
                "96ce1e5234f80dc8"
            ]
        ]
    },
    {
        "id": "375fa284467d45ec",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "morgiger Strompreis bekannt",
        "property": "tomorrow",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1510,
        "y": 800,
        "wires": [
            [
                "54bbcd15c1989a75"
            ],
            [
                "b61bbe7e0e8985b3"
            ]
        ]
    },
    {
        "id": "96ce1e5234f80dc8",
        "type": "special-date",
        "z": "batteryoptimization",
        "dates": [
            {
                "type": "range",
                "startDate": 1,
                "startDay": 0,
                "startMonth": 9,
                "startMonthOrdinal": 0,
                "startOrdinal": 0,
                "endDate": 15,
                "endMonth": 2,
                "offsetOrdinalBefore": 0,
                "offsetOrdinalAfter": 0,
                "response": "true"
            }
        ],
        "defaultResponse": "false",
        "messageProperty": "within",
        "name": "Wintermonate (Okt-Mar)",
        "x": 1680,
        "y": 720,
        "wires": [
            [
                "9ec16c16e5e696f4"
            ]
        ]
    },
    {
        "id": "9ec16c16e5e696f4",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "within",
        "action": "obj",
        "pretty": false,
        "x": 1860,
        "y": 720,
        "wires": [
            [
                "6ba121b78fc2db95"
            ]
        ]
    },
    {
        "id": "452b9557a830de71",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "tomorrow",
                "pt": "flow",
                "to": "tomorrow",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2000,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "6ba121b78fc2db95",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Winter?",
        "property": "within",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2000,
        "y": 720,
        "wires": [
            [
                "337713c4d73dc1e3"
            ],
            [
                "459c6ff030518f55"
            ]
        ]
    },
    {
        "id": "337713c4d73dc1e3",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzpreisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "attrname": "preisgrenze",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2170,
        "y": 660,
        "wires": [
            [
                "6dd1272661e36f05"
            ]
        ]
    },
    {
        "id": "6dd1272661e36f05",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "preisgrenze",
        "action": "",
        "pretty": false,
        "x": 2320,
        "y": 660,
        "wires": [
            [
                "de86cbd1b455b372"
            ]
        ]
    },
    {
        "id": "de86cbd1b455b372",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Mindeststrompreis für die Regelung (Winter) auswerten",
        "rules": [
            {
                "t": "set",
                "p": "gridchargecosts",
                "pt": "msg",
                "to": "lastGridChargeCost",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "tomorrow",
                "pt": "msg",
                "to": "tomorrow",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "batteryControlLimit",
                "pt": "flow",
                "to": "$max([$min([preisgrenze,today]),$min([preisgrenze,tomorrow]),gridchargecosts])",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2590,
        "y": 660,
        "wires": [
            [
                "459c6ff030518f55"
            ]
        ]
    },
    {
        "id": "b07d5fcacbf5d5c9",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Preislevel",
        "topic": "alias.0.energy.grid.pricelevel",
        "attrname": "pricelevel",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 940,
        "y": 1150,
        "wires": [
            [
                "f7592411f62c922e"
            ]
        ]
    },
    {
        "id": "192e70102fef8d79",
        "type": "trigger",
        "z": "batteryoptimization",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "2",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 610,
        "y": 570,
        "wires": [
            [
                "bd4d249d8f773300"
            ]
        ]
    },
    {
        "id": "54bbcd15c1989a75",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "morgiger Strompreis gültig",
        "property": "tomorrow",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1790,
        "y": 780,
        "wires": [
            [
                "452b9557a830de71",
                "3e5ce45ad66c449a"
            ]
        ]
    },
    {
        "id": "ba0051fa0feeb296",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 600,
        "y": 220,
        "wires": [
            [
                "e9e9d0d50f40478e"
            ]
        ]
    },
    {
        "id": "e9e9d0d50f40478e",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzpreisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "attrname": "preisgrenze",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 770,
        "y": 220,
        "wires": [
            [
                "36b2a59db464e8b1"
            ]
        ]
    },
    {
        "id": "36b2a59db464e8b1",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "preisgrenze",
        "action": "",
        "pretty": false,
        "x": 930,
        "y": 220,
        "wires": [
            [
                "9b9a7145ac0131ff"
            ]
        ]
    },
    {
        "id": "9b9a7145ac0131ff",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "tomorrow",
                "pt": "flow",
                "to": "preisgrenze",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1090,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "cca2fbfaef4db5bf",
        "type": "trigger",
        "z": "batteryoptimization",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "1",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 810,
        "y": 570,
        "wires": [
            [
                "243a05c59b711982"
            ]
        ]
    },
    {
        "id": "5d8a2e0fcab47801",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "Initialisieren",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "3d706cceaf61eec7",
                "34b02e3fa6bade9c"
            ]
        ]
    },
    {
        "id": "9b06cc1c28d6ad24",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "batteryMode",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "lastGridChargeCost",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastmessage",
                "pt": "flow",
                "to": "none",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "avgGridPriceWeekly",
                "pt": "flow",
                "to": "0.240",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1080,
        "y": 120,
        "wires": [
            [
                "4d41256f3a5efad9"
            ]
        ]
    },
    {
        "id": "3d706cceaf61eec7",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "topic": "alias.0.energy.battery.targetMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "cc86f55a5169f1ce"
            ]
        ]
    },
    {
        "id": "ba3c848534448c98",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Ladereglung aktiv?",
        "property": "regelung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1370,
        "y": 330,
        "wires": [
            [
                "a6088cc597811ce7"
            ],
            [
                "cf2427e1f89dcbf3"
            ]
        ]
    },
    {
        "id": "08410bb8caeecb49",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "Watchdog",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "20",
        "crontab": "",
        "once": true,
        "onceDelay": "20",
        "topic": "Watchdog",
        "x": 260,
        "y": 390,
        "wires": [
            [
                "f29586a895c37aef"
            ]
        ]
    },
    {
        "id": "a6088cc597811ce7",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "hold",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "normal",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1590,
        "y": 300,
        "wires": [
            [
                "9e83dc39fe9c9a7f"
            ],
            [
                "5d971017b3b0f8ea"
            ],
            [
                "cf2427e1f89dcbf3"
            ],
            [
                "cf2427e1f89dcbf3"
            ]
        ]
    },
    {
        "id": "cf2427e1f89dcbf3",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Minimum SOC",
        "topic": "alias.0.energy.battery.minsoc",
        "attrname": "minsoc",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1630,
        "y": 380,
        "wires": [
            [
                "3f9b5c8dcba0d9bb"
            ]
        ]
    },
    {
        "id": "9e83dc39fe9c9a7f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzladungsleistung (Batterie)",
        "topic": "alias.0.energy.battery.chargePower",
        "attrname": "chargePower",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1870,
        "y": 270,
        "wires": [
            [
                "f843fcc925b843b0"
            ]
        ]
    },
    {
        "id": "f843fcc925b843b0",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "chargePower",
        "action": "",
        "pretty": false,
        "x": 2070,
        "y": 270,
        "wires": [
            [
                "c846d8f5bf962cf3"
            ]
        ]
    },
    {
        "id": "c846d8f5bf962cf3",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung inaktiv",
        "property": "chargePower",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2280,
        "y": 270,
        "wires": [
            [
                "afe33ce58ba6142b"
            ],
            [
                "028d458e9a0cd968",
                "8566b3b681188747"
            ]
        ]
    },
    {
        "id": "028d458e9a0cd968",
        "type": "change",
        "z": "batteryoptimization",
        "name": "stoppen",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2510,
        "y": 230,
        "wires": [
            [
                "3bf45ef867deb08b",
                "175d838523705841",
                "933d263e7d3c8f4a"
            ]
        ]
    },
    {
        "id": "afe33ce58ba6142b",
        "type": "change",
        "z": "batteryoptimization",
        "name": "sperren",
        "rules": [
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "hold",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2510,
        "y": 180,
        "wires": [
            [
                "175d838523705841",
                "8e9d5c079b9a05c1"
            ]
        ]
    },
    {
        "id": "04e4e78058c5395c",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "klein oder verschieden?",
        "property": "minsoc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "20",
                "vt": "num"
            },
            {
                "t": "neq",
                "v": "batteryMinSoC",
                "vt": "flow"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 2310,
        "y": 380,
        "wires": [
            [],
            [
                "fda21b31d01c71a5"
            ]
        ]
    },
    {
        "id": "fda21b31d01c71a5",
        "type": "change",
        "z": "batteryoptimization",
        "name": "reset",
        "rules": [
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "batteryMinSoC",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2520,
        "y": 380,
        "wires": [
            [
                "8e9d5c079b9a05c1"
            ]
        ]
    },
    {
        "id": "5d971017b3b0f8ea",
        "type": "change",
        "z": "batteryoptimization",
        "name": "starten",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "-100",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2520,
        "y": 310,
        "wires": [
            [
                "175d838523705841",
                "02a3f73ba08b0361"
            ]
        ]
    },
    {
        "id": "3bf45ef867deb08b",
        "type": "change",
        "z": "batteryoptimization",
        "name": "stoppen, speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "_batteryGridChargeLimit",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "lastBatteryGridChargeLimit",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "parts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2750,
        "y": 350,
        "wires": [
            [
                "87262bbea50abb2c",
                "fc114434d5bb43e8"
            ]
        ]
    },
    {
        "id": "cf03f76c34779c74",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "EVCC Steuerung aktiv?",
        "property": "batteryMode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "unknown",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "normal",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "hold",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 5,
        "x": 1140,
        "y": 390,
        "wires": [
            [
                "a95d65420c7b1413"
            ],
            [
                "ba3c848534448c98"
            ],
            [
                "ba3c848534448c98"
            ],
            [
                "631a97d0c38771e6"
            ],
            [
                "5bbfcd12449b339c"
            ]
        ]
    },
    {
        "id": "5bbfcd12449b339c",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "batteryMode",
        "statusType": "msg",
        "x": 1360,
        "y": 500,
        "wires": []
    },
    {
        "id": "8566b3b681188747",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Netzladung aktiv",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2740,
        "y": 280,
        "wires": []
    },
    {
        "id": "ebadfd3637ade01b",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 620,
        "y": 1100,
        "wires": [
            [
                "cc2e783c368da7c2"
            ]
        ]
    },
    {
        "id": "4d56b342b60b1128",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung erlaubt?",
        "property": "enableGridcharge",
        "propertyType": "flow",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3360,
        "y": 390,
        "wires": [
            [
                "3bf45ef867deb08b"
            ],
            [
                "fc114434d5bb43e8"
            ]
        ]
    },
    {
        "id": "a95d65420c7b1413",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Ladereglung aktiv?",
        "property": "regelung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1370,
        "y": 200,
        "wires": [
            [
                "10a4e021653b1c1b",
                "631a97d0c38771e6"
            ],
            [
                "15732b7e51179780"
            ]
        ]
    },
    {
        "id": "15732b7e51179780",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "charge",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1600,
        "y": 230,
        "wires": [
            [
                "efde487e6a33feb6"
            ],
            [
                "028d458e9a0cd968"
            ]
        ]
    },
    {
        "id": "175d838523705841",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "targetMode",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2700,
        "y": 450,
        "wires": [
            [
                "afdd994d76468ad1",
                "0f7acb3fa69ac0b2",
                "0b77698de4b4e9f9"
            ]
        ]
    },
    {
        "id": "631a97d0c38771e6",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ändern",
        "rules": [
            {
                "t": "move",
                "p": "batteryMode",
                "pt": "msg",
                "to": "targetMode",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1580,
        "y": 460,
        "wires": [
            [
                "175d838523705841"
            ]
        ]
    },
    {
        "id": "b31e046c371f696d",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ändern",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2360,
        "y": 420,
        "wires": [
            [
                "175d838523705841"
            ]
        ]
    },
    {
        "id": "4d0917bbc1223db1",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryLock",
                "pt": "flow",
                "to": "batteryLock",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 650,
        "y": 960,
        "wires": [
            [
                "aa16438e0ea3ebe4"
            ]
        ]
    },
    {
        "id": "aa16438e0ea3ebe4",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre?",
        "property": "batteryLock",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 840,
        "y": 960,
        "wires": [
            [
                "7b60b17ec842661a"
            ],
            [
                "13b8b62b9eaaaf87"
            ]
        ]
    },
    {
        "id": "df55c9f3d596a61b",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Sperre setzen",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "hold",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 960,
        "wires": [
            [
                "4dc689fde6785965",
                "a6088cc597811ce7"
            ]
        ]
    },
    {
        "id": "7b60b17ec842661a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung?",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1050,
        "y": 930,
        "wires": [
            [],
            [
                "df55c9f3d596a61b"
            ]
        ]
    },
    {
        "id": "13b8b62b9eaaaf87",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung?",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1050,
        "y": 1010,
        "wires": [
            [],
            [
                "6a2cd76930a5fd38"
            ]
        ]
    },
    {
        "id": "6a2cd76930a5fd38",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Sperre aufheben",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "normal",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "soc",
                "pt": "msg",
                "to": "batteryMinSoC",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1250,
        "y": 1030,
        "wires": [
            [
                "a6088cc597811ce7"
            ]
        ]
    },
    {
        "id": "7a8d8d424d68a573",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 520,
        "y": 960,
        "wires": [
            [
                "4d0917bbc1223db1"
            ]
        ]
    },
    {
        "id": "2e7be69080d420a8",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Batteriemodus Info speichern",
        "rules": [
            {
                "t": "set",
                "p": "lastmessage",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3510,
        "y": 630,
        "wires": [
            []
        ]
    },
    {
        "id": "afdd994d76468ad1",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Batterienetzladung Info",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Batteriemodus",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2950,
        "y": 630,
        "wires": [
            [
                "5cd1f6b47241166b"
            ]
        ]
    },
    {
        "id": "c5ced2bd83ac2c51",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "lastmessage",
                "vt": "flow"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3290,
        "y": 630,
        "wires": [
            [
                "2e7be69080d420a8"
            ]
        ]
    },
    {
        "id": "5cd1f6b47241166b",
        "type": "function",
        "z": "batteryoptimization",
        "name": "Nachricht",
        "func": "var message = msg.payload\n\nmsg.payload = msg.topic + ': ' + message\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 3140,
        "y": 630,
        "wires": [
            [
                "c5ced2bd83ac2c51"
            ]
        ]
    },
    {
        "id": "f7592411f62c922e",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "soc",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1090,
        "y": 1150,
        "wires": [
            [
                "95de237bb4849b84"
            ]
        ]
    },
    {
        "id": "95de237bb4849b84",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "soc",
        "action": "",
        "pretty": false,
        "x": 1230,
        "y": 1150,
        "wires": [
            [
                "48fbf17e440c6e46",
                "b7153589e296ee99",
                "0089f265d90a0fdb"
            ]
        ]
    },
    {
        "id": "65e098312d3c4113",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minTotal",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "minTotal",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2720,
        "y": 830,
        "wires": [
            [
                "c876479b259c7fbd"
            ]
        ]
    },
    {
        "id": "0a04be90c5d96c53",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "günstigster Preis heute",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "minTotal",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3040,
        "y": 870,
        "wires": [
            [
                "fd9b7d377fc46ec8"
            ],
            [
                "3ecbf2f467208bff"
            ]
        ]
    },
    {
        "id": "8636f0bd3b4538d0",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Preislevel",
        "property": "pricelevel",
        "propertyType": "msg",
        "rules": [
            {
                "t": "cont",
                "v": "CHEAP",
                "vt": "str"
            },
            {
                "t": "cont",
                "v": "NORMAL",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1880,
        "y": 1060,
        "wires": [
            [
                "7a304dcef50bb502"
            ],
            [
                "7260dd4c549cdb5c"
            ],
            [
                "c414bb4b213a1888"
            ]
        ]
    },
    {
        "id": "9e415d6399fdbe4a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand hoch (>80)",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "80",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1620,
        "y": 1150,
        "wires": [
            [
                "c414bb4b213a1888"
            ],
            [
                "752a4e50a052e88c"
            ]
        ]
    },
    {
        "id": "752a4e50a052e88c",
        "type": "special-date",
        "z": "batteryoptimization",
        "dates": [
            {
                "type": "range",
                "startDate": 15,
                "startDay": 0,
                "startMonth": 9,
                "startMonthOrdinal": 0,
                "startOrdinal": 0,
                "endDate": 15,
                "endMonth": 2,
                "offsetOrdinalBefore": 0,
                "offsetOrdinalAfter": 0,
                "response": "true"
            }
        ],
        "defaultResponse": "false",
        "messageProperty": "within",
        "name": "Wintermonate (Okt-Mar)",
        "x": 1700,
        "y": 1200,
        "wires": [
            [
                "216e67bfae933401"
            ]
        ]
    },
    {
        "id": "216e67bfae933401",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "within",
        "action": "obj",
        "pretty": false,
        "x": 1870,
        "y": 1200,
        "wires": [
            [
                "f3f71e46fe5582dd"
            ]
        ]
    },
    {
        "id": "f3f71e46fe5582dd",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Winter?",
        "property": "within",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2020,
        "y": 1200,
        "wires": [
            [
                "0e89599a6052928f"
            ],
            [
                "c414bb4b213a1888"
            ]
        ]
    },
    {
        "id": "0e89599a6052928f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "pvforecast today",
        "topic": "alias.0.energy.pv.forecast_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2170,
        "y": 1150,
        "wires": [
            [
                "7a9c3651fe929620"
            ]
        ]
    },
    {
        "id": "7a9c3651fe929620",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 2320,
        "y": 1150,
        "wires": [
            [
                "8ae42f2a09f534fc"
            ]
        ]
    },
    {
        "id": "332d680bdc7a0e72",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_today",
                "pt": "flow",
                "to": "today",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "reqSolar",
                "pt": "msg",
                "to": "10000 - (msg.soc / 100 * 10000)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "reqSolar",
                "pt": "flow",
                "to": "reqSolar",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2800,
        "y": 1110,
        "wires": [
            [
                "c844e8ac9798621a"
            ]
        ]
    },
    {
        "id": "8ae42f2a09f534fc",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "ae76f576df22109b",
        "startTime": "civilDawn",
        "startTimeType": "pdsTime",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "civilDusk",
        "endTimeType": "pdsTime",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 2530,
        "y": 1160,
        "wires": [
            [
                "332d680bdc7a0e72"
            ],
            [
                "31527b27d39fb81b"
            ]
        ]
    },
    {
        "id": "c844e8ac9798621a",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "zu wenig Restertrag (PV)",
        "property": "pvforecast_now",
        "propertyType": "flow",
        "rules": [
            {
                "t": "lt",
                "v": "reqSolar",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3000,
        "y": 1110,
        "wires": [
            [
                "8636f0bd3b4538d0"
            ],
            [
                "c414bb4b213a1888"
            ]
        ]
    },
    {
        "id": "c414bb4b213a1888",
        "type": "change",
        "z": "batteryoptimization",
        "name": "normal",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "normal",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2930,
        "y": 1280,
        "wires": [
            [
                "b0c3f158236c14aa"
            ]
        ]
    },
    {
        "id": "16a7dbcc461644af",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand niedrig",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "enableGridChargeThreshold",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2090,
        "y": 940,
        "wires": [
            [
                "5b1c728a207de517"
            ],
            [
                "7e88298291c7bae6"
            ]
        ]
    },
    {
        "id": "7260dd4c549cdb5c",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "innerhalb Preisgrenze",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "batteryControlLimit",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2090,
        "y": 1050,
        "wires": [
            [
                "10d75fdaed719dc9"
            ],
            [
                "c414bb4b213a1888"
            ]
        ]
    },
    {
        "id": "5b1c728a207de517",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minLevel",
        "topic": "alias.0.energy.grid.privelevel_min",
        "attrname": "minLevel",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2480,
        "y": 910,
        "wires": [
            [
                "eb7e2afa2fa421e6"
            ]
        ]
    },
    {
        "id": "eb7e2afa2fa421e6",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Preislevel",
        "property": "minLevel",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "pricelevel",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2630,
        "y": 910,
        "wires": [
            [
                "65e098312d3c4113"
            ],
            [
                "3ecbf2f467208bff"
            ]
        ]
    },
    {
        "id": "177633d2fe31905d",
        "type": "change",
        "z": "batteryoptimization",
        "name": "hold",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "hold",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3640,
        "y": 1080,
        "wires": [
            [
                "364662ed40f91a94"
            ]
        ]
    },
    {
        "id": "187ffec7a2f1c8fe",
        "type": "change",
        "z": "batteryoptimization",
        "name": "charge",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "charge",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3750,
        "y": 960,
        "wires": [
            [
                "364662ed40f91a94",
                "fd53e58c2b144983"
            ]
        ]
    },
    {
        "id": "7e88298291c7bae6",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladen aktiv?",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2330,
        "y": 980,
        "wires": [
            [
                "91790c49ec98d0b7"
            ],
            [
                "177633d2fe31905d"
            ]
        ]
    },
    {
        "id": "91790c49ec98d0b7",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand ausreichend",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "disableGridChargeThreshold",
                "vt": "flow"
            },
            {
                "t": "lt",
                "v": "90",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 3,
        "x": 2570,
        "y": 970,
        "wires": [
            [
                "5b1c728a207de517"
            ],
            [
                "1a019874d45c35f6"
            ],
            [
                "177633d2fe31905d",
                "8e3e52c0a5ac852e"
            ]
        ]
    },
    {
        "id": "fd9b7d377fc46ec8",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladen erlaubt?",
        "property": "enableGridcharge",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3300,
        "y": 880,
        "wires": [
            [
                "187ffec7a2f1c8fe",
                "61cdd5b038f45f5c"
            ],
            [
                "177633d2fe31905d"
            ]
        ]
    },
    {
        "id": "31527b27d39fb81b",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "PV ungenügend (Bedarf)",
        "property": "pvforecast_now",
        "propertyType": "flow",
        "rules": [
            {
                "t": "lt",
                "v": "energy_req",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2810,
        "y": 1190,
        "wires": [
            [
                "8636f0bd3b4538d0"
            ],
            [
                "c414bb4b213a1888"
            ]
        ]
    },
    {
        "id": "364662ed40f91a94",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "price",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3800,
        "y": 1080,
        "wires": [
            [
                "64c5b53285f569dc",
                "8770d7314271a9b8",
                "e340fd1f2a277a95"
            ]
        ]
    },
    {
        "id": "8232cf93044f08b7",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "tariffPriceHome",
        "topic": "alias.0.energy.evcc.tariffPriceHome",
        "attrname": "payload",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 3810,
        "y": 1310,
        "wires": [
            [
                "64c5b53285f569dc",
                "8770d7314271a9b8",
                "e340fd1f2a277a95"
            ]
        ]
    },
    {
        "id": "64c5b53285f569dc",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden",
        "property": "batteryMode",
        "propertyType": "flow",
        "rules": [
            {
                "t": "neq",
                "v": "targetMode",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 4110,
        "y": 1150,
        "wires": [
            [
                "d32460660cf0c2ba",
                "832d708ea4bc32c4"
            ]
        ]
    },
    {
        "id": "d32460660cf0c2ba",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Zeitstempel",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "ts",
        "targetType": "msg",
        "statusVal": "ts",
        "statusType": "msg",
        "x": 4230,
        "y": 1100,
        "wires": []
    },
    {
        "id": "7a304dcef50bb502",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "innerhalb Preisgrenze",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "batteryControlLimit",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2090,
        "y": 1010,
        "wires": [
            [
                "16a7dbcc461644af"
            ],
            [
                "c414bb4b213a1888"
            ]
        ]
    },
    {
        "id": "10a4e021653b1c1b",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "EVCC darf eigenständig laden (GUI)",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1650,
        "y": 100,
        "wires": []
    },
    {
        "id": "933d263e7d3c8f4a",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Zeitstempel",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "ts",
        "statusType": "msg",
        "x": 2720,
        "y": 100,
        "wires": []
    },
    {
        "id": "87262bbea50abb2c",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Zeitstempel",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "ts",
        "statusType": "msg",
        "x": 2950,
        "y": 310,
        "wires": []
    },
    {
        "id": "ff303daf71a4fb66",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Entladung vermeiden",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2470,
        "y": 140,
        "wires": [
            [
                "8e9d5c079b9a05c1"
            ]
        ]
    },
    {
        "id": "efde487e6a33feb6",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Netzladung aktiv",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1820,
        "y": 140,
        "wires": [
            [
                "ff303daf71a4fb66"
            ]
        ]
    },
    {
        "id": "f4938288abfd68ef",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre (UI) aktiv?",
        "property": "batteryLock",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1990,
        "y": 380,
        "wires": [
            [
                "78a271aaba1631b2"
            ],
            [
                "04e4e78058c5395c",
                "b31e046c371f696d"
            ]
        ]
    },
    {
        "id": "1aa1822a4b5c3968",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre (UI) aktiv?",
        "property": "batteryLock",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3410,
        "y": 1390,
        "wires": [
            [
                "177633d2fe31905d"
            ],
            [
                "8232cf93044f08b7",
                "a9e01baeb225b294"
            ]
        ]
    },
    {
        "id": "78a271aaba1631b2",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ändern",
        "rules": [
            {
                "t": "set",
                "p": "targetMode",
                "pt": "msg",
                "to": "hold",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2360,
        "y": 340,
        "wires": [
            [
                "ff303daf71a4fb66",
                "175d838523705841"
            ]
        ]
    },
    {
        "id": "3f9b5c8dcba0d9bb",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "minsoc",
        "action": "",
        "pretty": false,
        "x": 1780,
        "y": 380,
        "wires": [
            [
                "f4938288abfd68ef"
            ]
        ]
    },
    {
        "id": "35d1d7b7611ee648",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "günstiger als Preisgrenze?",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "gridlimit",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3270,
        "y": 930,
        "wires": [
            [
                "fd9b7d377fc46ec8"
            ],
            [
                "177633d2fe31905d"
            ]
        ]
    },
    {
        "id": "3ecbf2f467208bff",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Netzladungspreisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "attrname": "gridlimit",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2870,
        "y": 920,
        "wires": [
            [
                "16ab2dd6380d4020"
            ]
        ]
    },
    {
        "id": "16ab2dd6380d4020",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "gridlimit",
        "action": "",
        "pretty": false,
        "x": 3050,
        "y": 920,
        "wires": [
            [
                "35d1d7b7611ee648"
            ]
        ]
    },
    {
        "id": "9fb0abe7f4bcd106",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Dauer",
        "rules": [
            {
                "t": "set",
                "p": "now",
                "pt": "msg",
                "to": "",
                "tot": "date"
            },
            {
                "t": "set",
                "p": "last",
                "pt": "msg",
                "to": "batteryModeTS",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "diff",
                "pt": "msg",
                "to": "now - last",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "batteryModeTS",
                "pt": "flow",
                "to": "",
                "tot": "date"
            },
            {
                "t": "set",
                "p": "lastBatteryMode",
                "pt": "msg",
                "to": "batteryMode",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3500,
        "y": 1480,
        "wires": [
            [
                "877483b415fd8ff6",
                "c28d58aae702604e"
            ]
        ]
    },
    {
        "id": "877483b415fd8ff6",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Dauer",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "diff",
        "statusType": "msg",
        "x": 3670,
        "y": 1440,
        "wires": []
    },
    {
        "id": "c28d58aae702604e",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzladung",
        "property": "batteryMode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "charge",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3690,
        "y": 1480,
        "wires": [
            [
                "f8c28609de340239",
                "7b68d1fc50e11d26"
            ]
        ]
    },
    {
        "id": "f8c28609de340239",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "costs",
                "pt": "msg",
                "to": "chargePrice",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round($number(msg.diff)/3600/1000*$number(msg.costs)*5)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "chargeCosts",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "costs",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "(costs*1.2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3910,
        "y": 1480,
        "wires": [
            [
                "8c792e4667f487cb",
                "975e675b4a84f887",
                "243a05c59b711982"
            ]
        ]
    },
    {
        "id": "8770d7314271a9b8",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "topic": "alias.0.energy.battery.targetMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 4060,
        "y": 1270,
        "wires": [
            [
                "20f353135da2a533"
            ]
        ]
    },
    {
        "id": "20f353135da2a533",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden",
        "property": "batteryMode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "targetMode",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3350,
        "y": 1480,
        "wires": [
            [
                "9fb0abe7f4bcd106"
            ]
        ]
    },
    {
        "id": "832d708ea4bc32c4",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "targetMode",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 4400,
        "y": 1150,
        "wires": [
            []
        ]
    },
    {
        "id": "7b68d1fc50e11d26",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round(($number(msg.diff)/3600/1000*5),3)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "gridEnergy",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3910,
        "y": 1540,
        "wires": [
            [
                "fe93b924a6278cdd"
            ]
        ]
    },
    {
        "id": "7c25098ed584b4b4",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "",
        "props": [
            {
                "p": "costs",
                "v": "0.30",
                "vt": "str"
            },
            {
                "p": "diff",
                "v": "3960000",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 3280,
        "y": 1520,
        "wires": [
            [
                "1d252f8f703b735f"
            ]
        ]
    },
    {
        "id": "a9e01baeb225b294",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Kosten ausgeglichen",
        "property": "(msg.price*1.2)",
        "propertyType": "jsonata",
        "rules": [
            {
                "t": "lte",
                "v": "lastCosts",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3700,
        "y": 1270,
        "wires": [
            [
                "df2a3c40a98e217b"
            ],
            [
                "d62d61264ca8d197"
            ]
        ]
    },
    {
        "id": "b7153589e296ee99",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batterieladung erschöpft (<10)",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "10",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1370,
        "y": 1250,
        "wires": [
            [
                "7da7e1698a4448a4"
            ]
        ]
    },
    {
        "id": "c508d2c5de19c22c",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "(msg.feedin*1.2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1950,
        "y": 1250,
        "wires": [
            [
                "9dff097f0e31cacc"
            ]
        ]
    },
    {
        "id": "7da7e1698a4448a4",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "topic": "alias.0.energy.pv.price_feedin",
        "attrname": "_feedin",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1620,
        "y": 1250,
        "wires": [
            [
                "7f79e150bda8920e"
            ]
        ]
    },
    {
        "id": "7f79e150bda8920e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "_feedin",
        "action": "",
        "pretty": false,
        "x": 1780,
        "y": 1250,
        "wires": [
            [
                "c508d2c5de19c22c"
            ]
        ]
    },
    {
        "id": "df2a3c40a98e217b",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Kostenausgleich",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "(msg.price*1.2)",
        "statusType": "jsonata",
        "x": 4240,
        "y": 980,
        "wires": []
    },
    {
        "id": "d62d61264ca8d197",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Kostendifferenz",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "(msg.price*1.2)",
        "statusType": "jsonata",
        "x": 4240,
        "y": 1040,
        "wires": []
    },
    {
        "id": "10d75fdaed719dc9",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "günstiger als Preisgrenze?",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "gridlimit",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2480,
        "y": 1040,
        "wires": [
            [
                "16a7dbcc461644af"
            ],
            [
                "177633d2fe31905d"
            ]
        ]
    },
    {
        "id": "cc2e783c368da7c2",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 780,
        "y": 1150,
        "wires": [
            [
                "b07d5fcacbf5d5c9"
            ]
        ]
    },
    {
        "id": "c876479b259c7fbd",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "minTotal",
        "action": "",
        "pretty": false,
        "x": 2850,
        "y": 830,
        "wires": [
            [
                "a9db3774f85566cd"
            ]
        ]
    },
    {
        "id": "574ea5c6840e29b7",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "(0.079*1.2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "(0.32*1.2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 620,
        "y": 900,
        "wires": [
            []
        ]
    },
    {
        "id": "fd53e58c2b144983",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "chargePrice",
                "pt": "flow",
                "to": "price",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3930,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "1d252f8f703b735f",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "chargePrice",
                "pt": "flow",
                "to": "$number(costs)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3470,
        "y": 1520,
        "wires": [
            [
                "c28d58aae702604e"
            ]
        ]
    },
    {
        "id": "48fbf17e440c6e46",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batterie ausreichend (>90)",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "90",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1360,
        "y": 1300,
        "wires": [
            [
                "7da7e1698a4448a4"
            ]
        ]
    },
    {
        "id": "459c6ff030518f55",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "batteryControlLimit",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2890,
        "y": 720,
        "wires": [
            [
                "7d9342e96f8c7c2c"
            ]
        ]
    },
    {
        "id": "6b6381594a1f3c53",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "täglich",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "10 00 * * *",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 1410,
        "wires": [
            [
                "d0c989feecd0d50b"
            ]
        ]
    },
    {
        "id": "f59b13d46245cc77",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Differenz",
        "rules": [
            {
                "t": "set",
                "p": "diff",
                "pt": "msg",
                "to": "max-min",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "spreizung",
                "pt": "msg",
                "to": "$round($max([(avg-min),(max-avg)]),3)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1410,
        "wires": [
            [
                "035b47fb638c7436",
                "6f92962f2db4978f"
            ]
        ]
    },
    {
        "id": "6f92962f2db4978f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "pvforecast today",
        "topic": "alias.0.energy.pv.forecast_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 950,
        "y": 1410,
        "wires": [
            [
                "c3c3e007a20a3be4"
            ]
        ]
    },
    {
        "id": "c3c3e007a20a3be4",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 1330,
        "y": 1410,
        "wires": [
            [
                "0a27272eb30e5a3c",
                "ab7678946aa41d3f",
                "2a4c42550c012995",
                "2bd5fbd5d873ea4c",
                "9c8f664f7922bcb1"
            ]
        ]
    },
    {
        "id": "0a27272eb30e5a3c",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "PV < 16kW",
        "property": "today",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "pvMinimumRequired",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1540,
        "y": 1410,
        "wires": [
            [
                "46ae5c8cdfd859da"
            ],
            [
                "a69a0c7321138ee6"
            ]
        ]
    },
    {
        "id": "46ae5c8cdfd859da",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Preisspanne",
        "property": "diff",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "minPriceDifference",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 1730,
        "y": 1370,
        "wires": [
            [
                "c70f212ee99fbcb6",
                "b5b329a47af20121"
            ],
            [
                "e8a3cbfd44c03754"
            ]
        ]
    },
    {
        "id": "a69a0c7321138ee6",
        "type": "change",
        "z": "batteryoptimization",
        "name": "nicht optimieren",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2190,
        "y": 1570,
        "wires": [
            [
                "00d7dce2e42e6928",
                "d8ade5f1360b8989",
                "428cdb3e9e671729"
            ]
        ]
    },
    {
        "id": "b5b329a47af20121",
        "type": "change",
        "z": "batteryoptimization",
        "name": "optimieren",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2180,
        "y": 1440,
        "wires": [
            [
                "048549a276cd3dd1",
                "428cdb3e9e671729"
            ]
        ]
    },
    {
        "id": "d8ade5f1360b8989",
        "type": "change",
        "z": "batteryoptimization",
        "name": "ohne Netzladung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2400,
        "y": 1400,
        "wires": [
            [
                "048549a276cd3dd1",
                "0455814873ee5258"
            ]
        ]
    },
    {
        "id": "46ca38192991889d",
        "type": "change",
        "z": "batteryoptimization",
        "name": "mit Netzladung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2410,
        "y": 1350,
        "wires": [
            [
                "1291e4b6fbeab45f",
                "0455814873ee5258"
            ]
        ]
    },
    {
        "id": "c70f212ee99fbcb6",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "PV < 10kW",
        "property": "today",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "10000",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2180,
        "y": 1360,
        "wires": [
            [
                "46ca38192991889d"
            ],
            [
                "d8ade5f1360b8989"
            ]
        ]
    },
    {
        "id": "ab7678946aa41d3f",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Differenz",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "$round((diff*100),1)",
        "statusType": "jsonata",
        "x": 1530,
        "y": 1470,
        "wires": []
    },
    {
        "id": "2a4c42550c012995",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Differenz in ct",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round((diff*100),1)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1550,
        "y": 1530,
        "wires": [
            []
        ]
    },
    {
        "id": "048549a276cd3dd1",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Modus \"Kappung\"",
        "rules": [
            {
                "t": "set",
                "p": "mode",
                "pt": "flow",
                "to": "LIMIT",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2680,
        "y": 1570,
        "wires": [
            []
        ]
    },
    {
        "id": "1291e4b6fbeab45f",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Modus \"Netzladung\"",
        "rules": [
            {
                "t": "set",
                "p": "mode",
                "pt": "flow",
                "to": "GRID",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2690,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "00d7dce2e42e6928",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Modus \"normal\"",
        "rules": [
            {
                "t": "set",
                "p": "mode",
                "pt": "flow",
                "to": "NORMAL",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2670,
        "y": 1620,
        "wires": [
            []
        ]
    },
    {
        "id": "2bd5fbd5d873ea4c",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Abweichung",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "$round((spreizung*100),1)",
        "statusType": "jsonata",
        "x": 1540,
        "y": 1580,
        "wires": []
    },
    {
        "id": "e8a3cbfd44c03754",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Spreizung",
        "property": "spreizung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "minPriceDeviation",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 1920,
        "y": 1440,
        "wires": [
            [
                "b5b329a47af20121",
                "d8ade5f1360b8989"
            ],
            [
                "3c12175176eff182"
            ]
        ]
    },
    {
        "id": "9c8f664f7922bcb1",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Abweichung in ct",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round((spreizung*100),1)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1560,
        "y": 1630,
        "wires": [
            []
        ]
    },
    {
        "id": "02a3f73ba08b0361",
        "type": "change",
        "z": "batteryoptimization",
        "name": "starten, speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "price",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastBatteryGridChargeLimit",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "ts",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2750,
        "y": 400,
        "wires": [
            [
                "a0738485abf9ef36"
            ]
        ]
    },
    {
        "id": "047b1d6da0d579e1",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "verbleibender Strompreis (avg)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 3930,
        "y": 870,
        "wires": [
            [
                "1da6f1f8f5f2ea98"
            ]
        ]
    },
    {
        "id": "1da6f1f8f5f2ea98",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 4160,
        "y": 870,
        "wires": [
            [
                "e79fdb3cc388fc70"
            ]
        ]
    },
    {
        "id": "092c06d9b35d1733",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "morgiger Strompreis (avg)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 3910,
        "y": 820,
        "wires": [
            [
                "9e9385f837835775"
            ]
        ]
    },
    {
        "id": "9e9385f837835775",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 4160,
        "y": 820,
        "wires": [
            [
                "e79fdb3cc388fc70"
            ]
        ]
    },
    {
        "id": "2eefed6e0ae1e556",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten",
        "rules": [
            {
                "t": "set",
                "p": "costs",
                "pt": "msg",
                "to": "(price*1.25)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3720,
        "y": 870,
        "wires": [
            [
                "047b1d6da0d579e1"
            ]
        ]
    },
    {
        "id": "168de14375987317",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten",
        "rules": [
            {
                "t": "set",
                "p": "costs",
                "pt": "msg",
                "to": "(price*1.25)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3720,
        "y": 820,
        "wires": [
            [
                "092c06d9b35d1733"
            ]
        ]
    },
    {
        "id": "61cdd5b038f45f5c",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "ae76f576df22109b",
        "startTime": "civilDusk",
        "startTimeType": "pdsTime",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "23:59",
        "endTimeType": "entered",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 3530,
        "y": 850,
        "wires": [
            [
                "168de14375987317"
            ],
            [
                "2eefed6e0ae1e556"
            ]
        ]
    },
    {
        "id": "e79fdb3cc388fc70",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "geringer",
        "property": "costs",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "avg",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3590,
        "y": 980,
        "wires": [
            [
                "187ffec7a2f1c8fe"
            ],
            [
                "177633d2fe31905d"
            ]
        ]
    },
    {
        "id": "a0738485abf9ef36",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "zu teuer",
        "property": "price",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "maximumGridPrice",
                "vt": "flow"
            },
            {
                "t": "gte",
                "v": "maximumGridPrice",
                "vt": "flow"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2920,
        "y": 400,
        "wires": [
            [
                "4d56b342b60b1128"
            ],
            [
                "3bf45ef867deb08b"
            ]
        ]
    },
    {
        "id": "cc86f55a5169f1ce",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "lastGridChargeCost",
        "topic": "alias.0.energy.control.lastGridChargePrice",
        "attrname": "lastGridChargeCost",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 750,
        "y": 120,
        "wires": [
            [
                "49b4b9664c8241cc"
            ]
        ]
    },
    {
        "id": "49b4b9664c8241cc",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "lastGridChargeCost",
        "action": "",
        "pretty": false,
        "x": 910,
        "y": 120,
        "wires": [
            [
                "9b06cc1c28d6ad24"
            ]
        ]
    },
    {
        "id": "8c792e4667f487cb",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "lastGridChargeCost",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round(msg.payload*1.1,3)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 4080,
        "y": 1440,
        "wires": [
            [
                "d1d2a02f4ee2abaa"
            ]
        ]
    },
    {
        "id": "3c12175176eff182",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "vorherige Ladungskosten",
        "property": "avg",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "batteryControlLimit",
                "vt": "flow"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2120,
        "y": 1500,
        "wires": [
            [
                "b5b329a47af20121",
                "d8ade5f1360b8989"
            ],
            [
                "a69a0c7321138ee6"
            ]
        ]
    },
    {
        "id": "5260639947443715",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 350,
        "y": 1060,
        "wires": [
            [
                "ebadfd3637ade01b"
            ]
        ]
    },
    {
        "id": "513d1beded9428d8",
        "type": "function",
        "z": "batteryoptimization",
        "name": "map",
        "func": "const millis = msg.millis = new Date().getTime();\nmsg.diff = millis - msg.lastchange;\n\nconst current = msg.current = new Date().getHours();\nconst offset = msg.offset = (new Date().getTimezoneOffset())/60;\n//const hour = msg.hour = new Date(msg.lastchange).getHours();\nconst hour = msg.hour = (new Date(msg.payload.estimations[0].t).getHours()+offset);\nconst n = 24-hour;\nconst h = current - hour;\n\nconst today = msg.today = msg.payload.estimations.map(estimation => estimation.y).slice(0,(n*2));\nconst remain = msg.remain =  today.slice((h*2)); \nmsg.payload = remain;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1210,
        "y": 1760,
        "wires": [
            [
                "ce143c1509725efd"
            ]
        ]
    },
    {
        "id": "96c3554d6f84d912",
        "type": "change",
        "z": "batteryoptimization",
        "name": "move",
        "rules": [
            {
                "t": "set",
                "p": "pvForecastJSON",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "payload.estimations",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1050,
        "y": 1760,
        "wires": [
            [
                "513d1beded9428d8"
            ]
        ]
    },
    {
        "id": "bcba6ee2374b8f2d",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 920,
        "y": 1760,
        "wires": [
            [
                "96c3554d6f84d912"
            ]
        ]
    },
    {
        "id": "ce143c1509725efd",
        "type": "calculator",
        "z": "batteryoptimization",
        "name": "",
        "inputMsgField": "payload",
        "outputMsgField": "sum",
        "operation": "sum",
        "constant": "",
        "round": false,
        "decimals": 0,
        "x": 1340,
        "y": 1760,
        "wires": [
            [
                "e25788c6e5d62038"
            ]
        ]
    },
    {
        "id": "e25788c6e5d62038",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_now",
                "pt": "flow",
                "to": "(sum/2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1490,
        "y": 1760,
        "wires": [
            [
                "0a68fb142eff8fb6"
            ]
        ]
    },
    {
        "id": "e519231127e35cac",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "ae76f576df22109b",
        "startTime": "0:00",
        "startTimeType": "entered",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "civilDusk",
        "endTimeType": "pdsTime",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 510,
        "y": 1780,
        "wires": [
            [
                "c57a3be809baa34e"
            ],
            [
                "ec2612e6c961596a"
            ]
        ]
    },
    {
        "id": "c57a3be809baa34e",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "JSONData",
        "topic": "alias.0.energy.pv.pvforecast_summary_JSONData",
        "attrname": "payload",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 750,
        "y": 1770,
        "wires": [
            [
                "bcba6ee2374b8f2d"
            ]
        ]
    },
    {
        "id": "ec2612e6c961596a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "kein Ertrag",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_now",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 1820,
        "wires": [
            [
                "0a68fb142eff8fb6"
            ]
        ]
    },
    {
        "id": "0a68fb142eff8fb6",
        "type": "change",
        "z": "batteryoptimization",
        "name": "laden",
        "rules": [
            {
                "t": "set",
                "p": "pvforecast_now",
                "pt": "msg",
                "to": "pvforecast_now",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "(pvforecast_now/1000)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1640,
        "y": 1820,
        "wires": [
            []
        ]
    },
    {
        "id": "1561515e5801298e",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "stündlich",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "3600",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 310,
        "y": 1780,
        "wires": [
            [
                "e519231127e35cac"
            ]
        ]
    },
    {
        "id": "158f94c79cfa0d94",
        "type": "function",
        "z": "batteryoptimization",
        "name": "remain",
        "func": "const current = msg.current = new Date().getHours();\nconst n = 24-current;\nconst h = current;\nconst t = 8;\nmsg.n=n;\n\nmsg.tomorrow = msg.lastprofil;\n\nconst remain = msg.remain =  msg.lastprofil.slice(h);\nconst tomorrow = msg.remain2 = msg.tomorrow.slice(0,t);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 1990,
        "wires": [
            [
                "1968f4fa9fc74dec"
            ]
        ]
    },
    {
        "id": "31cd267b38c8f908",
        "type": "calculator",
        "z": "batteryoptimization",
        "name": "verbleibend (heute)",
        "inputMsgField": "remain",
        "outputMsgField": "sum",
        "operation": "sum",
        "constant": "",
        "round": false,
        "decimals": 0,
        "x": 920,
        "y": 1970,
        "wires": [
            [
                "97cd34a498ab3567"
            ]
        ]
    },
    {
        "id": "1f0a9df4c7942861",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round((sum + sum2)*1000,2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "energy_req",
                "pt": "flow",
                "to": "$round((payload),2)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "energy_req_today",
                "pt": "flow",
                "to": "$round((sum*1000),2)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1330,
        "y": 2010,
        "wires": [
            []
        ]
    },
    {
        "id": "86af04c2bc82c4df",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "initialisieren (~500W/h)",
        "props": [
            {
                "p": "lastprofil",
                "v": "[0.4,0.4,0.4,0.4,0.4,0.4,1,1,0.4,0.4,0.4,0.4,1,1,0.4,0.4,0.4,1,1,1,1,1,0.4,0.4]",
                "vt": "jsonata"
            }
        ],
        "repeat": "600",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "x": 350,
        "y": 1990,
        "wires": [
            [
                "158f94c79cfa0d94"
            ]
        ]
    },
    {
        "id": "97cd34a498ab3567",
        "type": "calculator",
        "z": "batteryoptimization",
        "name": "verbleibend (morgen)",
        "inputMsgField": "remain2",
        "outputMsgField": "sum2",
        "operation": "sum",
        "constant": "",
        "round": false,
        "decimals": 0,
        "x": 1150,
        "y": 2010,
        "wires": [
            [
                "1f0a9df4c7942861"
            ]
        ]
    },
    {
        "id": "1a019874d45c35f6",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Bedarf gedeckt",
        "property": "energy_req",
        "propertyType": "flow",
        "rules": [
            {
                "t": "gte",
                "v": "(soc*100)",
                "vt": "jsonata"
            },
            {
                "t": "lt",
                "v": "(soc*100)",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2900,
        "y": 980,
        "wires": [
            [
                "5b1c728a207de517"
            ],
            [
                "177633d2fe31905d",
                "8e3e52c0a5ac852e"
            ]
        ]
    },
    {
        "id": "0f7acb3fa69ac0b2",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Modus",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "normal",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "normal",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2870,
        "y": 500,
        "wires": [
            [
                "d9c85a9c97edc68e"
            ],
            [
                "3779f1bc5961416b"
            ]
        ]
    },
    {
        "id": "d9c85a9c97edc68e",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Kosten",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "price",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3040,
        "y": 490,
        "wires": [
            [
                "9199597fa0136089"
            ]
        ]
    },
    {
        "id": "72bfcec4a2e353d4",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "manuell",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 350,
        "y": 890,
        "wires": [
            [
                "350340a6b97fe82a",
                "574ea5c6840e29b7"
            ]
        ]
    },
    {
        "id": "350340a6b97fe82a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "flow",
                "to": "0.079",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 610,
        "y": 870,
        "wires": [
            []
        ]
    },
    {
        "id": "9199597fa0136089",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Netzbezug",
        "property": "wirkleistung",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "50",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3200,
        "y": 480,
        "wires": [
            [
                "a7fa4dd4df69b135",
                "19e21abe91c07f98"
            ],
            [
                "3779f1bc5961416b"
            ]
        ]
    },
    {
        "id": "3779f1bc5961416b",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batterieleistung",
        "property": "battery",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "20",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3060,
        "y": 550,
        "wires": [
            [
                "7ba1923169710a9b"
            ],
            [
                "c8d906091ce0b5f2"
            ]
        ]
    },
    {
        "id": "c8d906091ce0b5f2",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3300,
        "y": 570,
        "wires": [
            [
                "a7fa4dd4df69b135",
                "19e21abe91c07f98"
            ]
        ]
    },
    {
        "id": "7ba1923169710a9b",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "lastGridChargeCost",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3300,
        "y": 540,
        "wires": [
            [
                "a7fa4dd4df69b135",
                "19e21abe91c07f98"
            ]
        ]
    },
    {
        "id": "a7fa4dd4df69b135",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "aktuelle Kosten",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 3720,
        "y": 590,
        "wires": []
    },
    {
        "id": "03d3fef99935568a",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "hold",
        "payloadType": "str",
        "x": 2660,
        "y": 500,
        "wires": [
            [
                "0f7acb3fa69ac0b2"
            ]
        ]
    },
    {
        "id": "2d84293fc9de2fd2",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "war msg.today",
        "info": "",
        "x": 2840,
        "y": 1210,
        "wires": []
    },
    {
        "id": "dfd214cd1fa96d58",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "hatte auch msg.now",
        "info": "",
        "x": 2950,
        "y": 1130,
        "wires": []
    },
    {
        "id": "36e0885b866de087",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "war 12kW - besser 15kW",
        "info": "bzw. vorher zu kleine 12kW",
        "x": 1590,
        "y": 1430,
        "wires": []
    },
    {
        "id": "648b6e378379e4bd",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "15ct Preisdifferenz nötig ",
        "info": "vielleicht geringer auch ok, 25?!",
        "x": 1780,
        "y": 1340,
        "wires": []
    },
    {
        "id": "e80df8ec4b67039f",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "energy_req_today? 9 kW ",
        "info": "vielleicht an den heutigen Bedarf anpassen?\n9kW sind 75% des Tagesbedarfs",
        "x": 2080,
        "y": 1340,
        "wires": []
    },
    {
        "id": "4265dde7a9ed3df8",
        "type": "inject",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1420,
        "y": 1210,
        "wires": [
            [
                "7da7e1698a4448a4"
            ]
        ]
    },
    {
        "id": "5970072adeb06ce2",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Entladungskosten",
        "info": "",
        "x": 3320,
        "y": 520,
        "wires": []
    },
    {
        "id": "88f6c56c33c4b220",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "info": "",
        "x": 3320,
        "y": 590,
        "wires": []
    },
    {
        "id": "eaa39db4355e6a1c",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Einspeisevergütung",
        "info": "",
        "x": 3320,
        "y": 450,
        "wires": []
    },
    {
        "id": "9dff097f0e31cacc",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden?",
        "property": "_feedin",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "feedin",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2030,
        "y": 1290,
        "wires": [
            [
                "d1d2a02f4ee2abaa",
                "243a05c59b711982"
            ]
        ]
    },
    {
        "id": "7628d7636aad6313",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "10ct, vielleicht besser 5ct",
        "info": "Idee: Abweichung vom Durchschnitt",
        "x": 1960,
        "y": 1410,
        "wires": []
    },
    {
        "id": "62854c7832fb2754",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "30ct Preisdifferenz nötig (vorher)",
        "info": "vielleicht geringer auch ok, 25?!",
        "x": 1750,
        "y": 1310,
        "wires": []
    },
    {
        "id": "035b47fb638c7436",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Spreizung",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "spreizung",
        "statusType": "msg",
        "x": 930,
        "y": 1360,
        "wires": []
    },
    {
        "id": "4dc689fde6785965",
        "type": "change",
        "z": "batteryoptimization",
        "name": "inaktiv",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1510,
        "y": 960,
        "wires": [
            [
                "428cdb3e9e671729"
            ]
        ]
    },
    {
        "id": "bd4d249d8f773300",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 520,
        "y": 1020,
        "wires": [
            [
                "7adedd916f43482e"
            ]
        ]
    },
    {
        "id": "7adedd916f43482e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 670,
        "y": 1020,
        "wires": [
            [
                "94e19758b5f91f2e"
            ]
        ]
    },
    {
        "id": "94e19758b5f91f2e",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre?",
        "property": "batteryLock",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 830,
        "y": 1020,
        "wires": [
            [
                "ebadfd3637ade01b"
            ]
        ]
    },
    {
        "id": "b1b157b5362b7c7e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 520,
        "y": 610,
        "wires": [
            [
                "eac12c803bf2bf08"
            ]
        ]
    },
    {
        "id": "fce283b558d7dc46",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "payload / 1.2",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 610,
        "wires": [
            [
                "243a05c59b711982"
            ]
        ]
    },
    {
        "id": "eac12c803bf2bf08",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "verschieden?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "lastGridChargeCost",
                "vt": "flow"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 660,
        "y": 610,
        "wires": [
            [
                "fce283b558d7dc46"
            ]
        ]
    },
    {
        "id": "0089f265d90a0fdb",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Anpassungen",
        "rules": [
            {
                "t": "set",
                "p": "_price",
                "pt": "msg",
                "to": "0.282",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1400,
        "y": 1150,
        "wires": [
            [
                "9e415d6399fdbe4a"
            ]
        ]
    },
    {
        "id": "1968f4fa9fc74dec",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "valide",
        "property": "n",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 700,
        "y": 1990,
        "wires": [
            [
                "31cd267b38c8f908"
            ],
            [
                "9fe2cc85e4b1058a"
            ]
        ]
    },
    {
        "id": "9fe2cc85e4b1058a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "sum",
                "pt": "msg",
                "to": "remain[0]",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 910,
        "y": 2010,
        "wires": [
            [
                "97cd34a498ab3567"
            ]
        ]
    },
    {
        "id": "c0cb8be5d7db5846",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "minTotal+",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "minTotal",
        "statusType": "msg",
        "x": 3260,
        "y": 830,
        "wires": []
    },
    {
        "id": "a9db3774f85566cd",
        "type": "change",
        "z": "batteryoptimization",
        "name": "2% Abweichung",
        "rules": [
            {
                "t": "set",
                "p": "minTotal",
                "pt": "msg",
                "to": "$round(msg.minTotal*1.02,3)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3000,
        "y": 830,
        "wires": [
            [
                "c0cb8be5d7db5846",
                "0a04be90c5d96c53"
            ]
        ]
    },
    {
        "id": "8e3e52c0a5ac852e",
        "type": "change",
        "z": "batteryoptimization",
        "name": "false",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2650,
        "y": 1370,
        "wires": [
            []
        ]
    },
    {
        "id": "36b2388e4399ef99",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Kostenoptimierung",
        "property": "avgGridPriceWeekly",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "price",
                "vt": "msg"
            },
            {
                "t": "lt",
                "v": "price",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3150,
        "y": 1380,
        "wires": [
            [
                "1ea381207963f567"
            ],
            [
                "1aa1822a4b5c3968"
            ]
        ]
    },
    {
        "id": "1ea381207963f567",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriestand",
        "property": "soc",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "80",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3340,
        "y": 1340,
        "wires": [
            [
                "177633d2fe31905d"
            ],
            [
                "1aa1822a4b5c3968"
            ]
        ]
    },
    {
        "id": "49c58e29915bdcb0",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Netzladungskompatibel!",
        "info": "",
        "x": 3420,
        "y": 1310,
        "wires": []
    },
    {
        "id": "779dd3da5b48c4a1",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "war verbunden, Quatsch?!",
        "info": "verbunden mit Laderegelung aktiv = false ",
        "x": 1650,
        "y": 130,
        "wires": []
    },
    {
        "id": "b0c3f158236c14aa",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "avgGridPriceWeekly",
        "topic": "alias.0.energy.grid.price_avg_weekly",
        "attrname": "avgGridPriceWeekly",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 2850,
        "y": 1340,
        "wires": [
            [
                "b7394d3109e365d0"
            ]
        ]
    },
    {
        "id": "8998ee37728519f1",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avgGridPriceWeekly",
        "action": "",
        "pretty": false,
        "x": 3170,
        "y": 1340,
        "wires": [
            [
                "36b2388e4399ef99"
            ]
        ]
    },
    {
        "id": "fe93b924a6278cdd",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Netzladungsmenge",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 4420,
        "y": 1540,
        "wires": []
    },
    {
        "id": "975e675b4a84f887",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Netzladungskosten",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 4420,
        "y": 1480,
        "wires": []
    },
    {
        "id": "34b02e3fa6bade9c",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 550,
        "y": 170,
        "wires": [
            [
                "82b21566b0d88c2f"
            ]
        ]
    },
    {
        "id": "82b21566b0d88c2f",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 700,
        "y": 170,
        "wires": [
            [
                "7aa446452505ee40"
            ]
        ]
    },
    {
        "id": "7aa446452505ee40",
        "type": "change",
        "z": "batteryoptimization",
        "name": "zurücksetzen",
        "rules": [
            {
                "t": "set",
                "p": "batteryLock",
                "pt": "flow",
                "to": "batteryLock",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 170,
        "wires": [
            [
                "aa16438e0ea3ebe4"
            ]
        ]
    },
    {
        "id": "07534b644995fa06",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Bedingung: PVForecast-Adapter",
        "info": "aus Tibber und InfluxDB den wöchentlichen Preisdurchschnitt ermitteln\nVoraussetzung:\n- in InfluxDB gespeicherte Tibber-Stundenpreisinformationen\n- Laufzeit: 1 Woche\n- alternativ: auf festen Wert, z.B. 0.24ct setzen!",
        "x": 350,
        "y": 1710,
        "wires": []
    },
    {
        "id": "51785af5601ace2c",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "main configuration here",
        "info": "",
        "x": 1300,
        "y": 80,
        "wires": []
    },
    {
        "id": "bddeeff8c4edcf84",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Glättung der Kosten",
        "info": "",
        "x": 2840,
        "y": 1310,
        "wires": []
    },
    {
        "id": "dd91b617cc6f03ed",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Batteriesperre?",
        "property": "batteryLock",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 890,
        "y": 390,
        "wires": [
            [
                "cf03f76c34779c74"
            ]
        ]
    },
    {
        "id": "8e9d5c079b9a05c1",
        "type": "change",
        "z": "batteryoptimization",
        "name": "sammeln für Ausgabe",
        "rules": [
            {
                "t": "set",
                "p": "batteryModeTS",
                "pt": "msg",
                "to": "batteryModeTS",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2760,
        "y": 200,
        "wires": [
            [
                "ea842730b26a89d1"
            ]
        ]
    },
    {
        "id": "0b77698de4b4e9f9",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Output",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2910,
        "y": 440,
        "wires": [
            [
                "b0bb7f1a559cfbb0"
            ]
        ]
    },
    {
        "id": "42423960e51efbb0",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "Batteriesperre (UI)",
        "attrname": "batteryLock",
        "topic": "alias.0.energy.control.batterylock",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 230,
        "y": 960,
        "wires": [
            [
                "7a8d8d424d68a573"
            ]
        ]
    },
    {
        "id": "bf57440025bd5b40",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "attrname": "payload",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 250,
        "y": 750,
        "wires": [
            [
                "243a05c59b711982"
            ]
        ]
    },
    {
        "id": "7861d060c24f1b49",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "Netzpreisgrenze",
        "attrname": "preisgrenze",
        "topic": "alias.0.energy.control.gridChargeCostLimit",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 220,
        "y": 690,
        "wires": [
            [
                "243a05c59b711982"
            ]
        ]
    },
    {
        "id": "14a6e6bc26cc9700",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "lastGridChargePrice",
        "attrname": "payload",
        "topic": "alias.0.energy.control.lastGridChargePrice",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 330,
        "y": 610,
        "wires": [
            [
                "b1b157b5362b7c7e"
            ]
        ]
    },
    {
        "id": "fc2ce79116b4ae8e",
        "type": "ioBroker in",
        "z": "batteryoptimization",
        "name": "SoC-Batterie ",
        "attrname": "payload",
        "topic": "alias.0.energy.battery.soc",
        "payloadType": "value",
        "onlyack": "",
        "func": "rbe-preinitvalue",
        "gap": "",
        "fireOnStart": "false",
        "outFormat": "MQTT",
        "x": 210,
        "y": 1100,
        "wires": [
            [
                "ebadfd3637ade01b"
            ]
        ]
    },
    {
        "id": "0455814873ee5258",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Output",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2770,
        "y": 1460,
        "wires": [
            [
                "84679f9bafe83770"
            ]
        ]
    },
    {
        "id": "19e21abe91c07f98",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "feedIn_effective",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3610,
        "y": 450,
        "wires": [
            []
        ]
    },
    {
        "id": "fc114434d5bb43e8",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "gridChargeCostLimit_effective",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 3610,
        "y": 350,
        "wires": [
            []
        ]
    },
    {
        "id": "b0bb7f1a559cfbb0",
        "type": "change",
        "z": "batteryoptimization",
        "name": "speichern",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode_effective",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "batteryModeTS",
                "pt": "msg",
                "to": "batteryModeTS",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2330,
        "y": 780,
        "wires": [
            [
                "2985cd04e180167d"
            ]
        ]
    },
    {
        "id": "428cdb3e9e671729",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Output",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2640,
        "y": 1710,
        "wires": [
            [
                "df364b9b8f9d4b45"
            ]
        ]
    },
    {
        "id": "b7394d3109e365d0",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "gültig",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3020,
        "y": 1340,
        "wires": [
            [
                "177633d2fe31905d"
            ],
            [
                "8998ee37728519f1"
            ]
        ]
    },
    {
        "id": "2985cd04e180167d",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Batteriemodus",
        "topic": "alias.0.energy.battery.targetMode",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 2740,
        "y": 780,
        "wires": []
    },
    {
        "id": "7d9342e96f8c7c2c",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "effectiveGridChargeCostLimit",
        "topic": "alias.0.energy.control.effectiveGridChargeCostLimit",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 3340,
        "y": 720,
        "wires": []
    },
    {
        "id": "84679f9bafe83770",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Netzladung",
        "topic": "alias.0.energy.control.enableGridcharging",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 3140,
        "y": 1460,
        "wires": []
    },
    {
        "id": "df364b9b8f9d4b45",
        "type": "ioBroker out",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "ack": "false",
        "autoCreate": "false",
        "stateName": "",
        "role": "",
        "payloadType": "",
        "readonly": "",
        "stateUnit": "",
        "stateMin": "",
        "stateMax": "",
        "x": 3110,
        "y": 1710,
        "wires": []
    },
    {
        "id": "4d41256f3a5efad9",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Konfiguration",
        "rules": [
            {
                "t": "set",
                "p": "batteryMinSoC",
                "pt": "flow",
                "to": "5",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "maximumGridPrice",
                "pt": "flow",
                "to": "0.32",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "feedin",
                "pt": "flow",
                "to": "0.079",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "pvMinimumRequired",
                "pt": "flow",
                "to": "17500",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "minPriceDifference",
                "pt": "flow",
                "to": "0.15",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "minPriceDeviation",
                "pt": "flow",
                "to": "0.10",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "enableGridChargeThreshold",
                "pt": "flow",
                "to": "50",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "disableGridChargeThreshold",
                "pt": "flow",
                "to": "80",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "holdOnSmartCostLimit",
                "pt": "flow",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1330,
        "y": 110,
        "wires": [
            [
                "7a1aa1f7498e0b6a"
            ]
        ]
    },
    {
        "id": "0f5b02cbdee0053f",
        "type": "change",
        "z": "batteryoptimization",
        "name": "initialisieren",
        "rules": [
            {
                "t": "set",
                "p": "batteryMode",
                "pt": "flow",
                "to": "batteryMode",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "batteryMinSoC",
                "pt": "flow",
                "to": "5",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastCosts",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastGridChargeCost",
                "pt": "flow",
                "to": "lastGridChargeCost",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "maximumGridPrice",
                "pt": "flow",
                "to": "0.32",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "feedin",
                "pt": "flow",
                "to": "0.079",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "lastmessage",
                "pt": "flow",
                "to": "none",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "avgGridPriceWeekly",
                "pt": "flow",
                "to": "0.240",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "avgGridPriceWeekly",
                "pt": "flow",
                "to": "avgGridPriceWeekly",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "pvMinimumRequired",
                "pt": "flow",
                "to": "17500",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "minPriceDifference",
                "pt": "flow",
                "to": "0.15",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "e29a2ffb2cfc7b30",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Thresholds for battery charging redefined here",
        "info": "",
        "x": 2110,
        "y": 20,
        "wires": []
    },
    {
        "id": "7a1aa1f7498e0b6a",
        "type": "special-date",
        "z": "batteryoptimization",
        "dates": [
            {
                "type": "range",
                "startDate": 15,
                "startDay": 0,
                "startMonth": 10,
                "startMonthOrdinal": 0,
                "startOrdinal": 0,
                "endDate": 15,
                "endMonth": 1,
                "offsetOrdinalBefore": 0,
                "offsetOrdinalAfter": 0,
                "response": "true"
            }
        ],
        "defaultResponse": "false",
        "messageProperty": "within",
        "name": "kalte Monate (Nov-Feb)",
        "x": 1540,
        "y": 50,
        "wires": [
            [
                "f2028a3f09d61f89"
            ]
        ]
    },
    {
        "id": "f2028a3f09d61f89",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "within",
        "action": "obj",
        "pretty": false,
        "x": 1720,
        "y": 50,
        "wires": [
            [
                "2f0e10c4f226ceb1"
            ]
        ]
    },
    {
        "id": "2f0e10c4f226ceb1",
        "type": "switch",
        "z": "batteryoptimization",
        "name": "Winter?",
        "property": "within",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1860,
        "y": 50,
        "wires": [
            [
                "5042285833e93d77"
            ]
        ]
    },
    {
        "id": "5042285833e93d77",
        "type": "change",
        "z": "batteryoptimization",
        "name": "minSoC (im Winter)",
        "rules": [
            {
                "t": "set",
                "p": "batteryMinSoC",
                "pt": "flow",
                "to": "15",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2040,
        "y": 50,
        "wires": [
            []
        ]
    },
    {
        "id": "8d47581cbec5da41",
        "type": "comment",
        "z": "batteryoptimization",
        "name": "Definition \"Standardlastverteilung\" (24h)",
        "info": "24 Werte für den durchschnittlichen Stundenverbrauch des Haushaltes",
        "x": 370,
        "y": 1940,
        "wires": []
    },
    {
        "id": "ea842730b26a89d1",
        "type": "debug",
        "z": "batteryoptimization",
        "name": "Ausgabe minSoC",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "msg",
        "x": 3050,
        "y": 120,
        "wires": []
    },
    {
        "id": "b61bbe7e0e8985b3",
        "type": "within-time-switch",
        "z": "batteryoptimization",
        "name": "",
        "nameInt": "",
        "positionConfig": "ae76f576df22109b",
        "startTime": "13:00",
        "startTimeType": "entered",
        "startOffset": 0,
        "startOffsetType": "none",
        "startOffsetMultiplier": 60000,
        "endTime": "23:59",
        "endTimeType": "entered",
        "endOffset": 0,
        "endOffsetType": "none",
        "endOffsetMultiplier": 60000,
        "timeRestrictions": 0,
        "timeRestrictionsType": "none",
        "timeDays": "*",
        "timeOnlyOddDays": false,
        "timeOnlyEvenDays": false,
        "timeOnlyOddWeeks": false,
        "timeOnlyEvenWeeks": false,
        "timeMonths": "*",
        "timedatestart": "",
        "timedateend": "",
        "propertyStart": "",
        "propertyStartType": "none",
        "propertyStartCompare": "true",
        "propertyStartThreshold": "",
        "propertyStartThresholdType": "num",
        "startTimeAlt": "",
        "startTimeAltType": "entered",
        "startOffsetAlt": 0,
        "startOffsetAltType": "none",
        "startOffsetAltMultiplier": 60000,
        "propertyEnd": "",
        "propertyEndType": "none",
        "propertyEndCompare": "true",
        "propertyEndThreshold": "",
        "propertyEndThresholdType": "num",
        "endTimeAlt": "",
        "endTimeAltType": "entered",
        "endOffsetAlt": 0,
        "endOffsetAltType": "none",
        "endOffsetAltMultiplier": 60000,
        "withinTimeValue": "true",
        "withinTimeValueType": "bool",
        "outOfTimeValue": "false",
        "outOfTimeValueType": "bool",
        "tsCompare": "0",
        "x": 1740,
        "y": 850,
        "wires": [
            [
                "cf1a50b211515aaa"
            ],
            []
        ]
    },
    {
        "id": "cf1a50b211515aaa",
        "type": "trigger",
        "z": "batteryoptimization",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "1",
        "extend": false,
        "overrideDelay": false,
        "units": "hr",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 660,
        "y": 800,
        "wires": [
            [
                "243a05c59b711982"
            ]
        ]
    },
    {
        "id": "3e5ce45ad66c449a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "reset",
        "rules": [
            {
                "t": "set",
                "p": "reset",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1990,
        "y": 850,
        "wires": [
            [
                "cf1a50b211515aaa"
            ]
        ]
    },
    {
        "id": "243a05c59b711982",
        "type": "change",
        "z": "batteryoptimization",
        "name": "sammeln",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 720,
        "wires": [
            [
                "f8db76dd2d27a9e4"
            ]
        ]
    },
    {
        "id": "9adfc044e4fb323a",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "maximaler Strompreis",
        "topic": "alias.0.energy.grid.price_max",
        "attrname": "max",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1430,
        "wires": [
            [
                "95fa90da446f8737"
            ]
        ]
    },
    {
        "id": "5a31f5c6c25e7545",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minimaler Strompreis",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "min",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1440,
        "wires": [
            [
                "86788ad6b2524cc2"
            ]
        ]
    },
    {
        "id": "95fa90da446f8737",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "max",
        "action": "",
        "pretty": false,
        "x": 560,
        "y": 1430,
        "wires": [
            [
                "5a31f5c6c25e7545"
            ]
        ]
    },
    {
        "id": "86788ad6b2524cc2",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "min",
        "action": "",
        "pretty": false,
        "x": 560,
        "y": 1440,
        "wires": [
            [
                "d6f39f647a02daad"
            ]
        ]
    },
    {
        "id": "d6f39f647a02daad",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "durchschnittlicher Strompreis",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 400,
        "y": 1430,
        "wires": [
            [
                "7a87d09eca29766d"
            ]
        ]
    },
    {
        "id": "7a87d09eca29766d",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 590,
        "y": 1430,
        "wires": [
            [
                "9abce044875c4e9d"
            ]
        ]
    },
    {
        "id": "eb2c872dbaf7c730",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (morgen)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "tomorrow",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1440,
        "wires": [
            [
                "40db5cbdf551d1f2"
            ]
        ]
    },
    {
        "id": "40db5cbdf551d1f2",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "action": "",
        "pretty": false,
        "x": 560,
        "y": 1440,
        "wires": [
            [
                "2584e9e977f27dcc"
            ]
        ]
    },
    {
        "id": "453df5840e37e176",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "regelung",
        "action": "",
        "pretty": false,
        "x": 510,
        "y": 1440,
        "wires": [
            [
                "bc58512544ebdc8a"
            ]
        ]
    },
    {
        "id": "20f81a2ed968f077",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "attrname": "regelung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 360,
        "y": 1440,
        "wires": [
            [
                "453df5840e37e176"
            ]
        ]
    },
    {
        "id": "54a9c23369b56a09",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus (EVCC)",
        "topic": "mqtt.0.evcc.site.batteryMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 580,
        "y": 1410,
        "wires": [
            [
                "f59b13d46245cc77"
            ]
        ]
    },
    {
        "id": "c2f45740e0e68b27",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "PV Leistung",
        "topic": "alias.0.energy.pv.production",
        "attrname": "pv",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 340,
        "y": 1440,
        "wires": [
            [
                "203b6aef6e195edc"
            ]
        ]
    },
    {
        "id": "203b6aef6e195edc",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "pv",
        "action": "",
        "pretty": false,
        "x": 480,
        "y": 1440,
        "wires": [
            [
                "54a9c23369b56a09"
            ]
        ]
    },
    {
        "id": "4f9e5697a0ebdaa1",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "batterySoC",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 340,
        "y": 1430,
        "wires": [
            [
                "d03935928a5dc16e"
            ]
        ]
    },
    {
        "id": "d03935928a5dc16e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batterySoC",
        "action": "",
        "pretty": false,
        "x": 510,
        "y": 1430,
        "wires": [
            [
                "c2f45740e0e68b27"
            ]
        ]
    },
    {
        "id": "4efbf48682d1f72a",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "wirkleistung",
        "action": "",
        "pretty": false,
        "x": 490,
        "y": 1430,
        "wires": [
            [
                "4f9e5697a0ebdaa1"
            ]
        ]
    },
    {
        "id": "bc58512544ebdc8a",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Wirkleistung",
        "topic": "alias.0.energy.grid.consumption",
        "attrname": "wirkleistung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 350,
        "y": 1430,
        "wires": [
            [
                "4efbf48682d1f72a"
            ]
        ]
    },
    {
        "id": "019bf7d28f2567ea",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "attrname": "batteryDischargeControl",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 390,
        "y": 1440,
        "wires": [
            [
                "86071f822be6bcd3"
            ]
        ]
    },
    {
        "id": "86071f822be6bcd3",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryDischargeControl",
        "action": "",
        "pretty": false,
        "x": 580,
        "y": 1440,
        "wires": [
            [
                "20f81a2ed968f077"
            ]
        ]
    },
    {
        "id": "2584e9e977f27dcc",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (heute)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 370,
        "y": 1430,
        "wires": [
            [
                "66e70440459dd1d5"
            ]
        ]
    },
    {
        "id": "66e70440459dd1d5",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 540,
        "y": 1430,
        "wires": [
            [
                "019bf7d28f2567ea"
            ]
        ]
    },
    {
        "id": "71427cf20ad31b29",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 380,
        "y": 1420,
        "wires": [
            [
                "41492d2153baae98"
            ]
        ]
    },
    {
        "id": "41492d2153baae98",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 550,
        "y": 1420,
        "wires": [
            [
                "9adfc044e4fb323a"
            ]
        ]
    },
    {
        "id": "d0c989feecd0d50b",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 360,
        "y": 1410,
        "wires": [
            [
                "183f4a783090d45d"
            ]
        ]
    },
    {
        "id": "183f4a783090d45d",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 520,
        "y": 1410,
        "wires": [
            [
                "71427cf20ad31b29"
            ]
        ]
    },
    {
        "id": "9abce044875c4e9d",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeiseverfügung",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 540,
        "y": 1430,
        "wires": [
            [
                "eb2c872dbaf7c730"
            ]
        ]
    },
    {
        "id": "ac80793a35bbd60e",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "maximaler Strompreis",
        "topic": "alias.0.energy.grid.price_max",
        "attrname": "max",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 410,
        "wires": [
            [
                "b966dd8ed6357acc"
            ]
        ]
    },
    {
        "id": "c14089e1332a1b2e",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minimaler Strompreis",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "min",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 420,
        "wires": [
            [
                "65ba6e0e559e4332"
            ]
        ]
    },
    {
        "id": "b966dd8ed6357acc",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "max",
        "action": "",
        "pretty": false,
        "x": 660,
        "y": 410,
        "wires": [
            [
                "c14089e1332a1b2e"
            ]
        ]
    },
    {
        "id": "65ba6e0e559e4332",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "min",
        "action": "",
        "pretty": false,
        "x": 660,
        "y": 420,
        "wires": [
            [
                "75d10ab44072c871"
            ]
        ]
    },
    {
        "id": "75d10ab44072c871",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "durchschnittlicher Strompreis",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 500,
        "y": 410,
        "wires": [
            [
                "702e1e5de4e49484"
            ]
        ]
    },
    {
        "id": "702e1e5de4e49484",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 690,
        "y": 410,
        "wires": [
            [
                "529f3aa097441e7a"
            ]
        ]
    },
    {
        "id": "40694a5a6f4c91b7",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (morgen)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "tomorrow",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 420,
        "wires": [
            [
                "e083487a185e1b98"
            ]
        ]
    },
    {
        "id": "e083487a185e1b98",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "action": "",
        "pretty": false,
        "x": 660,
        "y": 420,
        "wires": [
            [
                "d7e1ab105efa5023"
            ]
        ]
    },
    {
        "id": "4c4ef313fe0c7844",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "regelung",
        "action": "",
        "pretty": false,
        "x": 610,
        "y": 420,
        "wires": [
            [
                "2cba75d343c2bf53"
            ]
        ]
    },
    {
        "id": "16d32d160f074408",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "attrname": "regelung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 460,
        "y": 420,
        "wires": [
            [
                "4c4ef313fe0c7844"
            ]
        ]
    },
    {
        "id": "46d43f3ccfe364e6",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus (EVCC)",
        "topic": "mqtt.0.evcc.site.batteryMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 680,
        "y": 390,
        "wires": [
            [
                "dd91b617cc6f03ed"
            ]
        ]
    },
    {
        "id": "8432972421f3eb2d",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "PV Leistung",
        "topic": "alias.0.energy.pv.production",
        "attrname": "pv",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 440,
        "y": 420,
        "wires": [
            [
                "fd0367711718f2fc"
            ]
        ]
    },
    {
        "id": "fd0367711718f2fc",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "pv",
        "action": "",
        "pretty": false,
        "x": 580,
        "y": 420,
        "wires": [
            [
                "46d43f3ccfe364e6"
            ]
        ]
    },
    {
        "id": "6bb29b2220895fbb",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "batterySoC",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 440,
        "y": 410,
        "wires": [
            [
                "8a3e094363af6391"
            ]
        ]
    },
    {
        "id": "8a3e094363af6391",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batterySoC",
        "action": "",
        "pretty": false,
        "x": 610,
        "y": 410,
        "wires": [
            [
                "8432972421f3eb2d"
            ]
        ]
    },
    {
        "id": "9ca5869cb9663970",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "wirkleistung",
        "action": "",
        "pretty": false,
        "x": 590,
        "y": 410,
        "wires": [
            [
                "6bb29b2220895fbb"
            ]
        ]
    },
    {
        "id": "2cba75d343c2bf53",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Wirkleistung",
        "topic": "alias.0.energy.grid.consumption",
        "attrname": "wirkleistung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 450,
        "y": 410,
        "wires": [
            [
                "9ca5869cb9663970"
            ]
        ]
    },
    {
        "id": "2936a70b077b1757",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "attrname": "batteryDischargeControl",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 490,
        "y": 420,
        "wires": [
            [
                "c5525aee7bc698e4"
            ]
        ]
    },
    {
        "id": "c5525aee7bc698e4",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryDischargeControl",
        "action": "",
        "pretty": false,
        "x": 680,
        "y": 420,
        "wires": [
            [
                "16d32d160f074408"
            ]
        ]
    },
    {
        "id": "d7e1ab105efa5023",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (heute)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 470,
        "y": 410,
        "wires": [
            [
                "914a4c915331091b"
            ]
        ]
    },
    {
        "id": "914a4c915331091b",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 640,
        "y": 410,
        "wires": [
            [
                "2936a70b077b1757"
            ]
        ]
    },
    {
        "id": "bf5281b85e212e51",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 480,
        "y": 400,
        "wires": [
            [
                "abf0ec5e8e839334"
            ]
        ]
    },
    {
        "id": "abf0ec5e8e839334",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 650,
        "y": 400,
        "wires": [
            [
                "ac80793a35bbd60e"
            ]
        ]
    },
    {
        "id": "f29586a895c37aef",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 460,
        "y": 390,
        "wires": [
            [
                "d18a71077d358606"
            ]
        ]
    },
    {
        "id": "d18a71077d358606",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 620,
        "y": 390,
        "wires": [
            [
                "bf5281b85e212e51"
            ]
        ]
    },
    {
        "id": "529f3aa097441e7a",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeiseverfügung",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 640,
        "y": 410,
        "wires": [
            [
                "40694a5a6f4c91b7"
            ]
        ]
    },
    {
        "id": "7c871c458c4ffb6d",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "maximaler Strompreis",
        "topic": "alias.0.energy.grid.price_max",
        "attrname": "max",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 740,
        "wires": [
            [
                "b21026403ff13ab2"
            ]
        ]
    },
    {
        "id": "b32f8222a80acccf",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "minimaler Strompreis",
        "topic": "alias.0.energy.grid.price_min",
        "attrname": "min",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 750,
        "wires": [
            [
                "9a8a2a4370d42a6c"
            ]
        ]
    },
    {
        "id": "b21026403ff13ab2",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "max",
        "action": "",
        "pretty": false,
        "x": 1260,
        "y": 740,
        "wires": [
            [
                "b32f8222a80acccf"
            ]
        ]
    },
    {
        "id": "9a8a2a4370d42a6c",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "min",
        "action": "",
        "pretty": false,
        "x": 1260,
        "y": 750,
        "wires": [
            [
                "0db136153f398521"
            ]
        ]
    },
    {
        "id": "0db136153f398521",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "durchschnittlicher Strompreis",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "avg",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1100,
        "y": 740,
        "wires": [
            [
                "2349f961e11eb84e"
            ]
        ]
    },
    {
        "id": "2349f961e11eb84e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "avg",
        "action": "",
        "pretty": false,
        "x": 1290,
        "y": 740,
        "wires": [
            [
                "5fd04722d7a1b629"
            ]
        ]
    },
    {
        "id": "daeaade8e714886e",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (morgen)",
        "topic": "alias.0.energy.grid.price_tomorrow",
        "attrname": "tomorrow",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 750,
        "wires": [
            [
                "0c0b5c6232e6371a"
            ]
        ]
    },
    {
        "id": "0c0b5c6232e6371a",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "tomorrow",
        "action": "",
        "pretty": false,
        "x": 1260,
        "y": 750,
        "wires": [
            [
                "ba9a4335f3c881bd"
            ]
        ]
    },
    {
        "id": "58a68c19aa1ada9c",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "regelung",
        "action": "",
        "pretty": false,
        "x": 1210,
        "y": 750,
        "wires": [
            [
                "23e3ddca741e9e2f"
            ]
        ]
    },
    {
        "id": "b20c44983cf4f376",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Laderegelung",
        "topic": "alias.0.energy.control.enableOptimization",
        "attrname": "regelung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1060,
        "y": 750,
        "wires": [
            [
                "58a68c19aa1ada9c"
            ]
        ]
    },
    {
        "id": "0e799837e7c7555a",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriemodus (EVCC)",
        "topic": "mqtt.0.evcc.site.batteryMode",
        "attrname": "batteryMode",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1280,
        "y": 720,
        "wires": [
            [
                "95de73a1f0b71cd6"
            ]
        ]
    },
    {
        "id": "9bc61ae7e4ab843d",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "PV Leistung",
        "topic": "alias.0.energy.pv.production",
        "attrname": "pv",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1040,
        "y": 750,
        "wires": [
            [
                "63db0048517a279a"
            ]
        ]
    },
    {
        "id": "63db0048517a279a",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "pv",
        "action": "",
        "pretty": false,
        "x": 1180,
        "y": 750,
        "wires": [
            [
                "0e799837e7c7555a"
            ]
        ]
    },
    {
        "id": "747ec27b4f7fc171",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batterySOC",
        "topic": "alias.0.energy.battery.soc",
        "attrname": "batterySoC",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1040,
        "y": 740,
        "wires": [
            [
                "5250a5ab3f302e87"
            ]
        ]
    },
    {
        "id": "5250a5ab3f302e87",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batterySoC",
        "action": "",
        "pretty": false,
        "x": 1210,
        "y": 740,
        "wires": [
            [
                "9bc61ae7e4ab843d"
            ]
        ]
    },
    {
        "id": "9ef09962022eca11",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "wirkleistung",
        "action": "",
        "pretty": false,
        "x": 1190,
        "y": 740,
        "wires": [
            [
                "747ec27b4f7fc171"
            ]
        ]
    },
    {
        "id": "23e3ddca741e9e2f",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Wirkleistung",
        "topic": "alias.0.energy.grid.consumption",
        "attrname": "wirkleistung",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1050,
        "y": 740,
        "wires": [
            [
                "9ef09962022eca11"
            ]
        ]
    },
    {
        "id": "fc5d1a06a49655c1",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "batteryDischargeControl",
        "topic": "alias.0.energy.evcc.batteryDischargeControl",
        "attrname": "batteryDischargeControl",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1090,
        "y": 750,
        "wires": [
            [
                "a2da6507f64f8683"
            ]
        ]
    },
    {
        "id": "a2da6507f64f8683",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryDischargeControl",
        "action": "",
        "pretty": false,
        "x": 1280,
        "y": 750,
        "wires": [
            [
                "b20c44983cf4f376"
            ]
        ]
    },
    {
        "id": "ba9a4335f3c881bd",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Strompreis (heute)",
        "topic": "alias.0.energy.grid.price_today",
        "attrname": "today",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1070,
        "y": 740,
        "wires": [
            [
                "280a72626d2a4cef"
            ]
        ]
    },
    {
        "id": "280a72626d2a4cef",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "today",
        "action": "",
        "pretty": false,
        "x": 1240,
        "y": 740,
        "wires": [
            [
                "fc5d1a06a49655c1"
            ]
        ]
    },
    {
        "id": "5c49d0795c98eb80",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "aktueller Strompreis",
        "topic": "alias.0.energy.grid.price",
        "attrname": "price",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1080,
        "y": 730,
        "wires": [
            [
                "b96f08900187371e"
            ]
        ]
    },
    {
        "id": "b96f08900187371e",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "price",
        "action": "",
        "pretty": false,
        "x": 1250,
        "y": 730,
        "wires": [
            [
                "7c871c458c4ffb6d"
            ]
        ]
    },
    {
        "id": "f8db76dd2d27a9e4",
        "type": "ioBroker get",
        "z": "batteryoptimization",
        "name": "Batteriesperre",
        "topic": "alias.0.energy.control.batterylock",
        "attrname": "batteryLock",
        "payloadType": "value",
        "errOnInvalidState": "nothing",
        "x": 1060,
        "y": 720,
        "wires": [
            [
                "144da65da9f5d16c"
            ]
        ]
    },
    {
        "id": "144da65da9f5d16c",
        "type": "json",
        "z": "batteryoptimization",
        "name": "",
        "property": "batteryLock",
        "action": "",
        "pretty": false,
        "x": 1220,
        "y": 720,
        "wires": [
            [
                "5c49d0795c98eb80"
            ]
        ]
    },
    {
        "id": "5fd04722d7a1b629",
        "type": "change",
        "z": "batteryoptimization",
        "name": "Einspeiseverfügung",
        "rules": [
            {
                "t": "set",
                "p": "feedin",
                "pt": "msg",
                "to": "feedin",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 740,
        "wires": [
            [
                "daeaade8e714886e"
            ]
        ]
    },
    {
        "id": "ae76f576df22109b",
        "type": "position-config",
        "z": "batteryoptimization",
        "name": "Deutschland",
        "isValide": "true",
        "longitude": "0",
        "latitude": "0",
        "angleType": "deg",
        "timeZoneOffset": "99",
        "timeZoneDST": "0",
        "stateTimeFormat": "3",
        "stateDateFormat": "12",
        "contextStore": ""
    },
    {
        "id": "3738b7b131a30cfc",
        "type": "subflow:batteryoptimization",
        "z": "e70132af77ddf732",
        "name": "",
        "x": 180,
        "y": 280,
        "wires": [
            [
                "af19bdb9872c8dad"
            ],
            [
                "2d7e4d79fb5c7b9f"
            ],
            [
                "f24ff2617e297b73",
                "d4d21b1ad56e9d51"
            ],
            [
                "549ab0dae6a2ab6d",
                "ca6ba3b2b3eb8e1f"
            ],
            [
                "49cffb1e14bf4bf9"
            ],
            [
                "02bcede93bbd8752"
            ],
            [
                "4c8d62f10acc8513"
            ],
            [
                "8847d573b378caa8"
            ],
            [
                "4281e2445da62a6b"
            ],
            [
                "ae8dbad4eac6d51f"
            ],
            [
                "5dd07c985806db79"
            ],
            [
                "f54bca02d1684f0b"
            ],
            [
                "950e146ba22a7a43"
            ],
            [
                "8108e5147734a9a7"
            ],
            [
                "25efc4c9fea73367"
            ]
        ]
    }
]
